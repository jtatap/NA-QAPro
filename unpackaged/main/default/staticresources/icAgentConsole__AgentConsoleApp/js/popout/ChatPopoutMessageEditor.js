$.widget("AgentConsole.chatPopoutMessageEditor",{options:{resourceBase:"",controller:null,container:null},chatTinyMceEditor:null,_chatEditorForecolorElement:null,isEditorProcessing:!1,_init:function(){},_create:function(){this.resourceBase=this.options.resourceBase,this.root=this.createRootPanels(),this.root.appendTo(this.element),this.chatPlaceholderMsg=IC_Localization.enterMessage+"...",this.postCreate(),this.root.appendTo(this.element)},postCreate:function(){var that=this;this.dialogPanel=$('<div class="DialogPanel" title="'+IC_Localization.insertHyperLink+'" />').appendTo(this.root);var textToDisplay=$('<div class="DialogPanelURLLab" />');textToDisplay.text(IC_Localization.textToDisplay+": ").appendTo(this.dialogPanel),IC_Common.setTextWithEllipsis(textToDisplay,IC_Localization.textToDisplay+": ",70),this.dialogPanelURLTxt=$('<input type="text" class="DialogPanelURLLab DialogPanelURLTxt" title="'+IC_Localization.textToDisplay+'"/>').appendTo(this.dialogPanel);var hyperlinkAddress=$('<div class="DialogPanelURLLab" style="width: 70px;"/>');hyperlinkAddress.text(IC_Localization.address+": ").appendTo(this.dialogPanel),IC_Common.setTextWithEllipsis(hyperlinkAddress,IC_Localization.address+": ",70),this.dialogPanelURL=$('<input type="text" class="DialogPanelURLLab DialogPanelURLTxt" title="'+IC_Localization.address+'"/>').val("http://").appendTo(this.dialogPanel);var labelOptions={};labelOptions.ok=IC_Localization.ok,labelOptions.cancel=IC_Localization.cancel;var buttonOptions={};buttonOptions[labelOptions.ok]=function(){if(!IC_Validation.isNotNullOrUndefinedString(that.dialogPanelURLTxt.val()))return that.dialogPanelURLTxt.css({border:" 1px solid #FF0000"}),!0;if(that.dialogPanelURLTxt.css({border:" 1px solid #AAAAAA"}),!IC_Validation.isNotNullOrUndefinedString(that.dialogPanelURL.val()))return that.dialogPanelURL.css({border:" 1px solid #FF0000"}),!0;that.dialogPanelURL.css({border:" 1px solid #AAAAAA"});if(!/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(that.dialogPanelURL.val()))return that.dialogPanelURL.css({border:" 1px solid #FF0000"}),!0;var linkText=that.dialogPanelURLTxt.val(),linkURL=that.dialogPanelURL.val();$(this).dialog("close"),that.addHyperlink(linkText,linkURL)},buttonOptions[labelOptions.cancel]=function(){$(this).dialog("close")},this.dialogPanel.dialog({autoOpen:!1,resizable:!1,height:160,width:"330px",modal:!0,buttons:buttonOptions,close:function(){that.clearURLTxt()}}),$(".ui-widget-header").addClass("DialogPanelBG"),$(".ui-dialog-title").addClass("DialogPanelTitle"),$(".ui-dialog-buttonpane button").addClass("DialogPanelBut"),$(".ui-widget-content").addClass("DialogPanelFontStyle"),$(".ui-dialog-titlebar-close").attr("title",IC_Localization.close),this.createChatEditor()},createRootPanels:function(){$=jQuery;var that=this;this.root=$('<div class="chatMessageEditor" />'),this.chatMessageEditorOverlay=$('<div class="chatMessageEditorOverlay"/>').appendTo(this.root),this.typingPnl=$('<div id = "typingPnlId" class="TypingPnl btnDivEnable" />'),this.textPnl=$('<div id = "textPnlId" class="TextPnl" />'),this.notesTxt=$('<textarea id = "'+IC_Common.generateUniqueId("chatNotesTxtId")+'" class="NotesTxt btnDivEnable" title="'+IC_Localization.enterMessage+'"/>'),this.textPnl.append(this.notesTxt),this.enterPnl=$('<div id = "enterPnlId"  class="EnterPnl" title="'+IC_Localization.send+'"/>'),this.enterImg=$("<img />").addClass("ImgEnter"),this.enterPnl.hoverfn(IC_Common.mouseEnterButton,IC_Common.mouseLeaveButton),this.enterPnl.append(this.enterImg),this.enterPnl.on("click",function(e){return that.enterPnl.hasClass("btnDivEnable")&&(that.setChatEditorSetting(),that.options.controller.enterOptionClick(),that.setEnterEnable(),that.resetToDefaultValues()),!1}),this.enterPnl.on("dblclick",function(e){var ed=that.chatTinyMceEditor;if(void 0!=ed&&null!=ed){var content=$.trim(ed.getContent({format:"text"}));if(0==content.length||that.chatPlaceholderMsg==content)return e.preventDefault(),!1}}),this.changeButtonState(this.enterPnl,this.enterImg,"disabled",this.resourceBase+"/css/images/enter.png",this.resourceBase+"/css/images/enter-disable.png"),this.typingPnl.append(this.textPnl).append(this.enterPnl);that=this;return this.toolTipPnl=$('<div id="tooltipID" class="tooltipStyle"/>').css({position:"absolute","border-top":"1px solid #D8D8D8","padding-top":"4px"}),this.toolTipPnl.hoverfn(function(event){that.toolTipPnl.showfn(),that.tooltipScrollBar(that.toolTipPnl)},function(){that.toolTipPnl.hide()}),this.typingPnl.prepend(this.toolTipPnl),this.quickReplyPnl=$('<div class="QuickReplyPnl"></div>'),this.quickReplyImg=$('<img src="'+this.resourceBase+'/css/images/QuickResp.png"></img').appendTo(this.quickReplyPnl),this.quickReplyPnl.hoverfn(IC_Common.mouseEnterButton,IC_Common.mouseLeaveButton),this.typingPnl.prepend(this.quickReplyPnl),this.quickReplyPnl.attr({title:IC_Localization.quickResponse}),this.quiclReplyLstDiv=$('<div class = "quickReplyDiv chatContactQuickReply" />').quickReplyPopoutControl({controller:this,resourceBase:this.resourceBase}),this.quiclReplyLstDiv.css({"border-top":"1px solid #D8D8D8","border-right":"1px solid #D8D8D8"}),this.root.append(this.typingPnl),this.typingPnl.prepend(this.quiclReplyLstDiv),this.quickReplyPnl.on("click",function(event){that.toggleQuickReply()}),this.root},isChatMessageEditorOverlay:function(mode){"hide"===mode?($(".mce-edit-area",this.element).showfn(),this.chatMessageEditorOverlay.hide()):($(".mce-edit-area",this.element).hide(),this.chatMessageEditorOverlay.showfn())},toggleEnterKey:function(state){this.changeButtonState(this.enterPnl,this.enterImg,state,this.resourceBase+"/css/images/enter.png",this.resourceBase+"/css/images/enter-disable.png")},setEnterEnable:function(){var txt=$.trim(this.getChatText());this.toggleEnterKey("disabled"),txt!==this.chatPlaceholderMsg&&(txt.length>0&&this.toggleEnterKey("enabled"),this.options.controller.onChatTextChange(this.getRawChatText()))},rgb2hex:function(rgb){try{var sfMode=this.getSfMode();return rgb=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"#"+this.hex(rgb[1])+this.hex(rgb[2])+this.hex(rgb[3])}catch(e){}return sfMode},getSfMode:function(){return"Lightning"===this.options.container.options.sfMode?"rgb(84, 105, 141)":"#000000"},hex:function(x){var hexDigits=new Array("0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f");return isNaN(x)?"00":hexDigits[(x-x%16)/16]+hexDigits[x%16]},resetToDefaultValues:function(){var editor=this.chatTinyMceEditor,sfMode=(this.chatEditorSetting,this.getSfMode());if(void 0!=this.chatEditorSetting&&null!=this.chatEditorSetting)try{if(editor){if(isEditorProcessing=!0,void 0==this.chatEditorSetting.fontName&&(this.chatEditorSetting.fontName="verdana"),editor.execCommand("FontName",!0,this.chatEditorSetting.fontName),void 0==this.chatEditorSetting.fontSize&&(this.chatEditorSetting.fontSize="8pt"),editor.execCommand("FontSize",!0,this.chatEditorSetting.fontSize),"true"===this.chatEditorSetting.bold&&editor.execCommand("Bold",!1),"true"===this.chatEditorSetting.italic&&editor.execCommand("Italic",!1),"true"===this.chatEditorSetting.underline&&editor.execCommand("Underline",!1),editor.execCommand("ForeColor",!1,void 0==this.chatEditorSetting.foreColor?sfMode:this.chatEditorSetting.foreColor),this._chatEditorForecolorElement){var colorCode=void 0==this.chatEditorSetting.foreColor?sfMode:"background-color:"+this.chatEditorSetting.foreColor;$(this._chatEditorForecolorElement[0]).css({"background-color":colorCode})}}else this._chatEditorForecolorElement&&$(this._chatEditorForecolorElement[0]).css({"background-color":sfMode})}catch(e){}isEditorProcessing=!1},changeButtonState:function(div,img,state,iconEnabled,iconDisabled){"enabled"===(state=state||"disabled")?IC_Common.enableButton(div,img,iconEnabled):"disabled"===state?IC_Common.disableButton(div,img,iconDisabled):"selected"===state?IC_Common.selectButton(div,img,iconEnabled):"unselected"===state&&IC_Common.unselectButton(div,img,iconEnabled)},toggleQuickReply:function(callback){var that=this;this.toolTipPnl.css("width",$(".chatMessageEditor").width()-260+"px"),IC_Common.isButtonEnabled(this.quickReplyPnl)&&this.quiclReplyLstDiv.toggle("slide",{direction:"down"},250,function(){"none"===that.quiclReplyLstDiv.css("display")?($(".chatMessageEditor").find("#tooltipID").hide(),that.quickReplyPnl.removeClass("btnDivSelect"),that.quiclReplyLstDiv.quickReplyPopoutControl("resetQuickReply"),"function"==typeof callback&&callback()):(that.quickReplyPnl.addClass("btnDivSelect"),that.quiclReplyLstDiv.quickReplyPopoutControl("renderCustomScrollBar"))})},appendQuickReply:function(quickReplyContent){this.chatTinyMceEditor.off("blur"),this.chatTinyMceEditor.focus(),tinymce.execCommand("mceInsertContent",!1,quickReplyContent+"\n"),this.chatTinyMceEditor.on("blur",$.proxy(this.setPlaceHolder,this)),this.toggleQuickReply();var newstr=this.chatTinyMceEditor.getContent().replace("&#65279;","");this.chatTinyMceEditor.setContent(newstr),this.chatTinyMceEditor.selection.select(this.chatTinyMceEditor.getBody(),!0),this.chatTinyMceEditor.selection.collapse(!1),this.setEnterEnable()},renderCustomScroll:function(width,height){},updateQuickReplyData:function(type,data){"quickReply"===type&&this.quiclReplyLstDiv.quickReplyPopoutControl("updateData",data.quickReply,data.skillId)},tooltipScrollBar:function(obj){"block"===obj.css("display")&&(obj.mCustomScrollbar("destroy"),obj.mCustomScrollbar({scrollButtons:{enable:!0},scrollInertia:0}))},getTargetElemet:function(){return null},setPlaceHolder:function(){var chatText=$.trim(this.getChatText()),targetElement=this.getTargetElemet(),placeHolderColor="Lightning"===this.options.container.options.sfMode?"rgb(84, 105, 141)":"#9F9F9F";return 0==chatText.length&&(this.setChatText(this.chatPlaceholderMsg),targetElement.css("color",placeHolderColor)),this.getEditorForeColor(),!1},createChatEditor:function(){var that=this,id=this.notesTxt.attr("id");this.notesTxt.addClass(id),$("body").addClass("chatFormatbody");var sfMode=this.getSfMode();setTimeout(function(){tinymce.init({plugins:"textcolor paste code ",convert_fonts_to_spans:!1,mode:"specific_textareas",editor_selector:id,menubar:!1,toolbar:["fontselect fontsizeselect bold italic underline forecolor"],statusbar:!1,forced_root_block:!1,content_css:that.resourceBase+"/css/ChatEditor.css",fontsize_formats:"8=8pt 9=9pt 10=10pt 11=11pt 12=12pt 14=14pt 16=16pt 18=18pt 20=20pt 22=22pt 24=24pt 26=26pt 28=28pt 36=36pt 48=48pt 72=72pt",font_formats:"_sans=_sans;_serif=_serif;_typewriter=_typewriter;Arial=Arial;Courier=Courier;Courier New=Courier New;Geneva=Geneva;Georgia=Georgia;Helvetica=Helvetica;Times New Roman=Times New Roman;Times=Times;Verdana=Verdana",init_instance_callback:function(){var oldApply=that.chatTinyMceEditor.formatter.apply;that.chatTinyMceEditor.formatter.apply=function(name,vars,node){oldApply(name,vars,node),that.chatTinyMceEditor.fire("ExecCommand",{name:name,vars:vars})}},setup:function(editor){function onFocus(e){var ed=that.chatTinyMceEditor;$.trim(ed.getContent({format:"text"}))===that.chatPlaceholderMsg&&(that.clearChatText(),that.resetToDefaultValues())}that.chatTinyMceEditor=editor,editor.on("keydown",function(e){var ed=that.chatTinyMceEditor,content=$.trim(ed.getContent({format:"text"}));return 8!=e.which&&13!=e.which&&46!=e.which||0!=content.length?(content===that.chatPlaceholderMsg&&(that.clearChatText(),that.resetToDefaultValues()),13===e.which&&0!=content.length?(that.enterPnl.trigger("click"),that.isAgentTyping=!0,that.onChatAgentTyping(!1,!0,function(){that.isAgentTyping=!1}),e.preventDefault(),!1):void(8!==e.which&&46!==e.which||0==content.length||that.onChatAgentTypingInterval())):(e.preventDefault(),!1)}),editor.on("keyup",function(e){0==$.trim(that.chatTinyMceEditor.getContent({format:"text"})).length&&(that.clearChatText(),that.resetToDefaultValues()),that.setEnterEnable()}),editor.on("keypress",function(e){var ed=that.chatTinyMceEditor;$.trim(ed.getContent({format:"text"})),e.which>=32&&e.which<=126&&that.onChatAgentTypingInterval()}),editor.on("init",function(){var chatEditorSetting=that.options.controller.getChatEditorSetting()||{};that.chatEditorSetting={fontName:chatEditorSetting.fontName||"verdana",fontSize:chatEditorSetting.fontSize||"8pt",bold:chatEditorSetting.bold||"false",italic:chatEditorSetting.italic||"false",underline:chatEditorSetting.underline||"false",foreColor:chatEditorSetting.foreColor||sfMode};var element=$(this.getDoc().body);that.getTargetElemet=function(){return element},that.options.controller.setMaxLengthConstraints(),that.loadChatEditorUI(that),that.resetToDefaultValues(),$("#mceu_7").showfn(),editor.focus()}),editor.on("click",onFocus),editor.on("focus",onFocus),editor.on("blur",$.proxy(that.setPlaceHolder,that)),editor.on("change",function(e){if(0==isEditorProcessing&&void 0!=e.originalEvent){var command=void 0==e.originalEvent.command?e.originalEvent.name:e.originalEvent.command;void 0!=command&&("FontName"==command?that.chatEditorSetting.fontName=void 0==e.originalEvent.value?"verdana":e.originalEvent.value:"FontSize"==command?that.chatEditorSetting.fontSize=void 0==e.originalEvent.value?"8pt":e.originalEvent.value:"italic"==e.originalEvent.value?that.chatEditorSetting.italic=that.chatTinyMceEditor.queryCommandState("italic").toString():"underline"==e.originalEvent.value?that.chatEditorSetting.underline=that.chatTinyMceEditor.queryCommandState("underline").toString():"bold"==e.originalEvent.value?that.chatEditorSetting.bold=that.chatTinyMceEditor.queryCommandState("bold").toString():"forecolor"==command&&that.getEditorForeColor(),that.setChatEditorSetting())}}),editor.on("paste",function(e){that.onChatAgentTypingInterval()})}})},500)},onChatAgentTypingInterval:function(){var that=this;clearTimeout(this.patronTypingInterval),clearTimeout(this.patronTextEnteredInterval),this.patronTypingInterval=setTimeout(function(){that.isAgentTyping||that.onChatAgentTyping(!0,!1,function(){that.isAgentTyping=!0}),that.patronTextEnteredInterval=setTimeout(function(){that.isAgentTyping&&that.onChatAgentTyping(!1,!0,function(){that.isAgentTyping=!1})},5e3)},300)},onChatAgentTyping:function(isTyping,isTextEntered,callback){this.options.controller.onChatAgentTyping({isTyping:isTyping,isTextEntered:isTextEntered},this._contactId,callback)},getEditorForeColor:function(){void 0!=$("._foreColorLabel").css("backgroundColor")&&(7!=$("._foreColorLabel").css("backgroundColor").length?this.chatEditorSetting.foreColor=this.rgb2hex($("._foreColorLabel").css("backgroundColor")):this.chatEditorSetting.foreColor=$("._foreColorLabel").css("backgroundColor"),this.setChatEditorSetting())},setChatEditorSetting:function(){this.options.controller.setChatEditorSetting(this.chatEditorSetting)},getRawChatText:function(){return this.chatTinyMceEditor?this.chatTinyMceEditor.getContent({format:"raw"}):""},getChatText:function(){return this.chatTinyMceEditor?this.chatTinyMceEditor.getContent({format:"text"}):""},setChatText:function(value){this.chatTinyMceEditor&&this.chatTinyMceEditor.setContent(value)},restoreChatText:function(value){this.setChatText(value),this.setEnterEnable()},clearChatText:function(){if(this.chatTinyMceEditor){var element=this.getTargetElemet(),sfMode=this.getSfMode();element&&(element.empty(),element.css("color",sfMode),this.toggleEnterKey("disabled"))}},addHyperlink:function(txt,url){this.chatTinyMceEditor.focus(),tinymce.execCommand("mceInsertContent",!1,"<a href='"+url+'\' target="_blank">'+txt+"</a>"),this.clearURLTxt(),this.setEnterEnable()},clearURLTxt:function(){this.dialogPanelURL.val("http://"),this.dialogPanelURLTxt.val(""),this.dialogPanelURL.css({border:" 1px solid #AAAAAA"}),this.dialogPanelURLTxt.css({border:" 1px solid #AAAAAA"})},loadChatEditorUI:function(context){var toolbarParent=this.textPnl.find(".mce-widget").parent(),buttons=$("[role=button]",toolbarParent);$(buttons[0]).find("span").addClass("fontLabel"),$(buttons[5]).find("span").addClass("_foreColorLabel"),$($(buttons[2],toolbarParent).children()[0],toolbarParent).empty(),$($(buttons[2],toolbarParent).children()[0],toolbarParent).append($("<img/>").attr("src",context.resourceBase+"/css/images/mailtoolbar/bold.png")),$($(buttons[3],toolbarParent).children()[0],toolbarParent).empty(),$($(buttons[3],toolbarParent).children()[0],toolbarParent).append($("<img/>").attr("src",context.resourceBase+"/css/images/mailtoolbar/italic.png")),$($(buttons[4],toolbarParent).children()[0],toolbarParent).empty(),$($(buttons[4],toolbarParent).children()[0],toolbarParent).append($("<img/>").attr("src",context.resourceBase+"/css/images/mailtoolbar/underline.png"));var foregroundElement=$($(buttons[5],toolbarParent).children()[0],toolbarParent);foregroundElement.find("i").replaceWith($("<img/>").attr("src",context.resourceBase+"/css/images/mailtoolbar/FontColor.png")),this._chatEditorForecolorElement=foregroundElement.find("span");var linkBUtton=$('<div id="mceu_6" class="mce-widget mce-btn" tabindex="-1" aria-labelledby="mceu_6" role="button"  title="'+IC_Localization.hyperlink+'"><button role="presentation" type="button" tabindex="-1"><img style="height: 25px;margin-top: -5px;"  src="'+context.resourceBase+'/css/images/Link.png"></button></div>');toolbarParent.append(linkBUtton),linkBUtton.on("click",function(){context.dialogPanel.dialog("open")})},setContactId:function(contactId){this._contactId=contactId},hide:function(){this.root.hide(),this.options.controller.canShowChatMessageEditor()&&this.root.showfn(),this.quiclReplyLstDiv.hide()},show:function(bottom){this.root.showfn(),this.clearChatText(),this.resetToDefaultValues()},resizeMessageEditor:function(bottom){this.root.animate({bottom:46+bottom})},destroy:function(){!0!==this.stopDestroy&&(this.stopDestroy=!0)}});