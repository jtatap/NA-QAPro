!function($){$.widget("AgentConsole.agentMessageScroll",{options:{container:null,resourceBase:""},flashMsgTimeLimit:5,flashMsgTimeCount:0,scrollMsgCount:0,scrollMsgLines:[],scrollMsgID:{},marqueeMsg:!1,agentMessageCount:0,flashMsgTimer:0,_init:function(){document.getElementById("renderTextSize")||$('<div id="renderTextSize"/>').addClass("renderTextSize").appendTo("Body")},_create:function(){var rootPanel=this.element;this.msgTxt=$('<div id="rollingTxt" class="rollingTxt" />').appendTo(rootPanel),this.msgIcn=$('<div class="icn" />').appendTo(rootPanel),this.msgCount=$('<div class="count" />').appendTo(this.msgIcn)},loadMsgLines:function(indexVal){var ul,text="",index=indexVal;0===index?($(".rollingTxt").find(".ulList").empty(),ul=$('<ul class="ulList"/>')):ul=$(".rollingTxt").find(".ulList");for(var a=index;a<this.scrollMsgLines.length;a++)null==this.scrollMsgLines[a]&&void 0==this.scrollMsgLines[a]||(text=$("<li>"+this.scrollMsgLines[a]+"</li>"),$(ul).append(text));this.msgTxt.empty().append(ul),setTimeout($.proxy(this.messageScroller,this),2500),this.incomingMessage()},messageScroller:function(){var dv=$("#rollingTxt ul li:first-child"),len=$("#rollingTxt ul li").length;this.scrollMsgCount++,len>1?(dv.hide("slow",function(){dv.remove()}),this.scrollMsgTimer=setTimeout($.proxy(this.messageScroller,this),2500),this.marqueeMsg=!0):this.resetScrollMsg()},getWrapedText:function(message){var msgSplit="",msgLine="",index=0,isExceed=!1,render=!1,agentMsgDivTxt="";this.rollingCount=0,!1===this.marqueeMsg?(this.scrollMsgLines=[],this.scrollMsgCount=0,this.destroy()):index=this.scrollMsgLines.length;for(var j=0;j<message.length;j++)if(!0!==this.scrollMsgID[message[j].id]&&!1===message[j].scrollMsg){render=!0,this.options.container.scrollAgentMsg(message[j].id),this.scrollMsgID[message[j].id]=!0,(agentMsgDivTxt=$('<div id="agentMsgDivTxt" class="agentMsgDivTxt"/>').appendTo("Body")).html(message[j].msg),msgSplit=(message[j].sub+": "+agentMsgDivTxt.text()).split(" "),"",msgLine="";for(var i=0;i<msgSplit.length;i++)if(isExceed=!1,msgLine.length<18?msgLine=(""==msgLine?"":msgLine+" ")+msgSplit[i]:(isExceed=!0,msgLine=(""==msgLine?"":msgLine+" ")+msgSplit[i]),msgSplit.length-1==i||1==isExceed){var count=parseInt(msgLine.length/18);msgLine.length%18!=0&&(count+=1);for(var s=0;s<count;s++){var startIndex=0==s?0:18*s;count-1!=s?this.scrollMsgLines.push(msgLine.substr(startIndex,18)):this.scrollMsgLines.push(msgLine.substr(startIndex,msgLine.length-18*s+1))}msgLine=""}}render&&this.loadMsgLines(index),$("#agentMsgDivTxt").remove()},incomingMessage:function(){0===this.flashMsgTimeCount?(this.flashMsgTimer=setInterval($.proxy(this.incomingMessage,this),1e3),this.flashMsgTimeCount++,this.options.container.headerPanelFlash(.4)):this.flashMsgTimeCount==this.flashMsgTimeLimit?(clearInterval(this.flashMsgTimer),this.flashMsgTimeCount=0,this.options.container.headerPanelFlash(1)):(this.flashMsgTimeCount++,this.msgIcn.effect("bounce",{times:1},1e3),0===this.flashMsgTimeCount||this.flashMsgTimeCount%2==0?this.options.container.headerPanelFlash(1):this.options.container.headerPanelFlash(.4))},updateMetaData:function(message,agentMsgTab){for(var render=!1,msgCount=0,j=0;j<message.length;j++)(!this.scrollMsgID.hasOwnProperty(message[j].id)||this.agentMessageCount<message.length)&&(!message[j].isEvolve||message[j].isEvolve&&"false"===message[j].readMsg)&&(render=!0),(!message[j].isEvolve||message[j].isEvolve&&"false"===message[j].readMsg)&&msgCount++;this.agentMessageCount=message.length,msgCount>0?this.msgCount.text(msgCount):this.msgIcn.css("display","none"),"none"===this.msgIcn.css("display")&&msgCount>0&&this.msgIcn.fadeIn(),render?(this.scrollTxtCntrl(agentMsgTab),this.getWrapedText(message)):0===message.length&&this.scrollTxtCntrl(!0)},resetScrollMsg:function(){this.marqueeMsg=!1,clearInterval(this.scrollMsgTimer)},closeScrollMsg:function(){this.resetScrollMsg(),this.scrollTxtCntrl(!0)},scrollTxtCntrl:function(flag){flag?(this.msgTxt.hide(),this.destroy()):this.msgTxt.showfn()},destroy:function(){this.msgTxt.children().each(function(){IC_Common.discardElement(this)})},clearFlashMsgTimer:function(){clearInterval(this.flashMsgTimer),this.flashMsgTimeCount=0,this.options.container.headerPanelFlash(1)}})}(jQuery);