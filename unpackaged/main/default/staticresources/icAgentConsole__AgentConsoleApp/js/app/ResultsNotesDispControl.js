!function($){var logger=IC_Common.getLogger("ResultsNotesDispControl");$.widget("AgentConsole.resultsNotesDispControl",{options:{container:null,resourceBase:"",isChatPanel:!1,useSecDisposition:!1,reqDisposition:!1,agentInfo:{}},selectedDisposition:"",selectedSecDisposition:"",disposition:[],isDialer:!1,isIndicator:!1,currentDropDownHeight:0,resizedNotesHeight:0,_create:function(){var dispPanel,dateTxt,dateImg,decimalValidator=/\./,that=this;this.DefaultDispText=IC_Localization.selectDisposition,this.DefaultSecDispText=IC_Localization.additionalDisp,this.DefaultAmntText=IC_Localization.enterAmount,this.dispDivId=IC_Common.generateUniqueId("disp"),this.secDispDivId=IC_Common.generateUniqueId("secDisp"),this.consoleOptions=this.options.container.consoleOptions(),this.localeDateTimeFormat=this.consoleOptions.localeDateTimeFormat.replace("yy","yyyy"),this.contentPanel=$('<div class = "contentPnl" />').appendTo(this.options.container.menuContentPanel),this.dateContainerPanel=$('<div class = "dispContentPnl" />').appendTo(this.options.container.notesPanel),this.dateContainerPanel.hide(),dispPanel=$('<div class = "container" id = "'+this.dispDivId+'"/>').appendTo(this.contentPanel),this.dispSelect=$('<div id = "resultsNotesdispSelect" class="selectBox dispSelect"> </div>').appendTo(dispPanel),this.dispSelect.comboBox({onDataChange:$.proxy(this.ondispositionSelected,this),resourceBase:this.options.resourceBase,dispPosition:"top",onComboxMenuShow:$.proxy(this.onComboxMenuShow,this),onComboxMenuHide:$.proxy(this.onComboxMenuHide,this)}),this.dispError=$("<div/>").addClass("dispErrorDiv textEllipsis").appendTo(this.contentPanel),this.dispError.hide(),this.datePanel=$('<div class = "container searchText datePnl"/>').appendTo(this.contentPanel),dateTxt=$('<div class = "dateTxt"/>').appendTo(this.datePanel),this.dateValue=$('<input class = "searchTextInput dateVal" type="text" title="'+IC_Localization.date+'"/>').appendTo(dateTxt),this.dateValue.on("blur",$.proxy(this.onDateTextBlur,this)),dateImg=$('<div class = "divImgCalendar"/>').appendTo(this.datePanel),$('<div class = "imgCalendar"></div>').on("click",$.proxy(this.onDateTxtClick,this)).appendTo(dateImg),this.datePanel.hide(),this.dispDateError=$("<div/>").addClass("dispErrorDiv textEllipsis").appendTo(this.contentPanel),this.dispDateError.hide(),this.amntPanel=$('<div class = "container searchText amntDiv"/>').appendTo(this.contentPanel),this.amntValue=$('<input class = "searchTextInput" type="text" title="'+IC_Localization.enterAmount+'"/>').appendTo(this.amntPanel),this.amntValue.on("click",$.proxy(this.onAmntTxtChange,this)),this.amntValue.on("focus",$.proxy(this.onAmntTxtChange,this)),this.amntValue.on("blur",$.proxy(this.onAmntTextBlur,this)),this.amntPanel.hide(),this.dispAmountError=$("<div/>").addClass("dispErrorDiv textEllipsis").appendTo(this.contentPanel),this.dispAmountError.hide(),this.secDispPanel=$('<div class = "container secDisposition" id = "'+this.secDispDivId+'"/>').appendTo(this.contentPanel),this.secDispSelect=$('<div id = "secDispSelect" class="selectBox secDispSelect"> </div>').appendTo(this.secDispPanel),this.secDispSelect.comboBox({onDataChange:$.proxy(this.onsecDispositionSelected,this),resourceBase:this.options.resourceBase,dispPosition:"top",onComboxMenuShow:$.proxy(this.onComboxMenuShow,this),onComboxMenuHide:$.proxy(this.onComboxMenuHide,this)}),this.options.useSecDisposition||this.secDispPanel.hide(),$('<div class="submitText textEllipsis" title="'+IC_Localization.dispSubmitBtn+'">'+IC_Localization.dispSubmitBtn+"</div>").appendTo(void 0),this._initDatePicker(),this.setDefaultText(),this.amntValue.on("keypress",function(e){if(8!==e.which&&0!==e.which&&(e.which<48||e.which>57)&&46!==e.which)return!1;var amnt=that.amntValue.val();return!(46===e.which&&amnt.length>0&&decimalValidator.test(amnt))&&void 0}),this.element.hide()},_init:function(){this.localeDateFormat=this.consoleOptions.localeDateFormat.replace(/M/g,"m")},_initDatePicker:function(){new Date(this.options.container.getServerTimestamp()+18e4);var dpDoneBtn,divDoneBtn,that=this;this.dpStartDateCal=$('<div class="startDateCal" />').appendTo(this.dateContainerPanel),this.dpStartDateCal.datepicker({minDate:"0",inline:!0,onSelect:function(){var selectedData=that.dpStartDateCal.datepicker("getDate");$.datepicker.formatDate("D "+that.localeDateFormat,selectedData);that._hideInvalidTimeError()},onChangeMonthYear:function(){that._hideInvalidTimeError()}}),this.expiredTimeError=$("<div class='errorPanel'>").appendTo(this.dateContainerPanel).hide(),this.timePickerLabel=$("<div class='timePickerLabel'>").text(IC_Localization.time).appendTo(this.dateContainerPanel);var selectTimePicker=$("<div class='selectTimePicker' />").appendTo(this.dateContainerPanel);this.timePickerOptions=$("<div id = 'timePickerOptions' class='timeZoneSelect'>").appendTo(selectTimePicker),this.timePickerOptions.comboBox({onDataChange:function(){that._hideInvalidTimeError(),that.timePickerOptionsTxt.val(that.timePickerOptions.comboBox("getSelectedItem").id)},resourceBase:this.options.resourceBase}),this.timePickerOptionsTxt=$("<input type='text' class='timePickerSelect timePickerOptionsTxt' title='"+IC_Localization.time+"'>").appendTo(selectTimePicker).on("keydown",$.proxy(that._onTimeType,that)),this.timePickerOptions.find(".txtDiv .txtSpn").css({opacity:0}),this.timeZoneLabel=$("<div class='timeZoneLabel'/>").text(IC_Localization.timezone).appendTo(this.dateContainerPanel),this.timeZoneOptions=$("<div id = 'dispTimeZoneOptions' class='timeZoneSelect'/>").appendTo(this.dateContainerPanel),this.timeZoneOptions.comboBox({resourceBase:this.options.resourceBase}),divDoneBtn=$('<div class="divDoneBtn" />').appendTo(this.dateContainerPanel),(dpDoneBtn=$('<div class="btnDone submitGradient textEllipsis" title="'+IC_Localization.done+'">'+IC_Localization.done+"</div>").appendTo(divDoneBtn)).hoverfn(function(){$(this).addClass("submitHover")},function(){$(this).removeClass("submitHover")}),this.timeZone=IC_Common.selectTimeZone(that.consoleOptions.localeTimeFormat,that.consoleOptions.localeCode),this.timeZone.loadTimeIntervals(this.timePickerOptions),this.timeZone.setTimezones(this.timeZoneOptions,AgentConsoleDataStore.timeZoneList),dpDoneBtn.on("click",$.proxy(this.onDateRangePickerClose,this))},_onTimeType:function(evt){this._hideInvalidTimeError()},getLocaleTime:function(){var timeLocale=this.dpStartDateCal.find(".ui_tpicker_time");timeLocale.text(IC_Common.getAMPMLocale(timeLocale.text(),this.consoleOptions.localeCode))},ondispositionSelected:function(){var showPnl,obj=this.dispSelect.comboBox("getSelectedItem");logger.debug("Disposition Selected",obj),$("#"+this.dispDivId+" .txtSpn").removeClass("dispComboText"),this.selectedDisposition=obj,"NaturalCalling"===this.contactType&&(showPnl=obj.isAmount|obj.isDate,this.toggleDateAmntPanel(showPnl,obj.isDate)),this.secDispPanel.hide(),this.setDispositionPayLoad(!1,""),this.options.container.contactResultChanged(this.options.contactId,IC_Util.Disposition,this.selectedDisposition),this.options.useSecDisposition&&($("#"+this.secDispDivId+" .txtSpn").removeClass("secDispComboText"),this.populateSecDispositions(this.disposition,this.selectedDisposition),this.secDispPanel.showfn()),"block"===this.dispError.css("display")&&this.dispError.hide(),this.options.container.setNotesPanelHeight()},onsecDispositionSelected:function(){var obj=this.secDispSelect.comboBox("getSelectedItem");logger.debug("Secondary Disposition Selected",obj),$("#"+this.secDispDivId+" .txtSpn").removeClass("dispComboText"),this.selectedSecDisposition=obj,this.options.container.contactResultChanged(this.options.contactId,IC_Util.SecondaryDisposition,this.selectedSecDisposition),this.populateDispositions(this.disposition,this.contactType,this.selectedSecDisposition)},onComboxMenuShow:function(){},onComboxMenuHide:function(){this.dispSelect.comboBox("comboxMenuHide"),"block"===this.secDispPanel.css("display")&&this.secDispSelect.comboBox("comboxMenuHide")},updateContactDetails:function(options){this.contactEvent=options.contactType},onDateRangePickerClose:function(){var selectDateTime=this.dpStartDateCal.datepicker("getDate"),time={},selectedTime=$.trim(this.timePickerOptionsTxt.val());if(this.timeZone.isValidTimeSelected(selectedTime,time)){selectDateTime.setHours(time.hours),selectDateTime.setMinutes(time.minutes);var currentTime=new Date,that=this;AgentConsoleDataStore.getIANATimeZoneOffset(this.timeZone.getIANAName(that.timeZoneOptions),function(offset,error){var hours,minutes,dif,targetZoneCallbackTime=null;if(error||0==offset){var data=that.timeZone.getHoursMinutesbyOffset(that.timeZoneOptions,selectDateTime);hours=data.hours,minutes=data.minutes,dif=data.dif}else offset=parseFloat(offset/36e5),hours=Math.abs(parseInt(offset)),minutes=60*(Math.abs(offset)-hours),dif=offset>0?"+":"-";var pad=function(num){var norm=Math.abs(Math.floor(num));return(norm<10?"0":"")+norm},isoDateFormat=selectDateTime.getFullYear()+"-"+pad(selectDateTime.getMonth()+1)+"-"+pad(selectDateTime.getDate())+"T"+pad(selectDateTime.getHours())+":"+pad(selectDateTime.getMinutes())+":"+pad(selectDateTime.getSeconds())+dif+pad(hours)+":"+pad(minutes);(targetZoneCallbackTime=new Date(isoDateFormat))<=currentTime?that._showInvalidTimeError(IC_Localization.inValidDateTimeErrorAttempt):(that._hideInvalidTimeError(),that.dtValue=IC_Common.toShortDateTimeString(targetZoneCallbackTime),that.dateValue.val(IC_Common.getAMPMLocale(targetZoneCallbackTime.format(that.localeDateTimeFormat),that.consoleOptions.localeCode)),that.setDispositionPayLoad(!0,that.dtValue),that.dateContainerPanel.hide(),that.options.container.notesContPanel.showfn(),that.options.container.setNotesPanelHeight())})}else this._showInvalidTimeError(IC_Localization.inValidTimeFormatErrorAttempt)},_showInvalidTimeError:function(errorMessage){this.expiredTimeError.text(errorMessage).showfn()},_hideInvalidTimeError:function(){this.expiredTimeError.hide()},setDispositionPayLoad:function(_isReschedule,value){var payload={isReschedule:_isReschedule,data:value};this.options.container.contactResultChanged(this.options.contactId,IC_Util.DispositionPayload,payload)},onDateTxtClick:function(){this.options.container.notesContPanel.hide(),this.dateContainerPanel.showfn(),this.dpStartDateCal.datepicker("setDate",this.dtValue),this.timeZone.setUserTimeZone(this.timeZoneOptions,this.options.resourceBase),this.timePickerOptionsTxt.val(this.timeZone.getDisplayTime(new Date(this.dtValue))),this.timeZone.saveSelectedTimeForValidation(this.timeZone.getDisplayTime(new Date(this.dtValue))),this.options.container.setNotesPanelHeight()},onAmntTxtChange:function(){this.amntValue.val()===IC_Localization.enterAmount&&(this.amntValue.val(""),this.amntValue.removeClass("dispComboText"))},onDateTextBlur:function(){this.validateDate()},onAmntTextBlur:function(){""==this.amntValue.val()?(this.amntValue.val(this.DefaultAmntText),this.amntValue.addClass("dispComboText")):"block"===this.dispAmountError.css("display")&&this.dispAmountError.hide(),this.setDispositionPayLoad(!1,this.amntValue.val())},updateMetaData:function(isChatPanel,contactId){this.options.isChatPanel=isChatPanel,this.options.contactId=contactId},updateSkillDetails:function(skill,agentInfo){this.options.useSecDisposition=skill.useSecDispositions,this.options.reqDisposition=skill.reqDisposition,this.options.agentInfo=agentInfo},updateData:function(sfResult){var contactType=this.contactType,selectedDisp=sfResult.task.disp,dispPayload=sfResult.task.dispPayload,secSelectedDisp=sfResult.task.secDisp;IC_Validation.isValidObject(secSelectedDisp)&&""!==secSelectedDisp.value?(this.selectedSecDisposition=secSelectedDisp,this.secDispSelect.comboBox("setSelectedItem",{value:secSelectedDisp.value}),$("#"+this.secDispDivId+" .txtSpn").removeClass("secDispComboText"),this.populateDispositions(this.disposition,this.contactType,this.selectedSecDisposition),this.secDispPanel.showfn()):(this.secDispSelect.comboBox("setSelectedItem",{value:this.DefaultSecDispText}),$("#"+this.secDispDivId+" .txtSpn").addClass("secDispComboText"),this.resetSelectedValue(),this.secDispPanel.hide()),IC_Validation.isValidObject(selectedDisp)&&""!==selectedDisp.value?(this.selectedDisposition=selectedDisp,this.dispSelect.comboBox("setSelectedItem",{value:selectedDisp.value}),$("#"+this.dispDivId+" .txtSpn").removeClass("dispComboText"),$("#"+this.secDispDivId+" .txtSpn").removeClass("secDispComboText"),this.populateSecDispositions(this.disposition,this.selectedDisposition),"NaturalCalling"===contactType&&(showPnl=selectedDisp.isAmount|selectedDisp.isDate,this.toggleDateAmntPanel(showPnl,selectedDisp.isDate)),IC_Validation.isValidObject(dispPayload)&&dispPayload.hasOwnProperty("isReschedule")&&dispPayload.data&&(selectedDisp.isDate&&dispPayload.isReschedule?(this.dtValue=dispPayload.data,this.dateValue.val(IC_Common.getAMPMLocale(new Date(this.dtValue).format(this.localeDateTimeFormat),this.consoleOptions.localeCode))):selectedDisp.isAmount&&0==dispPayload.isReschedule&&(this.amntValue.val(dispPayload.data),this.amntValue.removeClass("dispComboText"))),"block"===this.dispError.css("display")&&this.dispError.hide(),!0===this.options.useSecDisposition?this.secDispPanel.showfn():this.secDispPanel.hide()):(this.dispSelect.comboBox("setSelectedItem",{value:this.DefaultDispText}),$("#"+this.dispDivId+" .txtSpn").addClass("dispComboText"))},populateDispositions:function(dispositions,contactType,secDisposition){var isAmount,isDate,i=0,filteredList=[],primDisposition=[];if(this.disposition=dispositions,IC_Validation.isNotNullOrUndefinedString(secDisposition)?primDisposition=dispositions.filter(function(item){return item.id!==secDisposition.id&&!1===item.isPreviewDisposition}):IC_Validation.isNotNullOrUndefinedString(dispositions)&&(primDisposition=dispositions.filter(function(item){return!1===item.isPreviewDisposition})),this.contactType=contactType,IC_Validation.isNotNullOrEmptyArray(primDisposition)){for(i=0;i<primDisposition.length;i++){isAmount=!1,isDate=!1,IC_Validation.isNullOrEmpty(primDisposition[i].isAmount)||(isAmount=primDisposition[i].isAmount,isDate=primDisposition[i].isDate);var obj={id:primDisposition[i].id,value:primDisposition[i].name,order:primDisposition[i].order,isPreviewDisposition:primDisposition[i].isPreviewDisposition,isAmount:isAmount,isDate:isDate};filteredList.push(obj)}filteredList.sort(function(a,b){return a.order-b.order}),this.dispSelect.comboBox("setStore",filteredList)}},populateSecDispositions:function(dispositions,selectedDisposition){var isAmount,isDate,secDisposition,i=0,filteredList=[];if(this.secDisposition=dispositions.filter(function(item){return item.id!==selectedDisposition.id&&!1===item.isPreviewDisposition}),secDisposition=this.secDisposition,IC_Validation.isNotNullOrEmptyArray(secDisposition)){for(i=0;i<secDisposition.length;i++){isAmount=!1,isDate=!1,IC_Validation.isNullOrEmpty(secDisposition[i].isAmount)||(isAmount=secDisposition[i].isAmount,isDate=secDisposition[i].isDate);var obj={id:secDisposition[i].id,value:secDisposition[i].name,order:secDisposition[i].order,isAmount:isAmount,isPreviewDisposition:secDisposition[i].isPreviewDisposition,isDate:isDate};filteredList.push(obj)}filteredList.sort(function(a,b){return a.order-b.order}),this.secDispSelect.comboBox("setStore",filteredList)}},validateDate:function(){var isValidDate=!1,that=this,ampmText=function(){var ampm=IC_Common.differentLocaleAMPM,amPMObj={AM:"AM",PM:"PM"},langCode=that.consoleOptions.localeCode.substr(0,2).toLowerCase();IC_Validation.isNotNullOrUndefinedString(ampm[langCode])&&(amPMObj=ampm[langCode]);return amPMObj}(),dateTimeString=this.dateValue.val().replace(ampmText.AM,"AM").replace(ampmText.PM,"PM"),enteredDate=Date.parseString(dateTimeString,this.localeDateTimeFormat);if(null==enteredDate)isValidDate=!1;else{this.dtValue=IC_Common.toShortDateTimeString(enteredDate);enteredDate>new Date&&this.dtValue.match(/^\d{2}\/\d{2}\/\d{4}\s\d{2}\:\d{2}\s(?:a|p)m$/)&&(isValidDate=!0,this.setDispositionPayLoad(!0,this.dtValue))}return isValidDate},resetSelectedValue:function(){this.selectedDisposition="",this.selectedSecDisposition="",this.secDispSelect.comboBox("setStore",[]),this.amntValue.val(this.DefaultAmntText),this.dateValue.val(""),this.dispError.hide(),this.amntPanel.hide(),this.dispAmountError.hide(),this.dateContainerPanel.hide(),this.datePanel.hide(),this.dispDateError.hide(),this.dtValue=""},isErrorDisplayed:function(){return"block"===this.dispDateError.css("display")||"block"===this.dispAmountError.css("display")||"block"===this.dispError.css("display")},setDefaultText:function(){this.dispSelect.comboBox("setSelectedItem",{value:this.DefaultDispText}),$("#"+this.dispDivId+" .txtSpn").addClass("dispComboText"),this.datePanel.hide(),this.secDispPanel.hide(),this.amntPanel.hide(),this.secDispSelect.comboBox("setSelectedItem",{value:this.DefaultSecDispText}),this.secDispPanel.find(".txtSpn").addClass("secDispComboText"),this.amntValue.val(this.DefaultAmntText),this.amntValue.addClass("dispComboText")},toggleDateAmntPanel:function(showPnl,isDate){if(!1===this.options.isChatPanel){var notesHeight=showPnl?277:309;if(notesHeight=this.isDialer?notesHeight-27:notesHeight,notesHeight=this.isIndicator?notesHeight-24:notesHeight,this.amntPanel.hide(),this.datePanel.hide(),this.dispError.hide(),this.dispAmountError.hide(),this.dispDateError.hide(),this.dateValue.val(""),this.dtValue="",this.amntValue.val(this.DefaultAmntText),showPnl)if(isDate){var today=new Date(this.options.container.getServerTimestamp()+18e4);this.dtValue=IC_Common.toShortDateTimeString(today),this.dateValue.val(IC_Common.getAMPMLocale(today.format(this.localeDateTimeFormat),this.consoleOptions.localeCode)),this.datePanel.showfn()}else this.amntPanel.showfn()}},getContactId:function(){return this.options.contactId},setContactId:function(contactId){this.options.contactId=contactId},destroy:function(){logger.debug("Disposition panel destroy triggered")}})}(jQuery);