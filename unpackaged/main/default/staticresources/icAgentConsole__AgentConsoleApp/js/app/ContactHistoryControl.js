!function($){$.widget("AgentConsole.contactHistory",{searchText:"",allSkills:{},contactStates:[],gridData:[],containerId:"agentConsoleContainer",startDate:"",endDate:"",options:{container:null,resourceBase:""},searchWatermark:"",_create:function(){var rootPanel,searchBtnDiv,searchTxtDiv,parent=this.element,that=this;this.searchWatermark=IC_Localization.search+" ...",this.options.container.isPopout?(this.gridScrollHeight=270,this.containerId="agentConsolePopoutContainer"):(this.containerId="agentConsoleContainer",this.gridScrollHeight=254),parent.addClass("contactHistory"),$('<span class="dialogHidden">'+IC_Localization.begin+" "+IC_Localization.contactHistory+"</span>").appendTo(parent),rootPanel=$('<div class="modalDialogBackground"/>').appendTo(parent),this.headerPanel=$('<div class="modalDialogHeader" tabindex="-1" aria-labelledby="contactHistoryHeaderId"/>').appendTo(rootPanel),this.sortPanel=$('<div id = "sortPanelId" class="sortPanel"/>').appendTo(rootPanel),this.filterPanel=$('<div id = "contactHistoryFilterPnlId" class="filterPanel"/>').appendTo(rootPanel),this.searchPanel=$('<div id = "contactHistorySearchPnlId" class="searchPanel"/>').appendTo(rootPanel),$('<div class="modalDialogHeaderText textEllipsis" id = "contactHistoryHeaderId" />').text(IC_Localization.contactHistory).appendTo(this.headerPanel),this.closeBtn=$('<div role="button" aria-label = "'+IC_Localization.close+'" tabindex = "0"/>').attr("title",IC_Localization.close).appendTo(this.headerPanel),this.closeBtnIcon=$("<img/>").addClass("closeBtnIcon").attr("src",this.options.resourceBase+"/css/images/section-close.png").appendTo(this.closeBtn),this.closeBtn.on("click",$.proxy(this.closeBtnClick,this)),IC_Common.enterKeyPress(this.closeBtn,function(){that.closeBtnClick()}),IC_Common.setFocusToCloseIcon(this.closeBtn,this.closeBtnIcon,"closeBtnFocus","closeBtnIconFocus"),this.sortByDiv=$('<div class="sortByDiv btnDivEnable"/>').appendTo(this.sortPanel),this.sortByDiv.comboBox({onDataChange:$.proxy(this.onSortByChanged,this),resourceBase:this.options.resourceBase}),this.filterDiv=$('<div class="filterDiv btnDivEnable"/>').appendTo(this.filterPanel),this.filterDiv.comboBox({onDataChange:$.proxy(this.onFilterChanged,this),resourceBase:this.options.resourceBase}),searchBtnDiv=$('<div class="btnDiv"/>').appendTo(this.searchPanel).attr("title",IC_Localization.search),$('<img src="'+this.options.resourceBase+'/css/images/ap-filter-search.png" />').appendTo(searchBtnDiv),searchTxtDiv=$('<div class="txtDiv"/>').appendTo(this.searchPanel),this.searchTxtbox=$('<input type="text" id = "contactHistorySearchTxtboxId" class="txt watermark" title = "'+IC_Localization.search+" "+IC_Localization.contactHistory+'">').appendTo(searchTxtDiv),this.loadingDiv=$('<div class="loadingDiv"/>').appendTo(rootPanel),this.loadingIcn=$('<div class="icn"><div id = "loadingDivId" class="loadingTxt textEllipsis">'+IC_Localization.loading+"</div></div>").appendTo(this.loadingDiv),this.gridId=IC_Common.generateUniqueId("contactHistory"),this.contactHistoryGrid=$('<div id="'+this.gridId+'" ></div>').addClass("contactHistoryGrid").appendTo(rootPanel),$('<span class="dialogHidden">'+IC_Localization.end+" "+IC_Localization.contactHistory+"</span>").appendTo(parent)},_init:function(){this.localeDateFormat=this.options.container.options.localeDateFormat.replace("yy","yyyy"),this.localeDateTimeFormat=this.options.container.options.localeDateTimeFormat.replace("yy","yyyy");var sortByData=[{id:"Date",value:IC_Localization.date},{id:"PhoneNumber",value:IC_Localization.phoneNumber},{id:"SkillName",value:IC_Localization.skillName}],filterData=[{id:"Today",value:IC_Localization.today},{id:"ThisWeek",value:IC_Localization.thisWeek},{id:"DateRange",value:IC_Localization.dateRange}];this.sortByItem={id:"Date",value:IC_Localization.date},this.filterItem={id:"Today",value:IC_Localization.today},this.sortByDiv.comboBox("setStore",sortByData),this.filterDiv.comboBox("setStore",filterData),this.sortByDiv.comboBox("setSelectedItem",this.sortByItem),this.filterDiv.comboBox("setSelectedItem",this.filterItem),this.searchTxtbox.val(this.searchWatermark),this.searchTxtbox.on("keyup",$.proxy(this.onSearchTextChange,this)),this.searchTxtbox.on("focus",$.proxy(this.onSearchTextClick,this)),this.searchTxtbox.on("click",$.proxy(this.onSearchTextClick,this)),this.searchTxtbox.on("blur",$.proxy(this.onSearchTextBlur,this)),this.iconColWidth=25,this.options.container.isPopout?this.dataColWidth=333:this.dataColWidth=131,this._initGridColumn(),this._initGrid(),this._initDatePicker()},_initGridColumn:function(){var that=this,iconColWidth=this.iconColWidth,dataColWidth=this.dataColWidth;this.gridColumnModel=[{id:"media",field:"MediaName",name:"Contact Type",width:iconColWidth,sortable:!1,resizable:!1,formatter:function(row,col,value,columnDef,data){var mediaTypeCssClass,contactTypeDiv=$("<div />"),contactTypeImg=$('<div class="mediaType"/>');return 4===(data=data||that.gridData[row]).mediaType?!0===data.isOutbound&&IC_Validation.isNotNullOrUndefinedString(data.fromAddr)?mediaTypeCssClass="obPhone":!0===data.isOutbound&&IC_Validation.isNullOrEmpty(data.fromAddr)?mediaTypeCssClass="commitmentPhone":!1===data.isOutbound&&(mediaTypeCssClass="ibPhone"):6===data.mediaType?mediaTypeCssClass=(!0===data.isOutbound?"ob":"ib")+"Wi":3===data.mediaType?mediaTypeCssClass="chat":1===data.mediaType?mediaTypeCssClass="email":5===data.mediaType&&(mediaTypeCssClass="vmail"),contactTypeImg.addClass(mediaTypeCssClass),contactTypeImg.appendTo(contactTypeDiv),contactTypeDiv.html()}},{id:"data",field:"data",name:"Contact Info",width:dataColWidth,sortable:!0,resizable:!1,formatter:function(row,col,value,columnDef,data){var infoDiv=$('<div class="infoCol"/>'),infoLine1Div=$('<div id = "infoLine1DivId" class="line1"/>').appendTo(infoDiv),infoLine2Div=$('<div id = "infoLine2DivId" class="line2"/>').appendTo(infoDiv),infoLine3Div=$('<div id = "infoLine3DivId" class="line3"/>').appendTo(infoDiv);return infoLine4Div=$('<div id = "infoLine4DivId" class="line4"/>').appendTo(infoDiv),data=data||that.gridData[row],"Date"===that.sortByItem.id?(IC_Common.setTextWithEllipsis(infoLine1Div,data.date,130),IC_Common.setTextWithEllipsis(infoLine2Div,data.phone,130),IC_Common.setTextWithEllipsis(infoLine3Div,data.skillName,130),IC_Common.setTextWithEllipsis(infoLine4Div,data.durationInsecondsToTime,130)):"PhoneNumber"===that.sortByItem.id?(IC_Common.setTextWithEllipsis(infoLine1Div,data.phone,130),IC_Common.setTextWithEllipsis(infoLine2Div,data.date,130),IC_Common.setTextWithEllipsis(infoLine3Div,data.skillName,130),IC_Common.setTextWithEllipsis(infoLine4Div,data.durationInsecondsToTime,130)):(IC_Common.setTextWithEllipsis(infoLine1Div,data.skillName,130),IC_Common.setTextWithEllipsis(infoLine2Div,data.date,130),IC_Common.setTextWithEllipsis(infoLine3Div,data.phone,130),IC_Common.setTextWithEllipsis(infoLine4Div,data.durationInsecondsToTime,130)),infoDiv.html()}}]},_initGrid:function(){var that=this;this.dataView=new Slick.Data.DataView,this.grid=new Slick.Grid("#"+this.gridId,this.dataView,this.gridColumnModel,{rowHeight:68,enableColumnReorder:!1}),this.dataView.onRowCountChanged.subscribe(function(e,args){that.grid.updateRowCount(),that.grid.render()}),this.dataView.onRowsChanged.subscribe(function(e,args){that.grid.invalidateRows(args.rows),that.grid.render()}),this.grid.onCellChange.subscribe(function(e,args){this.dataView.updateItem(args.item.id,args.item)}),this.grid.onMouseLeave.subscribe($.proxy(this.onGridRowMouseLeave,this)),this.grid.onMouseEnter.subscribe($.proxy(this.onGridRowMouseEnter,this)),this.grid.onClick.subscribe($.proxy(this.onGridRowClick,this)),this.columnBorderDiv=$("<div ></div>").addClass("columnBorderDiv"),$("<div></div>").addClass("border1").appendTo(this.columnBorderDiv),$(".contactHistory .slick-viewport").append(this.columnBorderDiv)},_initDatePicker:function(){var dpTitle,startDateDiv,dpStartDateLbl,endDateDiv,dpEndDateLbl,dpDoneBtn,today=new Date,that=this;this.datepickerDlg=$('<div class="datepickerDlg"/>').appendTo("#"+this.containerId),this.dpPopup=$('<div id = "dpPopupId" class="popup"/>').appendTo(this.datepickerDlg),dpTitle=$('<div id = "dpTitleId" class="title textEllipsis"/>').appendTo(this.dpPopup),startDateDiv=$('<div id = "startDateDivId" class="startDateDiv"/>').appendTo(this.dpPopup),dpStartDateLbl=$('<div class="startDateLbl textEllipsis" />').appendTo(startDateDiv),this.dpStartDateTxt=$('<div id = "dpStartDateTxtId" class="startDateTxt" />').appendTo(startDateDiv),this.dpStartDateCal=$('<div class="startDateCal" />').appendTo(this.dpPopup),endDateDiv=$('<div id = "endDateDivId" class="endDateDiv"/>').appendTo(this.dpPopup),dpEndDateLbl=$('<div class="endDateLbl textEllipsis" />').appendTo(endDateDiv),this.dpEndDateTxt=$('<div id = "dpEndDateTxtId" class="endDateTxt" />').appendTo(endDateDiv),this.dpEndDateCal=$('<div class="endDateCal" />').appendTo(this.dpPopup),dpDoneBtn=$('<input  id = "dpDoneBtn" class="btnDone" type="button" value="'+IC_Localization.done+'" title="'+IC_Localization.done+'"/>').appendTo(this.dpPopup),AgentConsoleLocale.setLocaleFormat(this.options.container.options.localeCode,"date"),this.dpStartDateCal.datepicker({changeMonth:!0,changeYear:!0,numberOfMonths:1,maxDate:"+0d",onSelect:function(selectedDate){that.dpEndDateCal.datepicker("option","minDate",selectedDate);var sdt=that.dpStartDateCal.datepicker("getDate");that.startDate=IC_Common.toShortDateString(sdt);var edt=that.dpEndDateCal.datepicker("getDate");that.endDate=IC_Common.toShortDateString(edt),that.dpEndDateTxt.text(edt.format(that.localeDateFormat)),that.dpStartDateTxt.text(sdt.format(that.localeDateFormat))}}),this.dpEndDateCal.datepicker({changeMonth:!0,changeYear:!0,numberOfMonths:1,maxDate:"+0d",onSelect:function(selectedDate){that.dpStartDateCal.datepicker("option","maxDate",selectedDate);var sdt=that.dpStartDateCal.datepicker("getDate");that.startDate=IC_Common.toShortDateString(sdt);var edt=that.dpEndDateCal.datepicker("getDate");that.endDate=IC_Common.toShortDateString(edt),that.dpEndDateTxt.text(edt.format(that.localeDateFormat)),that.dpStartDateTxt.text(sdt.format(that.localeDateFormat))}}),dpTitle.text(IC_Localization.selectDateRange).attr("title",IC_Localization.selectDateRange),dpStartDateLbl.text(IC_Localization.startDate+":").attr("title",IC_Localization.startDate),dpEndDateLbl.text(IC_Localization.endDate+":").attr("title",IC_Localization.endDate),that.endDate=IC_Common.toShortDateString(today),that.startDate=IC_Common.toShortDateString(today),this.dpStartDateTxt.text(today.format(this.localeDateFormat)),this.dpEndDateTxt.text(today.format(this.localeDateFormat)),dpDoneBtn.on("click",$.proxy(this.onDateRangePickerClose,this))},closeBtnClick:function(){this.options.container.closeContactHistoryAndShowHome(),IC_Common.removeFocusFromCloseIcon(this.closeBtnIcon,"closeBtnIconFocus")},onSortByChanged:function(){this.loadingDiv.fadeIn(500),this.loadingDiv.css("height",this.gridScrollHeight+"px"),this.sortByItem=this.sortByDiv.comboBox("getSelectedItem"),this.filterAndSortData(),this.persistContactHistoryFilterData(),this.updateGridView()},onFilterChanged:function(){this.loadingDiv.fadeIn(500),this.loadingDiv.css("height",this.gridScrollHeight+"px"),this.filterItem=this.filterDiv.comboBox("getSelectedItem"),"DateRange"===this.filterItem.id?this.datepickerDlg.showfn():(this.persistContactHistoryFilterData(),this.getContactHistory())},onDateRangePickerClose:function(){var startDate=this.dpStartDateCal.datepicker("getDate"),endDate=this.dpEndDateCal.datepicker("getDate");this.filterItem={id:"DateRange",value:startDate.format(this.localeDateFormat)+" - "+endDate.format(this.localeDateFormat)},this.filterDiv.comboBox("setSelectedItem",this.filterItem),this.datepickerDlg.hide(),this.getContactHistory(),this.persistContactHistoryFilterData()},onSearchTextClick:function(){this.searchTxtbox.val()==this.searchWatermark&&(this.searchTxtbox.val(""),this.searchTxtbox.removeClass("watermark"))},onSearchTextBlur:function(){var search=this.searchTxtbox.val();IC_Validation.isNotNull(search)||(this.searchTxtbox.val(this.searchWatermark),this.searchTxtbox.addClass("watermark"))},onSearchTextChange:function(){var search=this.searchTxtbox.val();this.searchText=search===this.searchWatermark?"":search.toLowerCase(),this.filterAndSortData(),this.persistContactHistoryFilterData(),this.updateGridView()},onGridRowMouseEnter:function(e,args){var contactType=this.options.container.contactType;"EmailContactEvent"!==contactType&&"VoiceMailContactEvent"!==contactType&&"ChatContactEvent"!==contactType&&"WorkItemContactEvent"!==contactType||($(".obPhone").removeClass("obPhone").addClass("obPhoneRemovePointer"),$(".ibPhone").removeClass("ibPhone").addClass("ibPhoneRemovePointer"))},onGridRowMouseLeave:function(e,args){var contactType=this.options.container.contactType;"EmailContactEvent"!==contactType&&"VoiceMailContactEvent"!==contactType&&"ChatContactEvent"!==contactType&&"WorkItemContactEvent"!==contactType||($(".obPhoneRemovePointer").removeClass("obPhoneRemovePointer").addClass("obPhone"),$(".ibPhoneRemovePointer").removeClass("ibPhoneRemovePointer").addClass("ibPhone"))},onGridRowClick:function(e,args){var iconDOM,phNumber,icoDiv=e.target,row=args.row,contactType=this.options.container.contactType;if("EmailContactEvent"===contactType||"VoiceMailContactEvent"===contactType||"ChatContactEvent"===contactType||"WorkItemContactEvent"===contactType)return!1;IC_Validation.isNotNull(icoDiv)&&((iconDOM=$(icoDiv)).hasClass("ibPhone")||iconDOM.hasClass("obPhone")||iconDOM.hasClass("commitmentPhone"))&&this.options.container.isMaxConferenceLimitNotReached()&&(phNumber=this.gridData[row].phone,this.options.container.ValidatePhoneNumber(phNumber),this.options.container.dialPhoneNumber(phNumber,e.clientX,e.clientY))},updateMetaData:function(allSkillList){allSkillList&&(this.allSkills=allSkillList)},setVisibility:function(visibility){this.loadingDiv.fadeIn(500),this.loadingDiv.css("height",this.gridScrollHeight+"px"),!0===visibility?this.getContactHistory():"block"===this.datepickerDlg.css("display")&&this.datepickerDlg.hide()},resizeWidget:function(width,height){var gridHeight,marginleft,totGridWidth;gridHeight=height-120,this.gridScrollHeight=gridHeight,$(".agentConsolePopout .contactHistory .searchPanel .txtDiv").css("width",this.contactHistoryGrid.width()-30+"px"),this.searchTxtbox.css("width",this.contactHistoryGrid.width()-32+"px"),this.contactHistoryGrid.css("height",gridHeight+"px"),this.datepickerDlg.css({width:width,height:height+5}),totGridWidth=this.contactHistoryGrid.width(),this.dataColWidth=totGridWidth-this.iconColWidth,this.loadingDiv.css({width:totGridWidth,height:gridHeight}),$(".agentConsolePopout .contactHistory .columnBorderDiv").css({width:totGridWidth+"px"}),(marginleft=(width-374)/2)>=16&&this.dpPopup.css({"margin-left":marginleft+"px"}),this._initGridColumn(),this.updateGridView(),$(".agentConsolePopout .contactHistory .searchPanel .txtDiv").css("width",this.contactHistoryGrid.width()-30+"px"),this.searchTxtbox.css("width",this.contactHistoryGrid.width()-32+"px")},updateGridView:function(){this.grid.setColumns(this.gridColumnModel),this.dataView.beginUpdate(),this.dataView.setItems(this.gridData),this.dataView.endUpdate(),this.gridData.length<=4&&$(".contactHistory .grid-canvas").css({height:this.gridScrollHeight+"px"}),this.columnBorderDiv.css({height:this.gridScrollHeight+"px"}),this.loadingDiv.fadeOut(500),$(".contactHistory .slick-viewport").css({height:this.gridScrollHeight+"px"})},persistContactHistoryFilterData:function(type,Object){var filterItem={id:this.filterItem.id,startDt:this.dpStartDateCal.datepicker("getDate"),endDt:this.dpEndDateCal.datepicker("getDate")},sortByItem=this.sortByItem,search=this.searchText;this.options.container.persistContactHistoryFilterData(sortByItem,filterItem,search)},updateMetaFilterData:function(sortByItem,filterItem,searchText){var filter;(this.searchText!==searchText&&(IC_Validation.isNullOrEmpty(searchText)?(this.searchTxtbox.val(this.searchWatermark),this.searchTxtbox.addClass("watermark"),this.searchText=this.searchWatermark):(this.searchTxtbox.val(searchText),this.searchTxtbox.removeClass("watermark"),this.searchText=searchText),this.filterAndSortData(),this.updateGridView()),this.isChanged(this.filterItem,filterItem))&&("DateRange"===filterItem.id?(this.startDate=filterItem.startDt,this.endDate=filterItem.endDt,this.dpStartDateCal.datepicker("setDate",this.startDate),this.dpEndDateCal.datepicker("setDate",this.endDate),filter={id:"DateRange",value:new Date(this.startDate).format(this.localeDateFormat)+" - "+new Date(this.endDate).format(this.localeDateFormat)}):"Today"===filterItem.id?filter={id:"Today",value:IC_Localization.today}:"ThisWeek"===filterItem.id&&(filter={id:"ThisWeek",value:IC_Localization.thisWeek}),this.filterItem=filter,this.filterDiv.comboBox("setSelectedItem",this.filterItem),"block"===this.element.css("display")&&this.getContactHistory());if(this.isChanged(this.sortByItem,sortByItem)){var val={Date:IC_Localization.date,PhoneNumber:IC_Localization.phoneNumber,SkillName:IC_Localization.skillName};val.hasOwnProperty(sortByItem.id)&&(sortByItem.value=val[sortByItem.id]),this.sortByItem=sortByItem,this.sortByDiv.comboBox("setSelectedItem",this.sortByItem),this.filterAndSortData(),this.updateGridView()}},isChanged:function(o1,o2){return JSON.stringify(o1)!==JSON.stringify(o2)},filterAndSortData:function(){var apiObj,skill,cObj,contactLen=this.contactStates.length,i=0;for(this.gridData&&delete this.gridData,this.gridData=[],i=0;i<contactLen;i++)apiObj=this.contactStates[i],skill=this.allSkills[apiObj.skillId],(cObj={id:apiObj.contactId,mediaType:IC_Common.toNumber(apiObj.mediaTypeId),mediaName:apiObj.mediaTypeName,skillId:apiObj.skillId,skillName:apiObj.skillName,startDate:new Date(apiObj.contactStartDate),lastUpdateTime:new Date(apiObj.lastUpdateTime),date:IC_Common.getAMPMLocale(new Date(apiObj.contactStartDate).format(this.localeDateTimeFormat),this.options.container.options.localeCode),durationInsecondsToTime:IC_Common.secondsToTime(parseInt(Math.floor((new Date(apiObj.lastUpdateTime).getTime()-new Date(apiObj.contactStartDate).getTime())/1e3))),fromAddr:apiObj.fromAddr}).isOutbound=!1,skill&&(cObj.isOutbound=skill.isOutbound),4===cObj.mediaType?cObj.phone=!0===cObj.isOutbound?apiObj.toAddr:apiObj.fromAddr:6===cObj.mediaType?cObj.phone=apiObj.fromAddr:5===cObj.mediaType&&(cObj.phone=apiObj.fromAddr),this.isMatchFound(cObj)&&this.gridData.push(cObj);this.gridData.sort($.proxy(this.compare,this))},getContactHistory:function(){var from,to,that=this,today=new Date;"Today"===this.filterItem.id?(from=new Date(today.getFullYear(),today.getMonth(),today.getDate(),0,0,0),to=new Date(today.getFullYear(),today.getMonth(),today.getDate(),23,59,59)):"ThisWeek"===this.filterItem.id?(from=IC_Common.getMonday(new Date(today.getFullYear(),today.getMonth(),today.getDate(),0,0,0)),to=new Date(today.getFullYear(),today.getMonth(),today.getDate(),23,59,59)):(from=new Date(this.startDate),to=new Date(this.endDate),from=new Date(from.getFullYear(),from.getMonth(),from.getDate(),0,0,0),to=new Date(to.getFullYear(),to.getMonth(),to.getDate(),23,59,59)),from=IC_Common.toISODateString(from),to=IC_Common.toISODateString(to),this.options.container.getContactHistory(from,to,function(data){that.contactStates=data,that.filterAndSortData(),that.updateGridView()})},isMatchFound:function(contact){var phoneNumber,matchFound=!0;return phoneNumber=this.searchText.replace(/[^a-zA-Z0-9]/g,""),IC_Validation.isNotNullOrEmpty(this.searchText)&&(matchFound=-1!==contact.skillName.toLowerCase().indexOf(this.searchText)||-1!==contact.date.toLowerCase().indexOf(this.searchText)||IC_Validation.isNotNullOrUndefinedString(phoneNumber)&&IC_Validation.isNotNullOrUndefinedString(contact.phone)&&-1!==contact.phone.toLowerCase().indexOf(phoneNumber)),matchFound},compare:function(data1,data2){var val1,val2,sortCol=this.sortByItem.id,sortDir=1;return"Date"===sortCol?(sortDir=-1,val1=data1.startDate,val2=data2.startDate):"PhoneNumber"===sortCol?(sortDir=-1,val1=data1.phone,val2=data2.phone):(val1=data1.skillName,val2=data2.skillName),sortDir*(val1==val2?0:val1>val2?1:-1)},updatePanelHeight:function(height){var sortPnlHt=this.sortPanel.outerHeight(),filterPnlHt=this.filterPanel.outerHeight(),searchPnlHt=this.searchPanel.outerHeight();this.gridScrollHeight=height-(sortPnlHt+filterPnlHt+searchPnlHt+10),this.contactHistoryGrid.css("height",this.gridScrollHeight+"px")},setFocusToContactHistoryHeader:function(){this.headerPanel.trigger("focus")}})}(jQuery);