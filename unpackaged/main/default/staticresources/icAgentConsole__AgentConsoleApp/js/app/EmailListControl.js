!function($){IC_Common.getLogger("EmailListControl");$.widget("AgentConsole.emailListControl",{options:{container:null,resourceBase:"",isPopout:!1,emailWidget:""},emailSortOrder:1,searchKeyStroke:null,sortOptions:[],selectedParkedEmails:[],sortedparkedEmails:[],currentContact:null,renderedHeight:0,_create:function(){var parent=this.element,defaultSearchText=IC_Localization.search+" ...";this.resourceBase=this.options.resourceBase,this.emailWidgetName=this.options.emailWidget,this.sortOptions=[{id:"0",value:IC_Localization.dateTimeAsc,condition:"Asc"},{id:"1",value:IC_Localization.dateTimeDesc,condition:"Desc"}],parent.addClass("EmailSidebarDiv"),this.emailFilterPanel=$("<div class='emailFilterPanel'>").appendTo(parent),this.emailSortOrderCombo=$("<div/>").addClass("emailSortOrderCombo").appendTo(this.emailFilterPanel),this.emailSortOrderCombo.comboBox({onDataChange:$.proxy(this.sortParkedList,this),resourceBase:this.options.resourceBase}),this.emailSortOrderCombo.comboBox("setStore",this.sortOptions),this.emailSortOrderCombo.comboBox("setSelectedItem",this.sortOptions[1]),this.emailSearchContainer=$("<div class='searchPanel'>").appendTo(this.emailFilterPanel),this.emailSearch=$('<input class="emailSearch" title="'+IC_Localization.search+'" placeholder="'+defaultSearchText+'" onfocus="this.placeholder=\'\'" onblur="this.placeholder=\''+defaultSearchText+"'\"/>").appendTo(this.emailSearchContainer),this.emailSearch.on("keyup",$.proxy(this.searchAllEmailFilter,this)),this.contactsContainer=$("<div id='emailContactsHolder'>").appendTo(parent),this.workingHeaderDiv=$("<div class='bgBodyGradient cStatePanel HeaderDiv' id='emailWorkingHeaderId'>").appendTo(this.contactsContainer),this.workingDesc=$("<div class='stateDesc textEllipsis'></div>").appendTo(this.workingHeaderDiv).text(IC_Localization.working+"(0)"),this.workingArrow=$("<div class='ddIcon arrow-right' id='workingArrowId'>").appendTo(this.workingHeaderDiv),this.workingContentDiv=$("<div class='ContentDiv' id='workingContentId'>").appendTo(this.contactsContainer),this.outboundHeaderDiv=$("<div class='bgBodyGradient cStatePanel HeaderDiv' id='emailOutboundHeaderId'>").appendTo(this.contactsContainer),this.outboundDesc=$("<div class='stateDesc textEllipsis'></div>").appendTo(this.outboundHeaderDiv).text(IC_Localization.outbound+"(0)"),this.outboundArrow=$("<div class='ddIcon arrow-right' id='outboundArrowId'>").appendTo(this.outboundHeaderDiv),this.outboundContentDiv=$("<div class='ContentDiv' id='outboundContentId'>").appendTo(this.contactsContainer),this.parkedHeaderDiv=$("<div class='bgBodyGradient cStatePanel parkedcStatePanel HeaderDiv' id='emailParkedHeaderId'>").appendTo(this.contactsContainer),this.parkedDesc=$("<div class='stateDesc textEllipsis'></div>").appendTo(this.parkedHeaderDiv).text(IC_Localization.parked+"(0)"),this.parkedArrow=$("<div class='ddIcon arrow-right' id='parkedArrowId'>").appendTo(this.parkedHeaderDiv),this.parkedContentDiv=$("<div class='ContentDiv' id='parkedContentId'>").appendTo(this.contactsContainer)},onMouseHover:function(targetElement,event){targetElement.children().length?(targetElement.removeClass("bgBodyGradient"),targetElement.addClass("HeaderDivHover")):targetElement.removeClass("HeaderDiv")},onMouseLeave:function(targetElement,event){targetElement.children().length?(targetElement.removeClass("HeaderDivHover"),targetElement.addClass("bgBodyGradient")):targetElement.removeClass("HeaderDiv")},onAccordionClick:function(element,arrow,event){"block"===element.css("display")?this.closeAccordian(element,arrow):this.openAccordian(element,arrow)},closeAccordian:function(element,arrow){element.slideUp({easing:"easeInOutQuart"}),arrow.removeClass("arrow-down").addClass("arrow-right")},openAccordian:function(element,arrow){element.slideDown({easing:"easeInOutQuart"}),arrow.removeClass("arrow-right").addClass("arrow-down")},searchAllEmailFilter:function(){var allContactWidgets=$.extend({},this.options.container.activeContactWidgets,this.options.container.parkedContactWidgets),searchStr=this.emailSearch.val(),that=this;IC_Validation.isNotNullOrUndefinedString(this.dumpRenderHTML)||(this.dumpRenderHTML=$('<div style="position:absolute;display:none !important;" />').appendTo(this.element)),searchStr=searchStr.toLocaleLowerCase(),IC_Validation.isNotNullOrUndefinedString(this.searchKeyStroke)&&clearTimeout(this.searchKeyStroke);var emailContacts=AgentConsoleDataStore.getContacts(function(contact){return"EmailContactEvent"===contact.contactType});this.searchKeyStroke=setTimeout(function(){var matchedwidgets=[];for(var id in allContactWidgets)allContactWidgets.hasOwnProperty(id)&&-1!==emailContacts.indexOfKey("id",id)&&allContactWidgets[id][that.emailWidgetName]("search",searchStr)&&matchedwidgets.push(allContactWidgets[id]);that.options.isPopout&&(matchedwidgets.length>0?matchedwidgets[0][that.emailWidgetName]("statePnlClick",{}):that.options.container.elements.emailPopoutContentPanel.emailDetailPopoutControl("clearPreviewContent"))},100)},onEmailContactUpdate:function(contact){var emailWidget=null;if("Parked"===(contact=this.options.container.addContactMetaData(contact)).status){if(this.options.container.forceDestroyPersonalQueueParkedEmail(this.options.container.activeContactWidgets,contact.contactId),this.updateContactsCount(),this.options.container.parkedContactWidgets.hasOwnProperty(contact.contactId))this.options.container.parkedContactWidgets[contact.contactId][this.emailWidgetName]("refresh",contact);return null!=this.currentContact&&this.currentContact.contactId==contact.contactId&&this.selectEmailWidget(this.options.container.parkedContactWidgets),void this.resizeScrollBar()}this.options.container.activeContactWidgets.hasOwnProperty(contact.contactId)?(emailWidget=this.options.container.activeContactWidgets[contact.contactId])[this.emailWidgetName]("refresh",contact):"Discarded"==contact.status&&1==contact.finalState||(emailWidget=this.createEmailWidget(contact),this.options.container.activeContactWidgets[contact.contactId]=emailWidget,!0===contact.isInbound?emailWidget.appendTo(this.workingContentDiv):emailWidget.appendTo(this.outboundContentDiv),emailWidget[this.emailWidgetName]("refresh",contact),this.emailWidgetClick(contact,{})),this.updateContactsCount(),"Discarded"===contact.status&&1==contact.finalState&&(this.options.container.destroyContactWidget(contact),null!=this.currentContact&&this.currentContact.contactId==contact.contactId&&(this.currentContact=null)),this.renderCustomScrollBar(this.contactsContainer)},resizeScrollBar:function(){this.renderCustomScrollBar(this.contactsContainer)},updateContactsCount:function(){var IBEmailContactsCount,ObEmailContactsCount;IBEmailContactsCount=this.refreshAccordian(function(contact){return"EmailContactEvent"===contact.contactType&&1==contact.isInbound&&0==contact.finalState},this.workingContentDiv,this.workingContentDiv,this.workingHeaderDiv),ObEmailContactsCount=this.refreshAccordian(function(contact){return"EmailContactEvent"===contact.contactType&&0==contact.isInbound&&0==contact.finalState},this.outboundContentDiv,this.outboundArrow,this.outboundHeaderDiv),this.workingDesc.text(IC_Localization.working+"("+IBEmailContactsCount+")"),this.outboundDesc.text(IC_Localization.outbound+"("+ObEmailContactsCount+")")},createEmailWidget:function(contact){this.options.container.onNewContactWidgetCreated(contact);var emailWidget=$('<div class="ContactRootPnl"/>')[this.emailWidgetName]({controller:this.options.container,resourceBase:this.options.resourceBase,isPopout:this.options.isPopout,contact:contact,emailWidgetClick:$.proxy(this.emailWidgetClick,this)});return this.options.container.contactType="Parked"!==contact.status?contact.contactType:null,emailWidget},emailWidgetClick:function(contact,event){if(this.options.isPopout){if("Parked"!=contact.status&&this.resetAllSelection(),event.shiftKey)if(0==this.selectedParkedEmails.length)this.selectParkedEmail(contact);else{var startIndex=this.sortedparkedEmails.indexOfKey("contactId",this.selectedParkedEmails[0].contactId),endIndex=this.sortedparkedEmails.indexOfKey("contactId",contact.contactId);if(startIndex==endIndex||-1==startIndex)this.resetAllSelection(),this.selectParkedEmail(contact);else{var firstSelectedContact=this.selectedParkedEmails[0];if(this.resetAllSelection(),this.selectedParkedEmails.push(firstSelectedContact),startIndex>endIndex)for(var i=startIndex;i>=endIndex;i--)this.selectParkedEmail(this.sortedparkedEmails[i]);for(i=startIndex;i<=endIndex;i++)this.selectParkedEmail(this.sortedparkedEmails[i])}}else event.ctrlKey?-1==this.selectedParkedEmails.indexOfKey("contactId",contact.contactId)?this.selectParkedEmail(contact):1!=this.selectedParkedEmails.length&&this.unSelectParkedEmail(contact):(this.resetAllSelection(),this.selectParkedEmail(contact));this.onSelectedEmailsChanged(contact)}},onSelectedEmailsChanged:function(contact){this.options.container.onSelectedEmailsChanged(contact,this.selectedParkedEmails),this.currentContact=this.selectedParkedEmails.length<=1?contact:null},getSelectedParkedEmails:function(){return this.selectedParkedEmails},resetAllSelection:function(){var allEmailContacts=this.options.container.parkedContactWidgets;for(var id in allEmailContacts)allEmailContacts.hasOwnProperty(id)&&allEmailContacts[id][this.emailWidgetName]("resetSelectedMode");this.selectedParkedEmails=[]},selectParkedEmail:function(contact){var contactId=contact.contactId,parkedWidgets=this.options.container.parkedContactWidgets;parkedWidgets.hasOwnProperty(contactId)&&(parkedWidgets[contactId][this.emailWidgetName]("setSelectedMode"),-1==this.selectedParkedEmails.indexOfKey("contactId",contactId)&&this.selectedParkedEmails.push(contact))},unSelectParkedEmail:function(contact){var contactId=contact.contactId,parkedWidgets=this.options.container.parkedContactWidgets,index=this.selectedParkedEmails.indexOf(contact);-1!=index&&(parkedWidgets.hasOwnProperty(contactId)&&parkedWidgets[contactId][this.emailWidgetName]("resetSelectedMode"),this.selectedParkedEmails.splice(index,1))},onParkedContactUpdate:function(contacts){for(var parkedEmailWidget=null,contact=null,i=0,length=contacts.length;i<length;i++)contact=contacts[i],this.options.container.parkedContactWidgets.hasOwnProperty(contact.contactId)?parkedEmailWidget=this.options.container.parkedContactWidgets[contact.contactId]:(parkedEmailWidget=this.createEmailWidget(contact),this.options.container.parkedContactWidgets[contact.contactId]=parkedEmailWidget),parkedEmailWidget.appendTo(this.parkedContentDiv),parkedEmailWidget[this.emailWidgetName]("refresh",contact);var parkedContactsCount=contacts.length;this.setAccordianContactsCount(parkedContactsCount,this.parkedContentDiv,this.parkedArrow,this.parkedHeaderDiv),this.parkedDesc.text(IC_Localization.parked+"("+parkedContactsCount+")"),this.sortParkedList(),this.renderCustomScrollBar(this.contactsContainer)},updateControlPanel:function(){for(var parkedList,parkedEmailList=AgentConsoleDataStore.parkedEmailList,parkedContactWidgets=this.options.container.parkedContactWidgets,contact=null,i=0,length=(parkedList=$.grep(parkedEmailList,function(item){return item.targetAgentId!=AgentConsoleDataStore.agentInfo.id})).length;i<length;i++)contact=parkedList[i],IC_Validation.isValidObject(contact)&&"1"===contact.mediaType&&parkedContactWidgets.hasOwnProperty(contact.contactId)&&parkedContactWidgets[contact.contactId][this.emailWidgetName]("updateControlPanel")},isTagsAssigned:function(skillId){return this.options.container.isTagsAssigned(skillId)},refreshAccordian:function(predicate,element,arrow,header){var contactsCount=0;return AgentConsoleDataStore.filterContacts(predicate,function(contacts){contactsCount=contacts.length},function(){}),this.setAccordianContactsCount(contactsCount,element,arrow,header),contactsCount},setAccordianContactsCount:function(contactsLength,element,arrow,header){contactsLength?(this.openAccordian(element,arrow),header.off("click").off("mouseenter mouseleave").css({opacity:1,cursor:"pointer"}).on("click",$.proxy(this.onAccordionClick,this,element,arrow)).hoverfn($.proxy(this.onMouseHover,this,header),$.proxy(this.onMouseLeave,this,header))):(this.closeAccordian(element,arrow),header.off("click").off("mouseenter mouseleave").css({opacity:.5,cursor:"default"}))},refreshParkedAccordianCount:function(count){this.setAccordianContactsCount(count,this.parkedContentDiv,this.parkedArrow,this.parkedHeaderDiv)},sortParkedList:function(){this.sortedparkedEmails=$.extend([],this.options.container.noQueueParkedEmailList),comboSortStore=[],sortOrder=parseInt(this.emailSortOrderCombo.comboBox("getSelectedItem").id),this.emailSortOrder=sortOrder,comboSortStore=[this.sortOptions[0===sortOrder?1:0]],this.emailSortOrderCombo.comboBox("setStore",comboSortStore),this.sortedparkedEmails.sort(function(a,b){var firstTime=new Date(a.lastStateTime).getTime(),secondTime=new Date(b.lastStateTime).getTime();return 0==sortOrder?firstTime>secondTime:secondTime>firstTime});for(var contactId,parkedContactWidgets=this.options.container.parkedContactWidgets,i=0,length=this.sortedparkedEmails.length;i<length;i++)contactId=this.sortedparkedEmails[i].contactId,parkedContactWidgets.hasOwnProperty(contactId)&&parkedContactWidgets[contactId].insertAt(i,this.parkedContentDiv)},renderCustomScrollBar:function(element){if(!this.options.isPopout){var contentPanelHeight=this.options.container.getContentPanelHeight();element.css({height:contentPanelHeight-159+"px"})}element.mCustomScrollbar("destroy"),element.mCustomScrollbar({scrollButtons:{enable:!0},advanced:{autoScrollOnFocus:!1,updateOnContentResize:!0},scrollInertia:0})},onWidgetRemove:function(contactId){null!=this.currentContact&&this.currentContact.contactId==contactId&&(this.currentContact=null,this.selectEmailTabContact())},selectEmailTabContact:function(){this.resetAllSelection(),AgentConsoleDataStore.filterContacts(function(contact){return"EmailContactEvent"==contact.contactType&&1!=contact.finalState},$.proxy(this.selectNonParkedEmailContact,this),$.proxy(this.selectParkedEmailContact,this))},selectParkedEmailContact:function(){this.selectEmailWidget(this.options.container.parkedContactWidgets)},selectNonParkedEmailContact:function(){this.selectEmailWidget(this.options.container.activeContactWidgets)},selectEmailWidget:function(widgets){var contactId;Object.keys(widgets).length>0&&(contactId=null!=this.currentContact?this.currentContact.contactId:Object.keys(widgets)[0],widgets.hasOwnProperty(contactId)&&widgets[contactId][this.emailWidgetName]("statePnlClick",{}))},resize:function(availableHeight,availableWidth){var panelHeight=availableHeight-this.emailFilterPanel.height();this.renderedHeight!=panelHeight&&(this.renderedHeight=panelHeight,this.contactsContainer.height(this.renderedHeight),this.renderCustomScrollBar(this.contactsContainer))}})}(jQuery);