!function($){var logger=IC_Common.getLogger("SFLightning");AgentConsoleSalesforce={isConsole:!1,isLightning:!0,icCustomSearchApex:"inContactControlledSearch",onClickToDial:!1,softPhoneLayoutSettings:null,pageInfo:null,staticResource:null,cx1Window:null,sfRunApexError:"Your session is invalid or an error occurred. Refresh the page and try again, or ask your Salesforce admin for help.",queryParams:IC_Common.parseQueryString(window.location.search),isOpenCti:!0,init:function(args){this.staticResource=args.resourceBase,IC_Validation.isNotNull(args.namespace)&&(this.icCustomSearchApex=args.namespace+".inContactControlledSearch"),this.isOpenCti=IC_Validation.isNotNullOrEmpty(this.queryParams.sfdcIFrameOrigin)&&IC_Validation.isNotNullOrEmpty(this.queryParams.nonce)&&IC_Validation.isNullOrEmpty(this.queryParams.sfdcIFrameHost)},setSoftphonePanelLayout:function(height,width){if(logger.debug("setSoftphonePanelLayout - height: "+height+" width: "+width),width=parseInt(width),0!=(height=parseInt(height))&&0!=width){sforce.opencti.setSoftphonePanelWidth({widthPX:width,callback:function(response){logger.debug("setSoftphonePanelWidth <<< success: "+response.success),response.success||logger.debug("setSoftphonePanelWidth <<< errors: "+response.errors)}}),sforce.opencti.setSoftphonePanelHeight({heightPX:height,callback:function(response){logger.debug("setSoftphonePanelHeight <<< success: "+response.success),response.success||logger.error("setSoftphonePanelHeight <<< errors: "+response.errors)}})}},getCallCenterSettings:function(callback){var that=this,getCCCallback=function(response){var settings={};try{IC_Validation.isNotNullOrEmpty(response.result)?settings=that.formCallCenterSettingsInfo(response.result):(settings.error=response.error,logger.error("getCallCenterSettings - "+response.error)),callback(settings)}catch(e){callback({error:"Error processing getCallCenterSettings"}),logger.fatal("getCallCenterSettings - ",e)}};if(!0===this.isOpenCti)sforce.opencti.getCallCenterSettings({callback:getCCCallback});else{var settings={},url=window.location.protocol+"//"+window.location.host+"/_ui/cti/callcenter/CallCenterSettingsServlet";logger.debug("getCallCenterSettings url -"+url),IC_Ajax.xmlHttpRequest("get",url,null,null,function(response){var data=response.substr(10);settings=eval("("+data+")"),settings=that.formCallCenterSettingsInfo(settings.getCallCenterSettings),callback(settings)},function(status,statusText,responseText){logger.error("getCallCenterSettings - status: "+status+"statusText :  "+statusText+" responseText : "+responseText),callback({error:"Error processing getCallCenterSettings"})},!0,null,null,"text")}},formCallCenterSettingsInfo:function(result){var responseObj=IC_Common.parseJSON(result),icAuthorizationUrl=IC_Validation.isNotNullOrEmpty(responseObj["/inContactSettings/icAuthorizationUrl"])?responseObj["/inContactSettings/icAuthorizationUrl"]:responseObj["/inContactSettings/inContactTokenServiceUri"],authMode=responseObj["/inContactSettings/authMode"],evolveAuthUrl=responseObj["/inContactSettings/evolveAuthUrl"],evolveNotificationUrl=responseObj["/inContactSettings/evolveNotificationUrl"],evolveWebServerUrl=responseObj["/inContactSettings/evolveWebServerUrl"],lightningHeight=responseObj["/reqGeneralInfo/reqSoftphoneLightningHeight"],lightningWidth=responseObj["/reqGeneralInfo/reqSoftphoneLightningWidth"],icCustomDomain=responseObj["/inContactSettings/icCustomDomain"],settings={result:{}};return IC_Validation.isNotNullOrEmpty(icAuthorizationUrl)&&(settings.result.icAuthorizationUrl=icAuthorizationUrl),IC_Validation.isNotNullOrEmpty(authMode)&&(settings.result.authMode=authMode),IC_Validation.isNotNullOrEmpty(evolveAuthUrl)&&(settings.result.evolveAuthUrl=evolveAuthUrl),IC_Validation.isNotNullOrEmpty(evolveNotificationUrl)&&(settings.result.evolveNotificationUrl=evolveNotificationUrl),IC_Validation.isNotNullOrEmpty(evolveWebServerUrl)&&(settings.result.evolveWebServerUrl=evolveWebServerUrl),IC_Validation.isNotNullOrEmpty(lightningHeight)&&(settings.result.lightningHeight=lightningHeight),IC_Validation.isNotNullOrEmpty(lightningWidth)&&(settings.result.lightningWidth=lightningWidth),IC_Validation.isNotNullOrEmpty(icCustomDomain)&&(settings.result.icCustomDomain=icCustomDomain),logger.debug("getCallCenterSettings - icAuthorizationUrl: "+settings.result.icAuthorizationUrl),settings},authenticate:function(authUrl,authMode,authCode,idpType,busNo,redirectUri,callback){var that=this;logger.trace("authenticate  >>>  url:"+authUrl+" authMode:"+authMode+" authCode:"+authCode+" idpType:"+idpType+" busNo:"+busNo+" redirectUri:"+redirectUri);!0===this.isOpenCti?sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"authenticate3",methodParams:"authUrl="+encodeURIComponent(authUrl)+"&authMode="+authMode+"&authCode="+encodeURIComponent(authCode)+"&idpType="+encodeURIComponent(idpType)+"&busNo="+encodeURIComponent(busNo)+"&redirectUri="+encodeURIComponent(redirectUri),callback:function(response){try{IC_Validation.isNullOrEmpty(response.errors)?(logger.debug("authenticate  <<<  result:"+JSON.stringify(response.returnValue)),IC_Validation.isNullOrEmpty(response.returnValue)?callback({error:"response null or empty"}):callback(IC_Common.parseJSON(response.returnValue.runApex))):(logger.error("authenticate  <<<  error: "+JSON.stringify(response.errors)),callback({error:"authenticate response error"}))}catch(error){logger.fatal("authenticate  <<<  exception: ",error),callback({error:"authenticate exception"})}}}):sforce.apex.execute(this.icCustomSearchApex,"authenticate3",{authUrl:authUrl,authMode:authMode,authCode:authCode,idpType:idpType,busNo:busNo,redirectUri:redirectUri},function(response){try{if(IC_Validation.isNotNullOrEmpty(response)){var responseObj=IC_Common.parseJSON(response);IC_Validation.isNullOrEmpty(responseObj.error)?(logger.debug("authenticate response : "+response),callback(responseObj)):responseObj.error==that.sfRunApexError?(logger.trace("SF session is invalid. Reloading the app."),window.location.reload()):(logger.error("authenticate <<< error: "+responseObj.error),callback({error:"authenticate response error "+responseObj.error}))}}catch(error){logger.fatal("authenticate <<< exception : ",error),callback({error:"authenticate exception"})}})},refreshToken:function(tokenUrl,authMode,token,callback){logger.trace("refreshToken >>> url:"+tokenUrl+" authMode:"+authMode+" token:"+token);!0===this.isOpenCti?sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"refreshToken",methodParams:"tokenUrl="+encodeURIComponent(tokenUrl)+"&authMode="+authMode+"&token="+encodeURIComponent(token),callback:function(response){try{IC_Validation.isNullOrEmpty(response.errors)?(logger.debug("refreshToken <<< result:"+JSON.stringify(response.returnValue)),IC_Validation.isNullOrEmpty(response.returnValue)?callback({error:"response null or empty"}):callback(IC_Common.parseJSON(response.returnValue.runApex))):(logger.error("refreshToken <<< error: "+JSON.stringify(response.errors)),callback({error:"refreshToken response error"}))}catch(error){logger.fatal("refreshToken <<< exception: ",error),callback({error:"refreshToken exception"})}}}):sforce.apex.execute(this.icCustomSearchApex,"refreshToken",{tokenUrl:encodeURIComponent(tokenUrl),authMode:authMode,token:encodeURIComponent(token)},function(response){try{if(IC_Validation.isNotNullOrEmpty(response)){var responseObj=IC_Common.parseJSON(response);IC_Validation.isNullOrEmpty(responseObj.error)?(logger.debug("refreshToken response : "+response),callback(responseObj)):responseObj.error==that.sfRunApexError?(logger.trace("SF session is invalid. Reloading the app."),window.location.reload()):(logger.error("refreshToken <<< error: "+responseObj.error),callback({error:"refreshToken response error "+responseObj.error}))}}catch(error){logger.fatal("refreshToken <<< exception : ",error),callback({error:"refreshToken exception"})}})},doScreenPop:function(url,callback){var popType=sforce.opencti.SCREENPOP_TYPE.SOBJECT,params={},that=this;this.getSoftphoneLayout(function(){var entityName=that.softPhoneLayoutSettings.screenPopSettings.NoMatch.screenPopData;if(-1!=url.indexOf("/e?")&&that.isDefaultFieldValuesSupported(entityName)){popType=sforce.opencti.SCREENPOP_TYPE.NEW_RECORD_MODAL,params.entityName=entityName;var defaultFieldValues={},urlInfo=IC_Common.parseUrl(url),queryParams=IC_Common.parseQueryString(urlInfo.search);$.each(queryParams,function(elementId,value){var fieldName=that.getEntityFieldNameByElementId(elementId);IC_Validation.isNotNullOrEmpty(fieldName)&&(defaultFieldValues[fieldName]=value)}),params.defaultFieldValues=defaultFieldValues}else-1!=url.indexOf("/")?(popType=sforce.opencti.SCREENPOP_TYPE.URL,params.url=url):(url=url.substring(0,18),params.recordId=url);logger.trace("doScreenPop - url :"+url);sforce.opencti.screenPop({type:popType,params:params,callback:function(response){logger.debug("doScreenPop : "+JSON.stringify(response)),"function"==typeof callback&&callback(response)}})})},getEntityFieldNameByElementId:function(elementId){var fieldName=null;return"con10"===elementId||"acc10"===elementId||"Phone"===elementId||"lea8"===elementId?fieldName="Phone":"con15"!==elementId&&"acc"!==elementId&&"Email"!==elementId&&"lea11"!==elementId||(fieldName="Email"),fieldName},isDefaultFieldValuesSupported:function(entityName){return/^(Account|Contact|Lead|User)$/i.test(entityName)},doScreenPopNewWindow:function(screenPopUrl){return logger.trace("doScreenPop - url :"+screenPopUrl),window.open(screenPopUrl,"_blank")},isInConsole:function(callback){logger.trace("isInConsole - fired"),this.isConsole=sforce.console.isInConsole(),logger.debug("isInConsole - result : "+this.isConsole),callback(this.isConsole)},onFocusChange:function(callback){logger.trace("Registering page info event for scc view");var that=this;sforce.opencti.onNavigationChange({listener:function(response){logger.debug("onFocusChange :"+JSON.stringify(response)),that.pageInfo=response,callback(response)}})},getCurrentFocusedWindowId:function(){var objectId="";return IC_Validation.isNullOrEmpty(this.pageInfo)||(objectId=this.pageInfo.recordId),objectId},parsePageInfoResult:function(pageResult){var result={};if(IC_Validation.isNullOrEmpty(pageResult.errors))if(result=pageResult,logger.debug("parsePageInfoResult id: "+result.recordId+" name: "+result.recordName+" objectType: "+result.objectType+", url:"+result.url),IC_Validation.isNullOrEmpty(result.object)&&IC_Validation.isNullOrEmpty(result.objectId)&&IC_Validation.isNullOrEmpty(result.objectName)&&IC_Validation.isNotNullOrEmpty(result.url)&&0==result.url.indexOf("lightning")){logger.debug("parsePageInfoResult parsing object info from url");var url=IC_Common.parseUrl(result.url);result.object=IC_Common.getParameterByName(url.search,"object"),result.objectId=IC_Common.getParameterByName(url.search,"objectId"),result.objectName=IC_Common.getParameterByName(url.search,"objectName")}else result.object=pageResult.objectType,result.objectId=pageResult.recordId,result.objectName=pageResult.recordName;return result},getPageInfo:function(callback){logger.trace("getPageInfo - fired");var that=this;if(IC_Validation.isValidObject(this.pageInfo))callback(this.pageInfo);else{sforce.opencti.getAppViewInfo({callback:function(response){logger.debug("getPageInfo - result :"+response),that.pageInfo=response,callback(response)}})}},createTask:function(callInfo,whoId,whatId,taskId,callback){logger.trace("createTask - whoId :"+whoId+", WhatId :"+whatId+", taskId :"+taskId+", callinfo :",callInfo),callInfo=encodeURIComponent(JSON.stringify(callInfo));sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"createTask",methodParams:"contactInfo="+callInfo+"&whoId="+whoId+"&whatId="+whatId+"&taskId="+taskId,callback:function(response){var result={taskId:"",isError:!1,errorMsg:""};try{var responseObj=response;IC_Validation.isNullOrEmpty(responseObj)?"false"===responseObj.result?(result.isError=!0,result.errorMsg=responseObj.error,logger.warn("task creation failed : "+responseObj.error)):(result.taskId=responseObj.result,logger.debug("task created successfully : "+responseObj.result)):(result.isError=!0,result.errorMsg=response.errors,logger.error("task creation failed : "+response.errors)),callback(IC_Common.parseJSON(result))}catch(e){result.isError=!0,result.errorMsg="Error processing createTask",logger.fatal("create task : ",e),callback(result)}}})},callWrapTask:function(callInfo,whoId,whatId,taskId,callback){callInfo=JSON.stringify(callInfo),logger.trace("callWrapTask - whoId :"+whoId+", WhatId :"+whatId+", taskId :"+taskId+", callinfo :",callInfo),callInfo=encodeURIComponent(callInfo);sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"callWrap",methodParams:"contactInfo="+callInfo+"&lstObject=&whoId="+whoId+"&whatId="+whatId+"&taskId="+taskId,callback:function(response){var result={taskId:"",popTask:!1,isError:!1,errorMsg:""};try{if(IC_Validation.isNullOrEmpty(response))result.isError=!0,result.errorMsg=response.error,logger.error("cleanUpOnContactEnd failed : "+response.error);else{var responseObj=IC_Common.parseJSON(response.returnValue.runApex);IC_Validation.isNullOrEmpty(responseObj.taskId)?(result.isError=!0,result.errorMsg=responseObj.error,logger.warn("cleanUpOnContactEnd failed : "+responseObj.error)):(result.taskId=responseObj.taskId,result.popTask=responseObj.popTask,logger.debug("cleanUpOnContactEnd success - Task : "+responseObj.taskId+" , popTask :"+responseObj.popTask+" , error : "+responseObj.error))}callback(result)}catch(e){result.isError=!0,result.errorMsg="Error processing callWrap",logger.fatal("cleanUpOnContactEnd failed : ",e),callback(result)}}})},callWrapOther:function(callInfo,objectType,lstObject,callback){logger.trace("callWrapOther - objectType :"+objectType),callInfo=encodeURIComponent(JSON.stringify(callInfo));sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"callWrapOtherObject",methodParams:"contactInfo="+callInfo+"&objectType="+objectType+"&lstObject="+lstObject,callback:function(response){var result={isError:!1,errorMsg:""};try{var responseObj=response;IC_Validation.isNullOrEmpty(responseObj)?(result.isError=!0,result.errorMsg=response.error,logger.error("callWrapOther failed: "+response.error)):IC_Validation.isNullOrEmpty(responseObj.errors)?logger.debug("callWrapOther success, response: "+responseObj.returnValue.runApex):(result.isError=!0,result.errorMsg=responseObj.error,logger.warn("callWrapOther failed: "+responseObj.error)),callback(IC_Common.parseJSON(responseObj.returnValue.runApex))}catch(e){result.isError=!0,result.errorMsg="Error processing callWrapOther",logger.fatal("Failed to process callWrapOther apex response",e),callback(result)}}})},downloadLog:function(logData){logData=encodeURIComponent(logData),logger.trace("downloadLog - fired");var that=this;!0===this.isOpenCti?sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"downloadLog",methodParams:"logData="+logData,callback:function(response){try{if(IC_Validation.isNullOrEmpty(response.errors)){var responseObj=IC_Common.parseJSON(response.returnValue.runApex);if("false"===response.success)logger.warn("downloadLog failed : "+responseObj.error);else{var frame,logId=responseObj.result.split("-"),url="https://"+window.location.host+"/servlet/servlet.FileDownload?file="+logId[0];logger.debug("downloadLog success url: "+url),(frame=document.getElementById("iFrameDownloadLog")?$("#iFrameDownloadLog"):$('<iframe id="iFrameDownloadLog" height=0 width=0 class="hiddenIframe"/>')).attr("src",url),frame.appendTo("Body"),that.downloadSfLog(logId[1])}}else logger.error("downloadLog failed : "+response.errors)}catch(e){logger.fatal("downloadLog failed : ",e)}}}):sforce.apex.execute(this.icCustomSearchApex,"downloadLog",{logData:logData},function(response){try{if(IC_Validation.isNotNullOrEmpty(response)){var responseObj=IC_Common.parseJSON(response);if(IC_Validation.isNullOrEmpty(responseObj.error)){logger.debug("downloadLog response : "+response);var frame,logId=responseObj.result.split("-"),url="https://"+window.location.host+"/servlet/servlet.FileDownload?file="+logId[0];logger.debug("downloadLog success url: "+url),(frame=document.getElementById("iFrameDownloadLog")?$("#iFrameDownloadLog"):$('<iframe id="iFrameDownloadLog" height=0 width=0 class="hiddenIframe"/>')).attr("src",url),frame.appendTo("Body"),that.downloadSfLog(logId[1])}else responseObj.error==that.sfRunApexError?(logger.trace("SF session is invalid. Reloading the app."),window.location.reload()):logger.error("downloadLog <<< error: "+responseObj.error)}}catch(error){logger.fatal("downloadLog <<< exception : ",error)}})},downloadSfLog:function(logId){var frame1,url1="https://"+window.location.host+"/servlet/servlet.FileDownload?file="+logId;(frame1=document.getElementById("iFrameDownloadLogSF")?$("#iFrameDownloadLogSF"):$('<iframe id="iFrameDownloadLogSF" height=0 width=0 class="hiddenIframe"/>')).attr("src",url1),frame1.appendTo("Body")},upsertUserOptions:function(stationId,phoneNo,phoneNumberType,logLevel,isTooltipEnabled,agentAudioSettings,agentVisualSettings,callback){logger.trace("upsertUserOptions - stationId :"+stationId+", phoneNo :"+phoneNo+", logLevel :"+logLevel+" ,phoneNumberType: "+phoneNumberType+",agentAudioSettings:"+JSON.stringify(agentAudioSettings)+",agentVisualSettings:"+JSON.stringify(agentVisualSettings)),stationId=encodeURIComponent(stationId),phoneNo=encodeURIComponent(phoneNo);sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"upsertUserSettings",methodParams:"stationId="+stationId+"&phoneNo="+phoneNo+"&phoneNumberType="+phoneNumberType+"&logLevel="+logLevel+"&tooltipEnabled="+isTooltipEnabled+"&agentAudioSettings="+JSON.stringify(agentAudioSettings)+"&agentVisualSettings="+JSON.stringify(agentVisualSettings),callback:function(response){var isError=!1,errorMsg="";try{if(IC_Validation.isNullOrEmpty(response.errors)){logger.debug("upsertUserOptions isSuccess : "+response.returnValue.runApex);var responseObj=IC_Common.parseJSON(response.returnValue.runApex);"false"===responseObj.result&&(isError=!0,errorMsg="Error on updating AgentInfo : "+responseObj.error,logger.warn("upsertUserOptions failed : "+responseObj.error))}else isError=!0,errorMsg="Error on updating AgentInfo : "+response.error,logger.error("upsertUserOptions failed : "+response.error);logger.info("upsertUserOptions isfailed : "+isError),callback(isError,errorMsg)}catch(e){logger.fatal("upsertUserOptions failed : ",e),callback(!0,"Error processing upsertUserOptions")}}})},upsertUserCredentials:function(username,password,isAutoLogin,callback){logger.trace("upsertUserCredentials - username :"+username);var that=this;username=encodeURIComponent(username),password=encodeURIComponent(password);!0===this.isOpenCti?sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"upsertUserCredentials",methodParams:"userName="+username+"&password="+password+"&isAutoLogin="+isAutoLogin,callback:function(response){var isError=!1,errorMsg="";try{if(IC_Validation.isNullOrEmpty(response.errors)){logger.debug("upsertUserCredentials isSuccess : "+response.returnValue.runApex);var responseObj=IC_Common.parseJSON(response.returnValue.runApex);"false"===responseObj.result&&(isError=!0,errorMsg="Error on updating AgentInfo : "+responseObj.error,logger.warn("upsertUserCredentials failed : "+responseObj.error))}else IC_Validation.isNotNullOrEmptyArray(response.errors)&&-1!==response.errors.indexOfKey("description",that.sfRunApexError)?(logger.trace("SF session is invalid. Reloading the app."),window.location.reload()):(isError=!0,errorMsg="Error on updating AgentInfo : "+JSON.stringify(response.errors),logger.error("upsertUserCredentials failed : "+errorMsg));logger.info("upsertUserCredentials isfailed : "+isError),callback(isError,errorMsg)}catch(e){logger.fatal("upsertUserCredentials failed : ",e),callback(!0,"Error processing upsertUserCredentials")}}}):sforce.apex.execute(this.icCustomSearchApex,"upsertUserCredentials",{userName:username,password:password,isAutoLogin:isAutoLogin},function(response){var isError=!1,errorMsg="";try{if(IC_Validation.isNotNullOrEmpty(response)){var responseObj=IC_Common.parseJSON(response);IC_Validation.isNullOrEmpty(responseObj.error)?(logger.debug("upsertUserCredentials response : "+response),"false"===responseObj.result&&(isError=!0,errorMsg="Error on updating AgentInfo : "+responseObj.error,logger.warn("upsertUserCredentials failed : "+responseObj.error))):responseObj.error==that.sfRunApexError?(logger.trace("SF session is invalid. Reloading the app."),window.location.reload()):(isError=!0,errorMsg="Error on updating AgentInfo : "+response.error,logger.error("upsertUserCredentials failed : "+response.error))}logger.info("upsertUserCredentials isfailed : "+isError),callback(isError,errorMsg)}catch(error){logger.fatal("upsertUserCredentials failed : ",error),callback(!0,"Error processing upsertUserCredentials")}})},enableClickToDial:function(eventListener){sforce.opencti.enableClickToDial({callback:function(response){response.success?logger.trace("Click to dial was enabled."):logger.trace("Click to dial was not enabled.")}}),!1===this.onClickToDial&&(this.onClickToDial=!0,logger.trace("enabling click to dial"),sforce.opencti.onClickToDial({listener:eventListener}))},disableClickToDial:function(){logger.trace("disable click to dial fired");sforce.opencti.disableClickToDial({callback:function(response){response.returnValue?(logger.trace("Click to dial was disabled."),this.onClickToDial=!1):logger.trace("Click to dial was not disabled.")}})},contactSearch:function(contact,callback){var inboundObject,popSetting,outboundObject,searchObject,error="",that=this,isOutbound=!1;logger.trace("ContactID: "+contact.id," contactSearch"),this.getSoftphoneLayout(function(setting){IC_Validation.isNullOrEmpty(setting.error)?(inboundObject=JSON.stringify(setting.inboundObject),outboundObject=JSON.stringify(setting.outboundObject),popSetting=JSON.stringify(setting.screenPopSettings)):(error="Error in getting softphone layout setting.",inboundObject="{}",outboundObject="{}",popSetting="{}"),"CallContactEvent"===contact.contactType||"VoiceMailContactEvent"===contact.contactType?(isOutbound=that.isRegularOutbound(contact),searchObject=!0===isOutbound?outboundObject:inboundObject,that.searchAndPopCall(contact,searchObject,popSetting,error,isOutbound,callback)):"WorkItemContactEvent"===contact.contactType?that.searchAndPopWorkItem(contact,inboundObject,popSetting,error,callback):"ChatContactEvent"===contact.contactType?that.searchAndPopChat(contact,inboundObject,popSetting,error,callback):"EmailContactEvent"===contact.contactType&&that.searchAndPopEmail(contact,inboundObject,popSetting,error,callback)})},isRegularOutbound:function(contact){return!1===contact.inbound&&"Regular"===contact.type},getSoftphoneLayout:function(callback){var that=this;if(IC_Validation.isValidObject(this.softPhoneLayoutSettings))logger.trace("getSoftphoneLayout : settings exist"),callback(this.softPhoneLayoutSettings);else{logger.trace("getSoftphoneLayout : fired");sforce.opencti.getSoftphoneLayout({callback:function(response){var phoneSetting={};try{if(IC_Validation.isNullOrEmpty(response.errors)){var responseObj=response.returnValue;phoneSetting.inboundObject=responseObj.Inbound.objects,phoneSetting.outboundObject=responseObj.Outbound.objects,phoneSetting.screenPopSettings=responseObj.Inbound.screenPopSettings,that.softPhoneLayoutSettings=phoneSetting,logger.debug("getSoftphoneLayout success"+JSON.stringify(phoneSetting))}else phoneSetting.error=response.errors,logger.error("getSoftphoneLayout failed"+response.errors)}catch(e){logger.fatal("getSoftphoneLayout failed",e),phoneSetting.error="Error processing getSoftphoneLayout"}finally{callback(phoneSetting)}}})}},searchAndPopWorkItem:function(contact,inboundObject,popSetting,error,callback){var that=this,cScreenPopUrl=IC_Common.appendQueryString(contact.screenPopUrl,{_c:contact.id});logger.trace("ContactID: "+contact.id," searchAndPopWorkItem - type :"+contact.workItemType+", workItemId :"+contact.workItemId+", workItempayload :"+contact.workItemPayload+", screenpopUrl :"+cScreenPopUrl);sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"workItemCustomSearch",methodParams:"contactId="+contact.id+"&type="+contact.workItemType+"&id="+contact.workItemId+"&workItempayload="+encodeURIComponent(contact.workItemPayload)+"&screenpopUrl="+encodeURIComponent(cScreenPopUrl)+"&inboundObject="+encodeURIComponent(inboundObject)+"&popSetting="+popSetting,callback:function(response){var popResult=that.checkScreenPopUrl(cScreenPopUrl),contactData=null,searchResult={},screenPopUrl="";try{IC_Validation.isNullOrEmpty(response.errors)?(contactData=IC_Common.parseJSON(response.returnValue.runApex),popResult.isSalesforceUrl?screenPopUrl=popResult.url:contactData.hasControlledSearch?(searchResult=IC_Common.parseJSON(contactData.searchResult),screenPopUrl=contactData.screenPopUrl):IC_Validation.isNullOrEmpty(contactData.error)||(error+="Error in getting configuration.",logger.warn("searchAndPopWorkItem failed :"+contactData.error))):(error+=response.errors,logger.error("searchAndPopWorkItem failed :"+response.errors))}catch(e){error+="Error processing searchAndPopWorkItem",logger.fatal("searchAndPopWorkItem failed :",e)}finally{var sfResult=that.onContactResult(contact.id,contactData,popResult,inboundObject,error,searchResult,screenPopUrl);logger.trace("searchAndPopWorkItem :"+screenPopUrl+" SfResult"+JSON.stringify(sfResult)),callback(sfResult)}}})},searchAndPopChat:function(contact,inboundObject,popSetting,error,callback){var that=this,cScreenPopUrl=IC_Common.appendQueryString(contact.screenPopUrl,{_c:contact.id});logger.trace("ContactID: "+contact.id," searchAndPopChat - screenpopUrl :"+cScreenPopUrl);sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"chatCustomSearch",methodParams:"contactId="+contact.id+"&screenpopUrl="+encodeURIComponent(cScreenPopUrl)+"&inboundObject="+encodeURIComponent(inboundObject)+"&popSetting="+popSetting,callback:function(response){var popResult=that.checkScreenPopUrl(cScreenPopUrl),contactData=null,searchResult={},screenPopUrl="";try{IC_Validation.isNullOrEmpty(response.errors)?(contactData=IC_Common.parseJSON(response.returnValue.runApex),popResult.isSalesforceUrl?screenPopUrl=popResult.url:contactData.hasControlledSearch?(searchResult=IC_Common.parseJSON(contactData.searchResult),screenPopUrl=contactData.screenPopUrl):IC_Validation.isNullOrEmpty(contactData.error)||(error+="Error in getting configuration.",logger.warn("searchAndPopChat failed :"+contactData.error))):(error+=response.errors,logger.error("searchAndPopChat failed :"+response.errors))}catch(e){error+="Error processing searchAndPopChat",logger.fatal("searchAndPopChat failed :",e)}finally{var sfResult=that.onContactResult(contact.id,contactData,popResult,inboundObject,error,searchResult,screenPopUrl);logger.trace("searchAndPopChat :"+screenPopUrl+" SfResult"+JSON.stringify(sfResult)),callback(sfResult)}}})},searchAndPopEmail:function(contact,inboundObject,popSetting,error,callback){var fromEmailAddress=contact.fromAddress,contactId=contact.id,that=this,contactInfo="",cScreenPopUrl=IC_Common.appendQueryString(contact.screenPopUrl,{_c:contact.id}),needToPerformDefaultSearch=!1;logger.trace("ContactID: "+contact.id," searchAndPopEmail - Email :"+fromEmailAddress+", scriptVar :"+contact.screenPopUrl),contactInfo=this.addContactDetails(contact),contactInfo=JSON.stringify(contactInfo),contactInfo=encodeURIComponent(contactInfo);sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"contactSearch",methodParams:"contactInfo="+contactInfo+"&screenpopUrl="+encodeURIComponent(cScreenPopUrl)+"&inboundObject="+encodeURIComponent(inboundObject)+"&popSetting="+popSetting,callback:function(response){var sfResult,popResult=that.checkScreenPopUrl(cScreenPopUrl),contactData=null,searchResult={};logger.debug("searchAndPopEmail - response : ",JSON.stringify(response));try{IC_Validation.isNullOrEmpty(response.error)?(contactData=IC_Common.parseJSON(response.returnValue.runApex),logger.debug("searchAndPopEmail - response:",response),popResult.isSalesforceUrl?(sfResult=that.onContactResult(contactId,contactData,popResult,inboundObject,error,searchResult,popResult.url),logger.trace("searchAndPopEmail :"+popResult.url+" SfResult"+JSON.stringify(sfResult))):contactData.hasControlledSearch?(searchResult=IC_Common.parseJSON(contactData.searchResult),sfResult=that.onContactResult(contactId,contactData,popResult,inboundObject,error,searchResult,contactData.screenPopUrl),logger.trace("searchAndPopEmail :"+contactData.screenPopUrl+" SfResult"+JSON.stringify(sfResult))):(IC_Validation.isNullOrEmpty(contactData.error)||(error+="Error in getting configuration, performing default search.",logger.warn("searchAndPopEmail failed :"+contactData.error)),needToPerformDefaultSearch=!0)):response.error==that.sfRunApexError?(logger.trace("SF session is invalid. Reloading the app."),window.location.reload()):(error+="Error in executing apex method, performing default search.",logger.error("searchAndPopEmail failed :"+response.error),needToPerformDefaultSearch=!0)}catch(e){error+="Error in processing Salesforce response, performing default search.",logger.fatal("searchAndPopEmail failed :",e),needToPerformDefaultSearch=!0}finally{contact.isInbound?needToPerformDefaultSearch?that.defaultSearch(fromEmailAddress,popResult,contact,contactData,inboundObject,popSetting,error,!1,callback):callback(sfResult):(sfResult=that.onContactResult(contactId,contactData,popResult,inboundObject,error,searchResult,contactData.screenPopUrl),callback(sfResult))}}})},addContactDetails:function(contact){var _contact=new Object;return _contact.id=contact.id,_contact.contactType=contact.contactType,_contact.fromAddress=contact.fromAddress?contact.fromAddress:"",_contact},searchAndPopCall:function(contact,inboundObject,popSetting,error,isOutbound,callback){var phoneNo,cScreenPopUrl,contactId=contact.id,that=this,ani=contact.ani,dnis=contact.dnis;"VoiceMailContactEvent"===contact.contactType&&(ani=contact.from,dnis=contact.to),phoneNo=contact.inbound?ani:dnis,logger.trace("ContactID: "+contact.id," searchAndPopCall - Phone :"+phoneNo+", scriptVar :"+contact.screenPopUrl),cScreenPopUrl=this.addAniDnis(contact.screenPopUrl,ani,dnis,contact.id);sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"callCustomSearch2",methodParams:"contactId="+contact.id+"&contactType="+contact.type+"&externalId="+contact.externalId+"&phoneNumber="+encodeURIComponent(phoneNo)+"&screenpopUrl="+encodeURIComponent(cScreenPopUrl)+"&inboundObject="+encodeURIComponent(inboundObject)+"&popSetting="+popSetting,callback:function(response){var sfResult,popResult=that.checkScreenPopUrl(cScreenPopUrl),contactData=null,searchResult={};try{IC_Validation.isNullOrEmpty(response.errors)?(contactData=IC_Common.parseJSON(response.returnValue.runApex),logger.debug("searchAndPopCall - response:",response.returnValue.runApex),popResult.isSalesforceUrl?(sfResult=that.onContactResult(contactId,contactData,popResult,inboundObject,error,searchResult,popResult.url),logger.trace("searchAndPopCall :"+popResult.url+" SfResult"+JSON.stringify(sfResult)),callback(sfResult)):contactData.hasControlledSearch?(searchResult=IC_Common.parseJSON(contactData.searchResult),sfResult=that.onContactResult(contactId,contactData,popResult,inboundObject,error,searchResult,contactData.screenPopUrl),logger.trace("searchAndPopCall :"+contactData.screenPopUrl+" SfResult"+JSON.stringify(sfResult)),callback(sfResult)):(IC_Validation.isNullOrEmpty(contactData.error)||(error+="Error in getting configuration, performing default search.",logger.warn("searchAndPopCall failed :"+contactData.error)),that.defaultSearch(phoneNo,popResult,contact,contactData,inboundObject,popSetting,error,isOutbound,callback))):(error+="Error in executing apex method, performing default search.",logger.error("searchAndPopCall failed :"+response.errors),that.defaultSearch(phoneNo,popResult,contact,contactData,inboundObject,popSetting,error,isOutbound,callback))}catch(e){error+="Error in processing Salesforce response, performing default search.",logger.fatal("searchAndPopCall failed :",e),that.defaultSearch(phoneNo,popResult,contact,contactData,inboundObject,popSetting,error,isOutbound,callback)}}})},defaultSearch:function(searchValue,popResult,contact,contactData,inboundObjects,popSetting,error,isOutbound,callback){var searchResult={},queryString=popResult.queryString,that=this,calltype=!0===isOutbound?sforce.opencti.CALL_TYPE.OUTBOUND:sforce.opencti.CALL_TYPE.INBOUND,jsonInboundObject=IC_Common.parseJSON(inboundObjects),contactId=contact.id,isEmailContact="EmailContactEvent"===contact.contactType,screenPopCallback=function(response){logger.debug("defaultSearch - screenPopCallback : "+JSON.stringify(response))};if(logger.trace("defaultSearch - searchValue:"+searchValue),0===Object.keys(jsonInboundObject).length){var sfResult=that.onContactResult(contactId,contactData,popResult,inboundObjects,error,{},"",!0);return callback(sfResult),!0}sforce.opencti.searchAndScreenPop({searchParams:searchValue,queryParams:queryString,callType:calltype,callback:function(response){try{if(logger.debug("defaultSearch - result:",JSON.stringify(response)),IC_Validation.isNullOrEmpty(response.errors)){$.each(response.returnValue,function(key,val){"SCREEN_POP_DATA"!=key&&(searchResult[key]=val)});var SCREEN_POP_DATA={params:{},type:"",callback:screenPopCallback};if(Object.keys(searchResult).length>1)"PopToSearch"==that.softPhoneLayoutSettings.screenPopSettings.MultipleMatches.screenPopType?(SCREEN_POP_DATA.type=sforce.opencti.SCREENPOP_TYPE.SEARCH,SCREEN_POP_DATA.params.searchString=searchValue):"PopToVisualforce"==that.softPhoneLayoutSettings.screenPopSettings.MultipleMatches.screenPopType&&(SCREEN_POP_DATA.type=sforce.opencti.SCREENPOP_TYPE.URL,SCREEN_POP_DATA.params.url="/apex/"+that.softPhoneLayoutSettings.screenPopSettings.MultipleMatches.screenPopData+"?"+queryString),sforce.opencti.screenPop(SCREEN_POP_DATA);else if(1==Object.keys(searchResult).length){var objectId;$.each(searchResult,function(key,data){objectId=key}),"PopToEntity"==that.softPhoneLayoutSettings.screenPopSettings.SingleMatch.screenPopType?(SCREEN_POP_DATA.type=sforce.opencti.SCREENPOP_TYPE.SOBJECT,SCREEN_POP_DATA.params.recordId=objectId):"PopToVisualforce"==that.softPhoneLayoutSettings.screenPopSettings.SingleMatch.screenPopType&&(SCREEN_POP_DATA.type=sforce.opencti.SCREENPOP_TYPE.URL,SCREEN_POP_DATA.params.url="/apex/"+that.softPhoneLayoutSettings.screenPopSettings.SingleMatch.screenPopData+"?"+queryString),sforce.opencti.screenPop(SCREEN_POP_DATA)}else if("PopToEntity"==that.softPhoneLayoutSettings.screenPopSettings.NoMatch.screenPopType){if(SCREEN_POP_DATA.type=sforce.opencti.SCREENPOP_TYPE.NEW_RECORD_MODAL,SCREEN_POP_DATA.params.entityName=that.softPhoneLayoutSettings.screenPopSettings.NoMatch.screenPopData,that.isDefaultFieldValuesSupported(SCREEN_POP_DATA.params.entityName)){SCREEN_POP_DATA.params.defaultFieldValues={};var fieldName=!0===isEmailContact?"Email":"Phone";SCREEN_POP_DATA.params.defaultFieldValues[fieldName]=searchValue}that.screenPopNewRecordModal(SCREEN_POP_DATA)}else"PopToVisualforce"==that.softPhoneLayoutSettings.screenPopSettings.NoMatch.screenPopType&&(SCREEN_POP_DATA.type=sforce.opencti.SCREENPOP_TYPE.URL,SCREEN_POP_DATA.params.url="/apex/"+that.softPhoneLayoutSettings.screenPopSettings.NoMatch.screenPopData+"?"+queryString,sforce.opencti.screenPop(SCREEN_POP_DATA))}else error+=response.errors[0].description,logger.error("defaultSearch failed :"+response.errors[0].description)}catch(e){error+="Error in processing defaultSearch",logger.fatal("defaultSearch failed :",e)}finally{var sfResult=that.onContactResult(contactId,contactData,popResult,inboundObjects,error,searchResult,"");logger.trace("defaultSearch - SfResult"+JSON.stringify(sfResult)),callback(sfResult)}},deferred:!0})},screenPopNewRecordModal:function(screenPopData){logger.trace("screenPopNewRecordModal >>> screenPopData: "+JSON.stringify(screenPopData));sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"getSfObjectApiName",methodParams:"sfobjectName="+screenPopData.params.entityName,callback:function(response){try{if(logger.debug("getSfObjectApiNameCallBack <<<"+JSON.stringify(response)),response.returnValue){var apiName=response.returnValue.runApex;IC_Validation.isNotNullOrEmpty(apiName)&&(screenPopData.params.entityName=apiName)}}catch(e){logger.fatal("Exception in getSfObjectApiNameCallBack. ",e)}finally{sforce.opencti.screenPop(screenPopData)}}})},addAniDnis:function(screenPopUrl,ani,dnis,contactId){if(logger.trace("addAniDnis - screenPopUrl :"+screenPopUrl+", ani :"+ani+", dnis :"+dnis),IC_Validation.isNullOrEmpty(screenPopUrl))screenPopUrl=IC_Common.appendQueryString(screenPopUrl,{ani:ani,dnis:dnis,_c:contactId});else{var lowQuery=screenPopUrl.toLowerCase();-1===lowQuery.indexOf("ani=")&&(screenPopUrl=IC_Common.appendQueryString(screenPopUrl,{ani:ani})),-1===lowQuery.indexOf("dnis=")&&(screenPopUrl=IC_Common.appendQueryString(screenPopUrl,{dnis:dnis})),screenPopUrl=IC_Common.appendQueryString(screenPopUrl,{_c:contactId})}return logger.trace("addAniDnis - result screenPopUrl :"+screenPopUrl),screenPopUrl},formScreenPopUrl:function(screenPopUrl,count,query,phoneNumber,popSetting,contactId){if(!IC_Validation.isNullOrEmpty(screenPopUrl)){logger.trace("formScreenPopUrl - result screenPopUrl :"+screenPopUrl+", count :"+count+", query :"+query+", Phone :",phoneNumber);var queryPartExist=-1!==screenPopUrl.indexOf("?");if(IC_Validation.isNullOrEmpty(query)||0!==screenPopUrl.indexOf("/apex"))if(0===count){if(screenPopUrl+=queryPartExist?"&":"?",IC_Validation.isNullOrEmpty(popSetting))screenPopUrl+="con10="+phoneNumber+"&Phone="+phoneNumber+"&lea8="+phoneNumber+"&acc10="+phoneNumber;else if(popSetting=IC_Common.parseJSON(popSetting),IC_Validation.isValidObject(popSetting)&&popSetting.hasOwnProperty("NoMatch")){var scPopData=popSetting.NoMatch;if(IC_Validation.isValidObject(scPopData)&&scPopData.hasOwnProperty("screenPopData")&&scPopData.hasOwnProperty("screenPopType"))if("PopToEntity"===scPopData.screenPopType){var objType=scPopData.screenPopData;"Contact"==objType?screenPopUrl+="con10="+phoneNumber:"Account"==objType?screenPopUrl+="acc10="+phoneNumber:"User"==objType?screenPopUrl+="Phone="+phoneNumber:"Lead"==objType&&(screenPopUrl+="lea8="+phoneNumber)}}screenPopUrl=IC_Common.appendQueryString(screenPopUrl,{_c:contactId})}else screenPopUrl=IC_Common.appendQueryString(screenPopUrl,{_c:contactId});else screenPopUrl+=queryPartExist?"&":"?",screenPopUrl+=query}return logger.debug("formScreenPopUrl - result screenPopUrl :"+screenPopUrl),screenPopUrl},checkScreenPopUrl:function(screenPopUrl){var url=document.createElement("a"),result={isSalesforceUrl:!1,url:"",queryString:""};return IC_Validation.isNullOrEmpty(screenPopUrl)||(url.href=screenPopUrl,result.queryString=url.search.slice(1),!/^http:\/\/|^https:\/\//i.test(screenPopUrl)||/\/incontact\/Agent\/ScreenPopPrintVars.aspx?/i.test(screenPopUrl)||/sfdc[0-9]|crm[0-9]|sfdcquery[0-9]|crmquery[0-9]/i.test(screenPopUrl)||(url.href=screenPopUrl,/\.force\.com$/i.test(url.hostname)||/\.salesforce\.com/i.test(url.hostname)?(result.url=this.getRelativeUrl(url),result.isSalesforceUrl=!0,logger.debug("inContact controlled url pop isSalesforceDomain:"+result.isSalesforceUrl+" , popUrl :"+result.url)):(result.url=screenPopUrl,logger.debug("inContact controlled url pop isSalesforceDomain: false, popUrl :"+screenPopUrl)))),result},getRelativeUrl:function(sfUrl){try{logger.debug("getRelativeUrl - sfUrl :"+sfUrl);var hostname,pathname=sfUrl.pathname;/\.force\.com$/i.test(sfUrl.hostname)&&(hostname="apex/"+(hostname=sfUrl.hostname.slice(0,sfUrl.hostname.indexOf(".")))+"__",pathname=pathname.replace(/\/apex\//i,hostname));var url=pathname+sfUrl.search;return logger.debug("getRelativeUrl - result Url :"+url),url}catch(e){return logger.error("getRelativeUrl failed:",e),""}},addContactId:function(contactId,screenPopUrl){return IC_Validation.isNullOrEmpty(screenPopUrl)||-1!==screenPopUrl.indexOf("&_c="+contactId)||(screenPopUrl=IC_Common.appendQueryString(screenPopUrl,{_c:contactId})),screenPopUrl},onContactResult:function(contactId,configData,popResult,inboundObjects,error,searchResult,sfScreenPopUrl,isNoObjectFound){inboundObjects=IC_Common.parseJSON(inboundObjects),sfScreenPopUrl=this.addContactId(contactId,sfScreenPopUrl);var isNoObject=!0===isNoObjectFound?"NoObject":"",sfResult={cId:contactId,urlPop:popResult.isSalesforceUrl,screenPopUrl:popResult.url,sfScreenPopUrl:sfScreenPopUrl,isScreenPopped:!1,canPopTask:!1,outboundData:isNoObject,error:error,results:{inboundObjects:inboundObjects,result:searchResult},task:{id:"",notes:"",disp:{value:"",order:0,id:"",isAmount:!1,isDate:!1},secDisp:{value:"",order:0,id:""},dispPayload:{isReschedule:!1,data:""},who:"",what:""},whoLst:[],whatLst:[],acw:!1,final:!1};return IC_Validation.isValidObject(configData)?(sfResult.create=configData.createTask,sfResult.createForRefused=configData.createTaskForRefused,sfResult.pop=configData.popTask,sfResult.related=IC_Common.parseJSON(configData.taskRealtedObjects),sfResult.hasControlledSearch=configData.hasControlledSearch,sfResult.entityMappingType=configData.entityMappingType):(sfResult.create=!0,sfResult.createForRefused=!0,sfResult.pop=!1,sfResult.entityMappingType=0,sfResult.related={Account:!0,Asset:!0,Campaign:!0,Case:!0,Contract:!0,Opportunity:!0,Product2:!0,Solution:!0},sfResult.hasControlledSearch=!1),sfResult},getIANATimeZoneOffset:function(ianaName,callback){logger.trace("getIANATimeZoneOffset - ianaName :"+ianaName);var that=this;sforce.apex.execute(this.icCustomSearchApex,"getIANATimeZoneOffset",{ianaName:ianaName},function(response){try{if(!IC_Validation.isNullOrEmpty(response)){var responseObj=IC_Common.parseJSON(response);IC_Validation.isNullOrEmpty(response.error)?(logger.debug("getIANATimeZoneOffset isSuccess : "+response),callback(responseObj.result,responseObj.error)):responseObj.error==that.sfRunApexError&&(logger.trace("SF session is invalid. Reloading the app."),window.location.reload())}}catch(e){logger.fatal("getIANATimeZoneOffset failed : ",e),callback(0,"Error processing getIANATimeZoneOffset")}})},getOmniChannelMappingDetails:function(callback){logger.trace("getOmniChannelMapping >>>");sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"getOmniChannelMappingDetails",methodParams:"data=''",callback:function(response){try{if(logger.debug("getOmniChannelMapping <<<"+JSON.stringify(response)),response.returnValue){var i,responseObj=IC_Common.parseJSON(response.returnValue.runApex),resultObj=IC_Common.parseJSON(responseObj.result),omniChannelSettings={master:"",presenceMappings:[]};if(resultObj&&resultObj.presenceMappings){for(i=0;i<resultObj.presenceMappings.length;i++)omniChannelSettings.presenceMappings.push(IC_Common.parseJSON(resultObj.presenceMappings[i]));omniChannelSettings.master=(resultObj.PresenceMaster||"").toLowerCase()}callback(omniChannelSettings)}}catch(e){logger.fatal("Exception in getOmniChannelMapping. ",e),callback(null)}}})},setServicePresenceStatus:function(statusId,callback){logger.trace("setServicePresenceStatus  - statusId :"+statusId),sforce.console.presence.setServicePresenceStatus(statusId,function(response){try{logger.trace("setServicePresenceStatus  - result :"+JSON.stringify(response)),callback(response)}catch(e){logger.fatal("setServicePresenceStatus failed : ",e),callback(null)}})},getServicePresenceStatusId:function(callback){logger.trace("getServicePresenceStatusId"),sforce.console.presence.getServicePresenceStatusId(function(response){try{logger.trace("getServicePresenceStatusId  - result :"+JSON.stringify(response)),callback(response.statusId)}catch(e){logger.fatal("getServicePresenceStatusId failed : ",e),callback(null)}})},getAvailableorBusy:function(statusId,callback){logger.trace("getAvailableorBusy  - statusId :"+statusId);try{var query="select IsAway from UserServicePresence where  ServicePresenceStatusId ='"+statusId+"' order by CreatedDate desc limit 1",queryResult=sforce.connection.query(query);logger.debug("getAvailableorBusy Success : "+JSON.stringify(queryResult)),callback("true"!=queryResult.records.IsAway)}catch(error){logger.fatal("getAvailableorBusy Failed : ",error.faultstring)}},getFirstandLastName:function(id,objectType,callback){logger.trace("getFirstandLastName  - id :"+id+" ,objectType: "+objectType);try{var query="select id,firstName,lastname from "+objectType+" where id='"+id+"'",queryResult=sforce.connection.query(query);logger.debug("getFirstandLastName Success : "+JSON.stringify(queryResult)),callback(queryResult.records)}catch(error){callback(null),logger.fatal("getFirstandLastName Failed : ",error.faultstring)}},openCXone:function(vfPageUrl){if(this.isConsole){this.staticResource;var primaryTabId=localStorage.cx1Tab;"true"===localStorage.isCX1Open&&IC_Validation.isNotNullOrEmpty(primaryTabId)?this.refreshCXoneTab(primaryTabId,vfPageUrl):this.openVisualForcePageTab(vfPageUrl)}else{var popupOptions="width=765,height=665,scrollbars=yes,toolbar=no,left="+(screen.width/2-382.5);this.cx1Window=window.open(vfPageUrl,"CXoneWindow",popupOptions),this.cx1Window.focus()}},openVisualForcePageTab:function(vfPageUrl){sforce.console.openPrimaryTab(null,vfPageUrl,!0,"CXone",function(tabResp){logger.debug("openVisualForcePageTab:openPrimaryTab <<< success:"+tabResp.success+" tabId:"+tabResp.id),tabResp.success&&sforce.console.setTabIcon(cx1Icon,tabResp.id,function(iconResp){logger.debug("openCXone:setTabIcon <<< success:"+iconResp.success)})},"CXoneTab")},refreshCXoneTab:function(primaryTabId,vfPageUrl){var that=this;sforce.console.refreshPrimaryTabById(primaryTabId,!0,function(tabResp){logger.debug("refreshCXoneTab:refreshPrimaryTabById <<< success:"+tabResp.success),!1===tabResp.success&&that.openVisualForcePageTab(vfPageUrl)})},closeCXone:function(){if("true"!==localStorage.isCX1Open)return localStorage.cx1Tab=null,void logger.debug("closeCXone: ignore cx1Window null");this.isConsole?sforce.console.closeTab(localStorage.cx1Tab,function(tabResp){localStorage.cx1Tab=null,tabResp.error&&logger.error("closeTab <<< failed: "+tabResp.error)}):(null==this.cx1Window&&(this.cx1Window=window.open("","CXoneWindow")),this.cx1Window.close())},createAgentWork:function(workItemId,serviceChannelId,callback){logger.trace("createAgentWork >>> workItemId: "+workItemId+" serviceChannelId: "+serviceChannelId);sforce.opencti.runApex({apexClass:this.icCustomSearchApex,methodName:"createAgentWork",methodParams:"workItemId="+workItemId+"&serviceChannelId="+serviceChannelId,callback:function(response){try{IC_Validation.isNullOrEmpty(response.errors)?(logger.debug("createAgentWork <<< result: "+JSON.stringify(response.returnValue)),callback(!0)):(logger.error("createAgentWork <<< error: "+JSON.stringify(response.errors)),callback(!1))}catch(error){logger.fatal("createAgentWork <<< exception: ",error),callback(!1)}}})},canOmniChannelAcceptAgentWork:function(serviceChannelId,callback){logger.trace("canOmniChannelAcceptAgentWork >>> serviceChannelId : "+serviceChannelId);var canAccept=!1;this.getServicePresenceStatusId(function(servicePresenceStatusId){try{if(servicePresenceStatusId){var query="select id,ServiceChannelId, ServicePresenceStatusId from ServiceChannelStatus where ServicePresenceStatusId ='"+servicePresenceStatusId+"' and ServiceChannelId='"+serviceChannelId+"' limit 1",queryResult=sforce.connection.query(query);logger.debug("canOmniChannelAcceptAgentWork Success : "+JSON.stringify(queryResult)),canAccept=1==queryResult.size}}catch(error){canAccept=!1,logger.fatal("canOmniChannelAcceptAgentWork Failed : ",error.faultstring)}finally{callback(canAccept)}})}}}(jQuery);