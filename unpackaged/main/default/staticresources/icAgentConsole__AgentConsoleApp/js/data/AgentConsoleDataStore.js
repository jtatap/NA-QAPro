!function($){var logger=IC_Common.getLogger("DataStore");AgentConsoleDataStore={URLEncoded:"application/x-www-form-urlencoded; charset=UTF-8",JSONEncoded:"application/json; charset=UTF-8",AgentSessionStartEvent:"agentConsole_AgentSessionStartEvent",AgentInfoEvent:"agentConsole_AgentInfoEvent",AgentSessionEndEvent:"agentConsole_AgentSessionEndEvent",ContactEvent:"agentConsole_ContactEvent",UnavailableListEvent:"agentConsole_UnavailableListEvent",AllUnavailableCodeListEvent:"agentConsole_AllUnavailableCodeListEvent",AgentSkillListEvent:"agentConsole_AgentSkillListEvent",ContactResultEvent:"agentConsole_ContactResultEvent",APIErrorEvent:"agentConsole_APIErrorEvent",AgentListEvent:"agentConsole_AgentListEvent",AgentStateChangeEvent:"agentConsole_AgentStateChangeEvent",TeamListEvent:"agentConsole_TeamListEvent",SkillListEvent:"agentConsole_SkillListEvent",SkillClosedHoursEvent:"agentConsole_SkillClosedHoursEvent",SkillQueueEvent:"agentConsole_SkillQueueEvent",SkillRunningLowEvent:"agentConsole_SkillRunningLowEvent",CustomVariablesEvent:"agentConsole_CustomVariablesEvent",AgentSkillAssignmentsEvent:"agentConsole_AgentSkillAssignmentsEvent",AddressBooksEvent:"agentConsole_AddressBooksEvent",PCQueueEvent:"agentConsole_PCQueueEvent",DispositionEvent:"agentConsole_DispositionEvent",ChatMsgEvent:"agentConsole_ChatMsgEvent",FeedbackCategoryEvent:"agentConsole_FeedbackCategoryEvent",AgentMessageEvent:"agentConsole_agentMessageEvent",AgentIndicatorEvent:"agentConsole_AgentIndicatorEvent",ContactHistoryEvent:"agentConsole_ContactHistoryEvent",QuickReplyEvent:"agentConsole_QuickReplyEvent",VoiceMailPlayBackEvent:"agentConsole_VoiceMailPlayBack",PermissionsListEvent:"agentConsole_PermissionsListEvent",AutoLoginDisabledEvent:"agentConsole_AutoLoginDisabledEvent",MailProgressEvent:"agentConsole_MailProgressEvent",FileExtensionsListEvent:"agentConsole_FileExtensionsListEvent",PromiseKeeperEvent:"agentConsole_PromiseKeeperEvent",TimeZoneEvent:"agentConsole_TimeZoneEvent",RescheduleCommitmentReminderEvent:"agentConsole_RescheduleCommitmentReminderEvent",RescheduleCommitmentReminderCompletedEvent:"agentConsole_RescheduleCommitmentReminderCompletedEvent",ProceedCommitmentReminderEvent:"agentConsole_ProceedCommitmentReminderEvent",BrandingProfilesEvent:"agentConsole_BrandingProfilesEvent",ParkedEmailDetailsEvent:"agentConsole_ParkedEmailDetailsEvent",EmailParkEvent:"agentConsole_EmailParkEvent",ChatPatronTypingEvent:"agentConsole_ChatPatronTypingEvent",ChatPreviewEvent:"agentConsole_ChatPreviewEvent",ParkedEmailLimitValidation:"agentConsole_ParkedEmailLimitValidation",PCPreviewNotesUpdate:"agentConsole_PCPreviewNotesUpdate",SkillTagsUpdateEvent:"agentConsole_SkillTagsUpdateEvent",TagsUpdatedContactEvent:"agentConsole_TagsUpdatedContactEvent",BUFeaturesListEvent:"agentConsole_BUFeaturesListEvent",MaxConferenceHandleEvent:"agentConsole_MaxConferenceHandleEvent",OmniChannelReadyStateChangedEvent:"agentConsole_OmniChannelReadyStateChangedEvent",agentLegAcceptRejectActionsEvent:"agentConsole_agentLegAcceptRejectActionsEvent",AgentMessageNotifyEvent:"agentConsole_agentMessageNotifyEvent",customVariables:{},userInfo:{},OAuthInfo:{},agentInfo:{},teamUnavailableList:[],allUnavailableList:{},agentSkillList:[],allSkillList:{},contacts:[],errorList:[],skillClosed:{},sfResult:[],isInConsoleView:!1,isSkillRunningLow:!0,isLoaded:!1,browserTabIndex:0,amIPopoutWindow:!1,isPopupClickflag:0,canClearPopValues:!0,agentList:[],agentListMap:{},teamList:[],permissionsList:[],fileExtList:[],promiseKeeperList:[],timeZoneList:[],skillList:[],skillListMap:{},skillQueueMap:{},agentSkillMap:{},addressBookList:[],category:[],priority:[],browserTabs:[],pcQueueContacts:[],chatMsg:{},chatMsgUpdatedContactId:"",chatMsgIntialLoad:!0,agentMessage:{expiredMsg:{},message:[],scrollMsgCount:0},quickReply:[],indicators:{agentIndicator:[],contactIndicator:[]},screenPop:{},focused:{iframe:!1,window:!1},windowOpenTime:0,cHistory:{},cHistoryArr:[],brandingProfile:{},commitmentReminder:{},documentUnloaded:!1,onErrorCallback:null,isChatPopOut:!1,lastDispContactId:"",isEmailFeatureEnabled:!0,vmPlayBack:{},failureCount:0,maxFailureCount:5,failureTimeInterval:2500,notificationConnectRetryTimerId:!1,notificationConnectRetryCount:1,isClientInitiateCloseConnection:!1,timeIntervalForWSConnection:0,isMailSending:!1,isAutoLogin:!0,sfMode:"",isTooltipEnabled:!1,parkedEmailList:[],persistEmailInfo:[],commitmentReminderWnd:null,parkEmailId:"",chatPatronTyping:[],chatPreview:[],skillTagsMap:{},tagsLoadedContacts:[],tagsUpdatedContact:{},sock:null,featuresList:[],wfoUrl:"",maxConference:3,isIntegratedSoftphone:null,agentSettings:{},omniChannelRoutingInfo:{},agentLegAcceptRejectActions:"",agentAudioSettings:{AgentMessages:!1,Contacts:!1,ChatMessages:!1,EndChatOrCall:!1},agentVisualSettings:{AgentMessages:!1,Contacts:!1,ChatMessages:!1,EndChatOrCall:!1},defaultContactInitTabIndex:1,isEmbeddedUrlsListEmpty:!0,socketMsgsToProcess:[],clientLocale:"",clientTimezoneName:"",embeddedAPIFailureCounter:0,supportedPagesUrl:"",loginUri:"/services/v2.0/agent-sessions",sessionJoinUri:"/services/v2.0/agent-sessions/join",getNextEventUri:"/services/v2.0/agent-sessions/{sessionId}/get-next-event",logoutUri:"/services/v2.0/agent-sessions/{sessionId}",setAgentStateUri:"/services/v2.0/agent-sessions/{sessionId}/state",dialAgentLegUri:"/services/v2.0/agent-sessions/{sessionId}/agent-phone/dial",endAgentLegUri:"/services/v2.0/agent-sessions/{sessionId}/agent-phone/end",acceptContactUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/accept",rejectContactUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/reject",holdContactUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/hold",endContactUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/end",resumeContactUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/resume",dialPhoneUri:"/services/v2.0/agent-sessions/{sessionId}/dial-phone",dialSkillUri:"/services/v2.0/agent-sessions/{sessionId}/dial-skill",continueReskillUri:"/services/v2.0/agent-sessions/{sessionId}/continue-reskill",dialConsultAgentUri:"/services/v2.0/agent-sessions/{sessionId}/consult-agent",dialPersonalQueueUri:"/services/v2.0/agent-sessions/{sessionId}/dial-agent",acceptAgentConsultUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/accept-consult",conferenceContactUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/conference-calls",transferContactUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/transfer-calls",serverTimeUri:"/services/v2.0/server-time",muteAgenUri:"/services/v2.0/agent-sessions/{sessionId}/agent-phone/mute",unmuteAgenUri:"/services/v2.0/agent-sessions/{sessionId}/agent-phone/unmute",getDispositionsUri:"/services/v9.0/skills/{skillId}/dispositions",setDispositionUri:"/services/v9.0/agent-sessions/{sessionId}/interactions/{contactId}/disposition",recordCallUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/record",maskCallUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/mask",unmaskCallUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/unmask",transferWorkItemSkillUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/transfer-work-item-to-skill",transferWorkItemAgentUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/transfer-work-item-to-agent",dialerLogin:"/services/v2.0/agent-sessions/{sessionId}/dialer-login",dialerLogout:"/services/v2.0/agent-sessions/{sessionId}/dialer-logout",dialerAMDOverride:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/amd-override?type={type}",disposeBadCall:"/services/v10.0/agent-sessions/{sessionId}/interactions/{contactId}/amd-override?type={type}",postAddChat:"/services/v2.0/agent-sessions/{sessionId}/interactions/add-chat",sendChatText:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/send-chat-text",activateChat:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/activate-chat",transferChatUri:"/services/v2.0/agent-sessions/{sessionId}/interactions/{contactId}/transfer-chat",transferChatToAgentUri:"/services/v3.0/agent-sessions/{sessionId}/interactions/{contactId}/transfer-chat-to-agent",feedbackUri:"/services/v3.0/agent-sessions/{sessionId}/submit-feedback",sendDTMFUri:"/services/v3.0/agent-sessions/{sessionId}/send-dtmf",transferVoiceMailSkillUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/transfer-voicemail-to-skill",transferVoiceMailAgentUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/transfer-voicemail-to-agent",getAgentUri:"/services/v11.0/agents/{agentId}",getAgentSkillsUri:"/services/v15.0/agents/{agentId}/skills",getSkillAgentsUri:"/services/v15.0/skills/{skillId}/agents",getSkillsUri:"/services/v10.0/skills",getUnavailableCodeUri:"/services/v7.0/unavailable-codes",getTeamUnavailableCodeUri:"/services/v7.0/teams/{teamId}/unavailable-codes?teamId={teamId}",getTeamsUri:"/services/v15.0/teams",getTeamDetailsUri:"/services/v8.0/teams/{teamId}",getAgentSkillAssignmentsUri:"/services/v3.0/agents/skills",getContactStatesUri:"/services/v5.0/agents/{agentId}/interaction-history",getAddressBookAgentNameUri:"/services/v15.0/agents/{username}/address-books",getAddressBookEntriesUri:"/services/v12.0/address-books/{addressBookId}/entries",getDynamicAddressBookEntriesUri:"/services/v4.0/address-books/{addressBookId}/dynamic-entries",getChatTranscript:"/services/v2.0/contacts/{contactId}/chat-transcript",getFeedbackCategoryPriorityUri:"/services/v3.0/feedback-categories-and-priorities",getAgentMessages:"/services/v3.0/agents/{agentId}/messages",getAgentIndicator:"/services/v3.0/agents/{agentId}/indicators",transferEmailToSkillUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/transfer-email-to-skill",transferEmailToAgentUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/transfer-email-to-agent",replyEmailUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/email-reply",forwardEmailUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/email-forward",emailOBUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/email-outbound",sendOBEmailUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/email-send",fileUri:"/services/v4.0/files",quickReplyUri:"/services/v4.0/agents/{agentId}/quick-replies",playVoiceMailUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/play-voicemail",pauseVoiceMailUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{contactId}/pause-voicemail",getScriptListUri:"/services/v4.0/scripts",spawnScriptUri:"/services/v4.0/scripts/{scriptId}/start",signalScriptUri:"/services/v3.0/interactions/{contactId}/signal",getPermissionsUri:"/services/v1.0/permissions/{agentId}",getBusinessUnitUri:"/services/v11.0/business-unit",getPromiseKeeperUri:"/services/v4.0/agents/{agentId}/scheduled-callbacks",getTimeZoneUri:"/services/v5.0/timezones",postPromiseKeeperUri:"/services/v4.0/scheduled-callbacks",updatePromiseKeeperUri:"/services/v4.0/scheduled-callbacks/{callbackId}",reschedulePromiseKeeperUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{callbackId}/reschedule",proceedPromiseKeeperUri:"/services/v4.0/agent-sessions/{sessionId}/interactions/{callbackId}/dial",getBrandingProfilesUri:"/services/v12.0/branding-profiles",getEmailTranscriptUri:"/services/v7.0/contacts/{contactId}/email-transcript",getAgentPerformanceUri:"/services/v3.0/agents/{agentId}/performance",getTeamPerformanceUri:"/services/v15.0/teams/{teamId}/performance-total",getSkillDetailsUri:"/services/v10.0/skills/{skillId}",parkEmailUri:"/services/v7.0/agent-sessions/{sessionId}/interactions/{contactId}/email-park",getParkedEmailDetailsUri:"/services/v7.0/contacts/parked",unParkEmailUri:"/services/v7.0/agent-sessions/{sessionId}/interactions/{contactId}/email-unpark",previewParkedEmailUri:"/services/v7.0/agent-sessions/{sessionId}/interactions/{contactId}/email-preview",emailRestoreUri:"/services/v7.0/agent-sessions/{sessionId}/interactions/{contactId}/email-restore",postAgentTypingIndicator:"/services/v8.0/agent-sessions/{sessionId}/interactions/{contactId}/typing",deleteCallbackUri:"/services/v4.0/scheduled-callbacks/{callbackId}",postAddEmail:"/services/v8.0/agent-sessions/{sessionId}/interactions/add-email",getTagsforSkillUri:"/services/v7.0/skills/{skillId}/tags",postTagsForContactUri:"/services/v7.0/contacts/{contactId}/tags",snoozeContactUri:"/services/v9.0/agent-sessions/{sessionId}/interactions/{contactId}/snooze",getCacheAgentsUri:"/services/v15.0/cache/agentstate",getCacheSkillQueueUri:"/services/v15.0/cache/queues",getEvolveScheduleUri:"/schedules/user/{userId}?start={startDate}&end={endDate}",getCXoneBrandingProfileUri:"/branding-profiles/current",getEvolveSupportedEmbeddedPagesUri:"/navigation_data/links/embedded-client",screenAgentConnectAPI:"http://127.0.0.1:{port}/screenagent/connect",screenAgentDisconnectAPI:"http://127.0.0.1:{port}/screenagent/disconnect",getAgentSettingsAPI:"/services/v14.0/agents/{agentId}/agent-settings",jobList:new PersistentList("icJobs"),jobsProcessing:{},longPollingTimeout:15,inMemStorage:{},pollAgentsCache:!1,amIPolling:!1,callPriority:{Active:0,Holding:0,NaturalCallAMD:1,NaturalCallRinging:2,NaturalCallDialing:3,Disconnected:4},lsUpdateTimes:{skillQueueMapUpdateTime:0,agentSkillMapUpdateTime:0,teamListUpdateTime:0,agentSkillListUpdateTime:0,teamUnavailableListUpdateTime:0,allSkillListUpdateTime:0,allUnavailableListUpdateTime:0},lsKeys:["agentInfo","contacts","agentSkillList","teamUnavailableList","allSkillList","allUnavailableList","sfResult","errorList","OAuthInfo","skillClosed","customVariables","skillQueueMap","agentSkillMap","teamList","icLogLevel","pcQueueContacts","isSkillRunningLow","dispSkillId","chatMsg","chatMsgUpdatedContactId","isPopupClickflag","category","priority","agentMessage","indicators","cHistory","screenPop","lastDispContactId","isLoaded","quickReply","vmPlayBack","permissionsList","isMailSending","fileExtList","promiseKeeperList","timeZoneList","commitmentReminder","brandingProfile","parkedEmailList","parkEmailId","chatPatronTyping","chatPreview","skillTagsMap","tagsLoadedContacts","featuresList","maxConference","isIntegratedSoftphone"],pcDeliveryType:{ClickToCall:!0,TenDigitDialAuto:!0,TenDigitDial:!0},eventKeys:{},currentJobStartTime:0,localeDateTimeFormat:"",localeDateFormat:"",_LightningHeight:646,_LightningWidth:202,getNextEventFailureCount:0,_init:function(){var that=this;this.agentInfo.joinSession=!1,this.agentInfo.dialerLoginTime=0,this.agentInfo.mask=!1,this.agentInfo.lgState="Disconnected",this.jobList.equals=function(a,b){return a.id===b.id},!0===IC_Common.isIE11()&&this.preventSelfClosingPopupWindow(),window.addEventListener?(window.addEventListener("storage",$.proxy(this.onStorageUpdate,this),!1),window.addEventListener("unload",$.proxy(this.onUnload,this),!1)):(window.attachEvent("onstorage",$.proxy(this.onStorageUpdate,this)),window.attachEvent("onunload",$.proxy(this.onUnload,this))),window.onfocus=function(){that.onWindowFocusChanged(!0,!0)},window.onblur=function(){that.onWindowFocusChanged(!0,!1)},this.windowOpenTime=(new Date).getTime(),setTimeout($.proxy(this.processJobs,this),100),IC_Validation.isNotNullOrUndefinedString(localStorage.OAuthInfo)&&(this.OAuthInfo=IC_Common.parseJSON(localStorage.OAuthInfo)),IC_Validation.isNotNullOrUndefinedString(localStorage.callCenterSettings)&&(this.callCenterSettings=IC_Common.parseJSON(localStorage.callCenterSettings))},preventSelfClosingPopupWindow:function(){IC_Validation.isNotNullOrUndefinedString(localStorage.isPopupClickflag)&&(this.inMemStorage.isPopupClickflag=localStorage.isPopupClickflag),IC_Validation.isNotNullOrUndefinedString(localStorage.screenPop)&&(this.screenPop=IC_Common.parseJSON(localStorage.screenPop))},onUnload:function(){this.documentUnloaded=!0;var browserTabKey="browserTab_"+this.browserTabIndex;IC_Validation.isNotNullOrUndefinedString(localStorage[browserTabKey])&&IC_Common.parseJSON(localStorage[browserTabKey]).id===this.browserTabId&&(localStorage.removeItem(browserTabKey),localStorage.noOfBrowserTabs=parseInt(localStorage.noOfBrowserTabs)-1,logger.debug("onUnload "+localStorage.noOfBrowserTabs))},isTokenExpired:function(){if(IC_Validation.isNotNullOrUndefinedString(localStorage.OAuthInfo)&&"{}"!==localStorage.OAuthInfo){var oAuthInfo=IC_Common.parseJSON(localStorage.OAuthInfo);return((new Date).getTime()-oAuthInfo.accessTokenTime)/1e3>=oAuthInfo.expiresIn-120}return!0},isEvolveAuthenticated:function(){return IC_Validation.isNotNullOrUndefinedString(localStorage.authCode)},authenticateEvolve:function(){var icAgentUrl=window.location.href,evolvePageUrl=this.callCenterSettings.evolveAuthUrl+"/login/#/?redirectURL="+encodeURIComponent(icAgentUrl);logger.debug("Evolve page url "+evolvePageUrl),window.location.href=evolvePageUrl},redirectToLoginPage:function(disableAutoLogin){var icAgentUrl=window.location.href.split("?")[0],icLoginPageUrl=location.protocol+"//"+location.host+"/apex/authenticate",queryParams=IC_Common.parseQueryString(window.location.search);IC_Validation.isNotNullOrEmpty(queryParams)&&(icAgentUrl=IC_Common.appendQueryString(icAgentUrl,queryParams),queryParams.redirectURL=icAgentUrl,queryParams.disableAutoLogin=disableAutoLogin,icLoginPageUrl=IC_Common.appendQueryString(icLoginPageUrl,queryParams)),window.location.href=icLoginPageUrl},openWfo:function(vfPageUrl,wfoUrl){wfoUrl=IC_Validation.isNotNullOrEmpty(wfoUrl)?wfoUrl:this.callCenterSettings.evolveWebServerUrl+"/sso/#/landingPage",this.wfoUrl=wfoUrl,localStorage.wfoUrl=wfoUrl,logger.debug("openWfo >>> url:"+wfoUrl),AgentConsoleSalesforce.openCXone(vfPageUrl)},isEvolve:function(){return IC_Validation.isNotNullOrUndefinedString(this.callCenterSettings.authMode)&&"evolve"===this.callCenterSettings.authMode.toLowerCase()},isSSO:function(){return IC_Validation.isNotNullOrUndefinedString(this.callCenterSettings.icCustomDomain)},getAuthMode:function(){return IC_Validation.isNotNullOrUndefinedString(this.callCenterSettings.authMode)?this.callCenterSettings.authMode.toLowerCase():"incontact"},initializeTab:function(){var browserTabKey,browserTab,newTabIndex=1,focusTime=0,that=this;if(IC_Validation.isNumber(localStorage.noOfBrowserTabs)){for(browserTabKey="browserTab_"+(newTabIndex=parseInt(localStorage.noOfBrowserTabs));!IC_Validation.isNotNullOrUndefinedString(localStorage[browserTabKey])&&newTabIndex>0;)logger.info("removing dead tab index: "+newTabIndex),newTabIndex=parseInt(localStorage.noOfBrowserTabs)-1,localStorage.noOfBrowserTabs=newTabIndex,browserTabKey="browserTab_"+newTabIndex;newTabIndex=parseInt(localStorage.noOfBrowserTabs)+1}browserTabKey="browserTab_"+(newTabIndex=this.getTabIndex(newTabIndex)),this.browserTabIndex=newTabIndex,this.browserTabId=IC_Common.generateUniqueId("window"),IC_Validation.isNotNullOrUndefinedString(sessionStorage.lastFocusTime)&&(focusTime=IC_Common.toNumber(sessionStorage.lastFocusTime),logger.debug("setting focusTime : "+focusTime)),browserTab={id:this.browserTabId,lastUpdateTime:(new Date).getTime(),focusTime:focusTime,pageId:"",pageOpenTime:0,isVisForce:!1},logger.debug("adding tab: "+browserTabKey+" | tabId: "+browserTab.id),localStorage[browserTabKey]=JSON.stringify(browserTab),localStorage.noOfBrowserTabs=newTabIndex,this.setSoftphoneHeightWidth(),this.amIPopoutWindow||AgentConsoleSalesforce.getPageInfo(function(pageInfo){logger.debug("initializeTab - getPageInfo :"+JSON.stringify(pageInfo));var currentTab,url,result=AgentConsoleSalesforce.parsePageInfoResult(pageInfo),pageId="",currentTabKey="browserTab_"+that.browserTabIndex,isVisualForce=!0;IC_Validation.isNotNullOrEmpty(result.object)?(pageId=result.objectId,isVisualForce=!1):(url=IC_Common.parseUrl(result.url),pageId=IC_Common.getParameterByName(url.search,"_c")),IC_Validation.isNotNullOrUndefinedString(localStorage[currentTabKey])&&(logger.info("initializeTab - storing tab: "+currentTabKey+" pageID: "+pageId+" pageOpenTime: "+that.windowOpenTime),(currentTab=IC_Common.parseJSON(localStorage[currentTabKey])).pageId=pageId,currentTab.pageOpenTime=that.windowOpenTime,currentTab.isVisForce=isVisualForce,localStorage[currentTabKey]=JSON.stringify(currentTab))})},loadDataStores:function(){if(IC_Validation.isNotNullOrUndefinedString(localStorage.customVariables)&&(this.customVariables=IC_Common.parseJSON(localStorage.customVariables)),AgentConsoleDataStore.lastNewSkillQueueUpdateTime!=localStorage.lastNewSkillQueueUpdateTime&&(AgentConsoleDataStore.lastNewSkillQueueUpdateTime=parseInt(localStorage.lastNewSkillQueueUpdateTime)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentSettings)&&(this.agentSettings=IC_Common.parseJSON(localStorage.agentSettings)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentInfo)&&(this.agentInfo=IC_Common.parseJSON(localStorage.agentInfo),$(document).trigger(this.AgentInfoEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.allUnavailableList)&&(this.allUnavailableList=IC_Common.parseJSON(localStorage.allUnavailableList),$(document).trigger(this.AllUnavailableCodeListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.allSkillList)&&(this.allSkillList=IC_Common.parseJSON(localStorage.allSkillList),$(document).trigger(this.SkillListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.teamUnavailableList)&&(this.teamUnavailableList=IC_Common.parseJSON(localStorage.teamUnavailableList),$(document).trigger(this.UnavailableListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentSkillList)&&(this.agentSkillList=IC_Common.parseJSON(localStorage.agentSkillList),$(document).trigger(this.AgentSkillListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentSkillMap)&&(this.agentSkillMap=IC_Common.parseJSON(localStorage.agentSkillMap),$(document).trigger(this.AgentSkillAssignmentsEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.teamList)&&(this.teamList=IC_Common.parseJSON(localStorage.teamList),$(document).trigger(this.TeamListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.permissionsList)&&(this.permissionsList=IC_Common.parseJSON(localStorage.permissionsList),$(document).trigger(this.PermissionsListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.fileExtList)&&(this.fileExtList=IC_Common.parseJSON(localStorage.fileExtList),$(document).trigger(this.FileExtensionsListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.maxConference)&&(this.maxConference=parseInt(localStorage.maxConference,10),$(document).trigger(this.MaxConferenceHandleEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.isIntegratedSoftphone)&&(this.isIntegratedSoftphone=IC_Common.toBoolean(localStorage.isIntegratedSoftphone)),IC_Validation.isNotNullOrUndefinedString(localStorage.brandingProfile)&&(this.isEvolve()?this.getCXOneBrandingProfiles(function(){}):(this.brandingProfile=IC_Common.parseJSON(localStorage.brandingProfile),$(document).trigger(this.BrandingProfilesEvent))),IC_Validation.isNotNullOrUndefinedString(localStorage.promiseKeeperList)&&(this.promiseKeeperList=IC_Common.parseJSON(localStorage.promiseKeeperList),$(document).trigger(this.PromiseKeeperEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.timeZoneList)&&(this.timeZoneList=IC_Common.parseJSON(localStorage.timeZoneList),$(document).trigger(this.TimeZoneEvent)),this.tagsLoadedContacts=localStorage.tagsLoadedContacts?IC_Common.parseJSON(localStorage.tagsLoadedContacts):[],IC_Validation.isNotNullOrUndefinedString(localStorage.skillTagsMap)&&(this.skillTagsMap=IC_Common.parseJSON(localStorage.skillTagsMap)),IC_Validation.isNotNullOrUndefinedString(localStorage.persistEmailInfo)&&(this.persistEmailInfo=IC_Common.parseJSON(localStorage.persistEmailInfo)),IC_Validation.isNotNullOrUndefinedString(localStorage.contacts))if(this.contacts=IC_Common.parseJSON(localStorage.contacts),IC_Validation.isNotNullOrUndefinedString(localStorage.lastDispContactId)&&(this.lastDispContactId=localStorage.lastDispContactId),0===this.contacts.length)localStorage.removeItem("sfResult");else if(IC_Validation.isNotNullOrUndefinedString(localStorage.sfResult)&&(this.sfResult=IC_Common.parseJSON(localStorage.sfResult)),$(document).trigger(this.ContactEvent),IC_Validation.isNotNullOrEmptyArray(this.sfResult)){var that=this;this.isInConsoleView||this.amIPopoutWindow||AgentConsoleSalesforce.getPageInfo(function(pageInfo){that.processObjectInfo(pageInfo)})}IC_Validation.isNotNullOrUndefinedString(localStorage.chatMsg)&&(IC_Validation.isNotNullOrUndefinedString(localStorage.chatMsgUpdatedContactId)&&(this.chatMsgUpdatedContactId=localStorage.chatMsgUpdatedContactId),this.chatMsg=IC_Common.parseJSON(localStorage.chatMsg),$(document).trigger(this.ChatMsgEvent,!0)),IC_Validation.isNotNullOrUndefinedString(localStorage.vmPlayBack)&&(this.vmPlayBack=IC_Common.parseJSON(localStorage.vmPlayBack),$(document).trigger(this.VoiceMailPlayBackEvent,!0)),IC_Validation.isNotNullOrUndefinedString(localStorage.pcQueueContacts)&&(this.pcQueueContacts=IC_Common.parseJSON(localStorage.pcQueueContacts),$(document).trigger(this.PCQueueEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.isSkillRunningLow)&&(this.isSkillRunningLow=IC_Common.toBoolean(localStorage.isSkillRunningLow),$(document).trigger(this.SkillRunningLowEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.icLogLevel)&&(IC_Util.LogLevel=localStorage.icLogLevel,$(document).trigger(IC_Util.LogLevelEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.category)&&IC_Validation.isNotNullOrUndefinedString(localStorage.priority)&&(this.category=IC_Common.parseJSON(localStorage.category),this.priority=IC_Common.parseJSON(localStorage.priority),$(document).trigger(this.FeedbackCategoryEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentMessage)&&(this.agentMessage=IC_Common.parseJSON(localStorage.agentMessage),$(document).trigger(this.AgentMessageEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.indicators)&&(this.indicators=IC_Common.parseJSON(localStorage.indicators),$(document).trigger(this.AgentIndicatorEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.cHistory)&&(this.cHistoryArr=IC_Common.parseJSON(localStorage.cHistory),this.fireContactHistorySortEvent()),IC_Validation.isNotNullOrUndefinedString(localStorage.skillQueueMap)&&(this.lsUpdateTimes.skillQueueMapUpdateTime=localStorage.skillQueueMapUpdateTime,this.skillQueueMap=IC_Common.parseJSON(localStorage.skillQueueMap),$(document).trigger(this.SkillQueueEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.isMailSending)&&(this.isMailSending=IC_Common.toBoolean(localStorage.isMailSending),$(document).trigger(this.MailProgressEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.parkedEmailList)&&(this.parkedEmailList=IC_Common.parseJSON(localStorage.parkedEmailList),$(document).trigger(this.ParkedEmailDetailsEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.chatPatronTyping)&&(this.chatPatronTyping=IC_Common.parseJSON(localStorage.chatPatronTyping),$(document).trigger(this.ChatPatronTypingEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.chatPreview)&&(this.chatPreview=IC_Common.parseJSON(localStorage.chatPreview),$(document).trigger(this.ChatPreviewEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.pcPreviewNotes)&&(this.pcPreviewNotes=IC_Common.parseJSON(localStorage.pcPreviewNotes),$(document).trigger(this.PCPreviewNotesUpdate)),IC_Validation.isNotNullOrUndefinedString(localStorage.featuresList)&&(this.featuresList=IC_Common.parseJSON(localStorage.featuresList),$(document).trigger(this.BUFeaturesListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.getNextEventFailureCount)&&(this.getNextEventFailureCount=parseInt(localStorage.getNextEventFailureCount,10)),this.customVariables&&this.customVariables.UserCredential&&this.customVariables.UserCredential.agentAudioSettings&&(this.agentAudioSettings=this.customVariables.UserCredential.agentAudioSettings,this.agentVisualSettings=this.customVariables.UserCredential.agentVisualSettings)},onStorageUpdate:function(e){e||(e=window.event);var forceUpdate=!1;IC_Common.isIE11()&&this.eventKeys.hasOwnProperty(e.key)&&(forceUpdate=!0,this.updateEventKeys(e.key,!1)),"nextEventUpdated"===e.key?(e.newValue&&this.fireStorageEvent({key:e.newValue,newValue:localStorage[e.newValue]},!1),localStorage.removeItem("nextEventUpdated")):this.fireStorageEvent(e,forceUpdate)},fireStorageEvent:function(e,forceUpdate){var decompressedValue="";if("agentInfo"===e.key)(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&JSON.stringify(this.agentInfo)!=e.newValue||!0===forceUpdate)&&(this.agentInfo=IC_Common.parseJSON(e.newValue),$(document).trigger(this.AgentInfoEvent));else if("contacts"===e.key)IC_Validation.isNotNullOrEmpty(e.newValue)&&(JSON.stringify(this.contacts)==e.newValue&&!0!==forceUpdate||(this.processContact(e.newValue),this.contacts=IC_Common.parseJSON(e.newValue),IC_Validation.isNotNullOrEmptyArray(this.contacts)&&$(document).trigger(this.ContactEvent)));else if("agentSkillList"===e.key)(this.lsUpdateTimes.agentSkillListUpdateTime<localStorage.agentSkillListUpdateTime||!0===forceUpdate)&&(this.lsUpdateTimes.agentSkillListUpdateTime=localStorage.agentSkillListUpdateTime,JSON.stringify(this.agentSkillList)==e.newValue&&!0!==forceUpdate||(this.agentSkillList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.AgentSkillListEvent)));else if("teamUnavailableList"===e.key)(this.lsUpdateTimes.teamUnavailableListUpdateTime<localStorage.teamUnavailableListUpdateTime||!0===forceUpdate)&&(this.lsUpdateTimes.teamUnavailableListUpdateTime=localStorage.teamUnavailableListUpdateTime,JSON.stringify(this.teamUnavailableList)==e.newValue&&!0!==forceUpdate||(this.teamUnavailableList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.UnavailableListEvent)));else if("allSkillList"===e.key)IC_Validation.isNotNullOrUndefinedString(e.newValue)&&(this.lsUpdateTimes.allSkillListUpdateTime<localStorage.allSkillListUpdateTime||!0===forceUpdate||!0===IC_Common.isIE11())&&(this.lsUpdateTimes.allSkillListUpdateTime=localStorage.allSkillListUpdateTime,decompressedValue=e.newValue,JSON.stringify(this.allSkillList)==decompressedValue&&!0!==forceUpdate||(IC_Validation.isNotNullOrUndefinedString(this.getIcSessionId())||"{}"!==decompressedValue?this.isLoaded=!0:this.isLoaded=!1,this.allSkillList=IC_Common.parseJSON(decompressedValue),$(document).trigger(this.SkillListEvent)));else if("allUnavailableList"===e.key)(this.lsUpdateTimes.allUnavailableListUpdateTime<localStorage.allUnavailableListUpdateTime||!0===forceUpdate)&&(this.lsUpdateTimes.allUnavailableListUpdateTime=localStorage.allUnavailableListUpdateTime,JSON.stringify(this.allUnavailableList)==e.newValue&&!0!==forceUpdate||(this.allUnavailableList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.AllUnavailableCodeListEvent)));else if("sfResult"===e.key)IC_Validation.isNotNullOrUndefinedString(e.newValue)?JSON.stringify(this.sfResult)==e.newValue&&!0!==forceUpdate||(this.sfResult=IC_Common.parseJSON(e.newValue),IC_Validation.isNotNullOrEmptyArray(this.sfResult)&&$(document).trigger(this.ContactResultEvent)):this.sfResult=[];else if("errorList"===e.key)JSON.stringify(this.errorList)==e.newValue&&!0!==forceUpdate||(this.errorList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.APIErrorEvent));else if("OAuthInfo"===e.key)IC_Validation.isNotNullOrUndefinedString(e.newValue)&&(JSON.stringify(this.OAuthInfo)==e.newValue&&!0!==forceUpdate||(this.OAuthInfo=IC_Common.parseJSON(e.newValue),this.getCacheAgents()));else if("skillClosed"===e.key)(this.skillClosed!=e.newValue&&JSON.stringify(this.skillClosed)!=e.newValue||!0===forceUpdate)&&(this.skillClosed=IC_Common.parseJSON(e.newValue),$(document).trigger(this.SkillClosedHoursEvent));else if("customVariables"===e.key)JSON.stringify(this.customVariables)==e.newValue&&!0!==forceUpdate||(this.customVariables=IC_Common.parseJSON(e.newValue),$(document).trigger(this.CustomVariablesEvent));else if("skillQueueMap"===e.key)(this.lsUpdateTimes.skillQueueMapUpdateTime<localStorage.skillQueueMapUpdateTime||!0===forceUpdate)&&(this.lsUpdateTimes.skillQueueMapUpdateTime=localStorage.skillQueueMapUpdateTime,JSON.stringify(this.skillQueueMap)==e.newValue&&!0!==forceUpdate||(this.skillQueueMap=IC_Common.parseJSON(e.newValue),$(document).trigger(this.SkillQueueEvent)));else if("agentSkillMap"===e.key)(this.lsUpdateTimes.agentSkillMapUpdateTime<localStorage.agentSkillMapUpdateTime||!0===forceUpdate)&&(this.lsUpdateTimes.agentSkillMapUpdateTime=localStorage.agentSkillMapUpdateTime,JSON.stringify(this.agentSkillMap)==e.newValue&&!0!==forceUpdate||(this.agentSkillMap=IC_Common.parseJSON(e.newValue),$(document).trigger(this.AgentSkillAssignmentsEvent)));else if("teamList"===e.key)(this.lsUpdateTimes.teamListUpdateTime<localStorage.teamListUpdateTime||!0===forceUpdate)&&(this.lsUpdateTimes.teamListUpdateTime=localStorage.teamListUpdateTime,JSON.stringify(this.teamList)==e.newValue&&!0!==forceUpdate||(this.teamList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.TeamListEvent)));else if("icLogLevel"===e.key)IC_Validation.isNotNullOrEmpty(e.newValue)&&(IC_Util.LogLevel==e.newValue&&!0!==forceUpdate||(IC_Util.LogLevel=e.newValue,$(document).trigger(IC_Util.LogLevelEvent)));else if("pcQueueContacts"===e.key)IC_Validation.isNotNullOrEmpty(e.newValue)&&(JSON.stringify(this.pcQueueContacts)==e.newValue&&!0!==forceUpdate||(this.pcQueueContacts=IC_Common.parseJSON(e.newValue),$(document).trigger(this.PCQueueEvent)));else if("isSkillRunningLow"===e.key)this.isSkillRunningLow==IC_Common.toBoolean(e.newValue)&&!0!==forceUpdate||(this.isSkillRunningLow=IC_Common.toBoolean(e.newValue),$(document).trigger(this.SkillRunningLowEvent));else if("dispSkillId"===e.key)this.inMemStorage.dispSkillId==e.newValue&&!0!==forceUpdate||(this.inMemStorage.dispSkillId=e.newValue,$(document).trigger(this.DispositionEvent,[e.newValue]));else if("chatMsg"===e.key)JSON.stringify(this.chatMsg)==e.newValue&&!0!==forceUpdate||(this.chatMsg=IC_Common.parseJSON(e.newValue),$(document).trigger(this.ChatMsgEvent));else if("chatMsgUpdatedContactId"===e.key)this.chatMsgUpdatedContactId=e.newValue;else if("isPopupClickflag"===e.key)this.inMemStorage.isPopupClickflag!=e.newValue&&(this.inMemStorage.isPopupClickflag=e.newValue,this.closePopup());else if("category"===e.key)JSON.stringify(this.category)!=e.newValue&&(this.category=IC_Common.parseJSON(e.newValue),$(document).trigger(this.FeedbackCategoryEvent));else if("priority"===e.key)JSON.stringify(this.priority)==e.newValue&&!0!==forceUpdate||(this.priority=IC_Common.parseJSON(e.newValue),$(document).trigger(this.FeedbackCategoryEvent));else if("agentMessage"===e.key)(IC_Validation.isNotNullOrUndefinedString(this.agentMessage)&&JSON.stringify(this.agentMessage)!=e.newValue||!0===forceUpdate)&&(this.agentMessage=IC_Common.parseJSON(e.newValue),$(document).trigger(this.AgentMessageEvent));else if("indicators"===e.key)(IC_Validation.isNotNullOrUndefinedString(this.indicators)&&JSON.stringify(this.indicators)!=e.newValue||!0===forceUpdate)&&(this.indicators=IC_Common.parseJSON(e.newValue),$(document).trigger(this.AgentIndicatorEvent));else if("cHistory"===e.key)IC_Validation.isNotNullOrUndefinedString(e.newValue)&&JSON.stringify(this.cHistory)!=e.newValue&&(this.cHistoryArr=IC_Common.parseJSON(e.newValue),this.fireContactHistorySortEvent());else if("screenPop"===e.key)e.newValue=localStorage.screenPop,!IC_Validation.isNotNullOrUndefinedString(e.newValue)||JSON.stringify(this.screenPop)==e.newValue&&!0!==forceUpdate||(this.screenPop=IC_Common.parseJSON(e.newValue),this.screenPop.hasOwnProperty("type")&&this.controlledScreenPop(this.screenPop.type,this.screenPop.url,this.screenPop.contactResult,this.screenPop.popId));else if("isLoaded"===e.key)IC_Validation.isNotNullOrUndefinedString(e.newValue)&&this.isLoaded!=e.newValue&&(this.isLoaded=IC_Common.toBoolean(e.newValue));else if("lastDispContactId"===e.key)(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&this.lastDispContactId!=e.newValue||!0===forceUpdate)&&(this.lastDispContactId=e.newValue,IC_Validation.isNotNullOrEmptyArray(this.contacts)&&$(document).trigger(this.ContactEvent));else if("quickReply"===e.key)(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&JSON.stringify(this.quickReply)!=e.newValue||!0===forceUpdate)&&(this.quickReply=IC_Common.parseJSON(e.newValue),$(document).trigger(this.QuickReplyEvent));else if("vmPlayBack"===e.key)(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&JSON.stringify(this.vmPlayBack)!=e.newValue||!0===forceUpdate)&&(this.vmPlayBack=IC_Common.parseJSON(e.newValue),$(document).trigger(this.VoiceMailPlayBackEvent));else if("permissionsList"===e.key)(IC_Validation.isNotNullOrEmpty(e.newValue)&&JSON.stringify(this.permissionsList)!=e.newValue||!0===forceUpdate)&&(this.permissionsList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.PermissionsListEvent));else if("isMailSending"===e.key)(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&this.isMailSending!==IC_Common.toBoolean(e.newValue)||!0===forceUpdate)&&(this.isMailSending=IC_Common.toBoolean(e.newValue),$(document).trigger(this.MailProgressEvent));else if("fileExtList"===e.key)JSON.stringify(this.fileExtList)==e.newValue&&!0!==forceUpdate||(this.fileExtList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.FileExtensionsListEvent));else if("promiseKeeperList"===e.key)(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&JSON.stringify(this.promiseKeeperList)!=e.newValue||!0===forceUpdate)&&(this.promiseKeeperList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.PromiseKeeperEvent));else if("timeZoneList"===e.key)(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&JSON.stringify(this.timeZoneList)!=e.newValue||!0===forceUpdate)&&(this.timeZoneList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.TimeZoneEvent));else if("brandingProfile"===e.key)JSON.stringify(this.brandingProfile)==e.newValue&&!0!==forceUpdate||(this.brandingProfile=IC_Common.parseJSON(e.newValue),$(document).trigger(this.BrandingProfilesEvent));else if("commitmentReminder"===e.key){if(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&JSON.stringify(this.commitmentReminder)!=e.newValue||!0===forceUpdate){var reminderData=this.commitmentReminder=IC_Common.parseJSON(e.newValue);switch(reminderData.action){case"reschedule":$(document).trigger(this.RescheduleCommitmentReminderEvent,reminderData.data);break;case"proceed":$(document).trigger(this.ProceedCommitmentReminderEvent,reminderData.data);break;case"autoReschedule":if("true"!==localStorage.isRescheduleInProgress){localStorage.isRescheduleInProgress="true";var newCommitmentDate=new Date,existingMinutes=newCommitmentDate.getMinutes();newCommitmentDate.setMinutes(0),newCommitmentDate.setMinutes(existingMinutes+5),this.reschedulePromieKeeper(reminderData.data.callbackId,IC_Common.toUTCDateString(newCommitmentDate),function(){},function(){})}break;case"complete":$(document).trigger(this.RescheduleCommitmentReminderCompletedEvent)}}}else"parkedEmailList"===e.key?(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&JSON.stringify(this.parkedEmailList)!=e.newValue||!0===forceUpdate)&&(this.parkedEmailList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.ParkedEmailDetailsEvent)):"parkEmailId"===e.key?(IC_Validation.isNotNullOrUndefinedString(e.newValue)&&this.parkEmailId!=e.newValue||!0===forceUpdate)&&(this.parkEmailId=e.newValue,$(document).trigger(this.EmailParkEvent),localStorage.parkEmailId="",this.parkEmailId=""):"inboxLimitValidation"===e.key?"true"===localStorage.inboxLimitValidation&&($(document).trigger(this.ParkedEmailLimitValidation),localStorage.inboxLimitValidation="false"):"pcPreviewNotes"===e.key?IC_Validation.isNotNullOrUndefinedString(e.newValue)&&(JSON.stringify(this.pcPreviewNotes)==e.newValue&&!0!==forceUpdate||(this.pcPreviewNotes=IC_Common.parseJSON(e.newValue),IC_Validation.isValidObject(this.pcPreviewNotes)&&$(document).trigger(this.PCPreviewNotesUpdate))):"chatPatronTyping"===e.key?IC_Validation.isNotNullOrEmpty(e.newValue)&&(JSON.stringify(this.chatPatronTyping)==e.newValue&&!0!==forceUpdate||(this.chatPatronTyping=IC_Common.parseJSON(e.newValue),IC_Validation.isNotNullOrEmptyArray(this.chatPatronTyping)&&$(document).trigger(this.ChatPatronTypingEvent))):"chatPreview"===e.key?IC_Validation.isNotNullOrEmpty(e.newValue)&&(JSON.stringify(this.chatPreview)==e.newValue&&!0!==forceUpdate||(this.chatPreview=IC_Common.parseJSON(e.newValue),IC_Validation.isNotNullOrEmptyArray(this.chatPreview)&&$(document).trigger(this.ChatPreviewEvent))):"skillTagsMap"===e.key?IC_Validation.isNotNullOrEmpty(e.newValue)&&(JSON.stringify(this.skillTagsMap)==e.newValue&&!0!==forceUpdate||(this.skillTagsMap=IC_Common.parseJSON(e.newValue),$(document).trigger(this.SkillTagsUpdateEvent))):"tagsUpdatedContact"===e.key?JSON.stringify(this.tagsUpdatedContact)==e.newValue&&!0!==forceUpdate||(this.tagsUpdatedContact=IC_Common.parseJSON(e.newValue),$(document).trigger(this.TagsUpdatedContactEvent)):"tagsLoadedContacts"===e.key?JSON.stringify(this.tagsLoadedContacts)==e.newValue&&!0!==forceUpdate||(this.tagsLoadedContacts=IC_Common.parseJSON(e.newValue)):"featuresList"===e.key?JSON.stringify(this.featuresList)==e.newValue&&!0!==forceUpdate||(this.featuresList=IC_Common.parseJSON(e.newValue),$(document).trigger(this.BUFeaturesListEvent)):"callCenterSettings"===e.key?IC_Validation.isNotNullOrUndefinedString(e.newValue)&&(JSON.stringify(this.callCenterSettings)==e.newValue&&!0!==forceUpdate||(this.callCenterSettings=IC_Common.parseJSON(e.newValue))):"maxConference"===e.key?JSON.stringify(this.maxConference)==e.newValue&&!0!==forceUpdate||(this.maxConference=parseInt(e.newValue,10),$(document).trigger(this.MaxConferenceHandleEvent)):"omniChannelRoutingInfo"===e.key?JSON.stringify(this.omniChannelRoutingInfo)==e.newValue&&!0!==forceUpdate||(this.omniChannelRoutingInfo=IC_Common.parseJSON(e.newValue),$(document).trigger(this.OmniChannelReadyStateChangedEvent)):"agentLegAcceptRejectActions"===e.key&&(this.agentLegAcceptRejectActions==e.newValue&&!0!==forceUpdate||(this.agentLegAcceptRejectActions=e.newValue,$(document).trigger(this.agentLegAcceptRejectActionsEvent)))},closePopup:function(){!0===this.amIPopoutWindow&&(localStorage.isPopClose=!0,this.canClearPopValues=!1,window.close())},getGlobalLogLevel:function(){return localStorage.getItem("icLogLevel")},setGlobalLogLevel:function(level){try{log4javascript.getLevelByName(level),IC_Util.LogLevel=level,localStorage.setItem("icLogLevel",level),this.triggerEvent("icLogLevel",IC_Util.LogLevelEvent)}catch(ex){logger.error("setGlobalLogLevel: ",ex.message)}},getLogger:function(){return logger},amIFirstTab:function(){try{var firstTab=IC_Common.parseJSON(localStorage.browserTab_1);return IC_Validation.isValidObject(firstTab)&&firstTab.id===this.browserTabId}catch(ex){logger.error("amIFirstTab: ",ex.message)}return!1},getPersistEmailInfo:function(contactId){for(var persistInfos=this.persistEmailInfo,i=0,length=persistInfos.length;i<length;i++)if(persistInfos[i].id==contactId)return persistInfos[i];return null},setPersistEmailInfo:function(data){this.persistEmailInfo.addOrUpdate(data,function(a,b){return a.id===b.id}),localStorage.persistEmailInfo=JSON.stringify(this.persistEmailInfo)},checkPollingWindow:function(){var currentTabKey="browserTab_"+this.browserTabIndex,prevTabKey="browserTab_"+(this.browserTabIndex-1),firstTab=null,prevTab=null,currentTab=null,that=this;IC_Validation.isNotNullOrUndefinedString(localStorage[currentTabKey])?(currentTab=IC_Common.parseJSON(localStorage[currentTabKey])).id===this.browserTabId?(currentTab.lastUpdateTime=(new Date).getTime(),this.browserTabIndex>=2&&(IC_Validation.isNotNullOrUndefinedString(localStorage[prevTabKey])?(prevTab=IC_Common.parseJSON(localStorage[prevTabKey]),(!IC_Validation.isNumber(prevTab.lastUpdateTime)||(new Date).getTime()-prevTab.lastUpdateTime>=5e3)&&(localStorage.removeItem(currentTabKey),localStorage.noOfBrowserTabs=parseInt(localStorage.noOfBrowserTabs)-1,logger.debug("Advancing tab: "+currentTabKey+" | "+currentTab.id),logger.info("Advancing tab: "+currentTabKey+" | "+currentTab.id),this.browserTabIndex--,currentTabKey=prevTabKey)):(logger.debug("Advancing tab: "+currentTabKey+" | "+currentTab.id),logger.info("Advancing tab as none exists: "+currentTabKey+" | "+currentTab.id),localStorage.removeItem(currentTabKey),this.browserTabIndex--,currentTabKey=prevTabKey)),localStorage[currentTabKey]=JSON.stringify(currentTab),IC_Validation.isNotNullOrUndefinedString(localStorage.browserTab_1)&&(firstTab=IC_Common.parseJSON(localStorage.browserTab_1),IC_Validation.isValidObject(firstTab)&&firstTab.id===this.browserTabId&&!0!==this.amIPolling&&!0===this.isLoaded&&(IC_Common.isIE11()?!0!==this.setPollingTimeout&&(this.setPollingTimeout=!0,setTimeout(function(){that.setPollingTimeout=!1,that.amIPolling=!0,logger.info("Triggering GetNextEvent and GetCacheSkillQueue"),that.getNextEvent(),that.getCacheSkillQueue(),that.getFeedbackCategoryAndPriority()},3e3)):(this.amIPolling=!0,logger.info("Triggering GetNextEvent and GetCacheSkillQueue"),this.getNextEvent(),this.getCacheSkillQueue(),this.getFeedbackCategoryAndPriority())))):(this.amIPolling=!1,logger.info("Re-Adding tab - Duplicate exists."),this.initializeTab()):!1===this.documentUnloaded&&(logger.info("Re-Adding tab"),this.initializeTab())},isSessionStarted:function(){return IC_Common.toBoolean(localStorage.isSessionStarted)},setSessionStarted:function(isSessionStarted){localStorage.isSessionStarted=isSessionStarted},setCustomVar:function(key,value){this.customVariables[key]=value,localStorage.customVariables=JSON.stringify(this.customVariables),this.triggerEvent("customVariables",this.CustomVariablesEvent)},getCustomVar:function(key){return IC_Validation.isNullOrEmpty(this.customVariables)&&(this.customVariables={}),this.customVariables[key]},getServerTimestamp:function(onSuccess,onError){var now=(new Date).getTime(),localTimeOnStart=localStorage.localTimestampOnStart,serverTimeOnStart=localStorage.serverTimestampOnStart;return IC_Validation.isNumber(localTimeOnStart)&&IC_Validation.isNumber(serverTimeOnStart)?parseInt(serverTimeOnStart)+(now-parseInt(localTimeOnStart)):now},addJob:function(job){if(IC_Common.isIE11()&&IC_Validation.isNotNull(job)&&"PopTask"==job.type&&IC_Validation.isNotNull(job.data)){var contactID=IC_Common.getCookie("icLastTaskContactID");logger.trace("icLastTaskContactID cookie value "+contactID);var contact=job.data.contact;if(IC_Validation.isNotNull(contact)){if(contact.id==contactID)return void logger.trace("ContactID: "+contact.contactID,"Job is already in the list: "+job.id+" | "+job.type);IC_Common.setCookie("icLastTaskContactID",contact.id,1),logger.trace("icLastTaskContactID cookie value set "+contact.id)}}logger.debug("Adding Job: "+job.id+" | "+job.type),this.jobList.add(job)},addPollingWindowJob:function(job){logger.debug("addPollingWindowJob amIPolling : "+this.amIPolling),this.amIPolling&&this.addJob(job)},addIntervalJob:function(type,interval,hitCount,successCallback,data){logger.info("Adding job :"+type);var callback="";-1!==hitCount&&(interval*=10),hitCount++,IC_Validation.isNullOrEmpty(successCallback)||(callback=successCallback),IC_Validation.isNullOrEmpty(data)||(data=""),this.addJob({id:IC_Common.generateUniqueId("job"),type:type,interval:interval,lastExecutedTime:(new Date).getTime(),hitCount:hitCount,callback:callback,data:data})},removeJob:function(job){logger.debug("Remove Job: "+job.id+" | "+job.type),this.jobList.remove(job),delete this.jobsProcessing[job.id]},processJobs:function(){var that=this;!0===this.amIPolling&&this.jobList.forEach(function(i,job){try{if(logger.debug("jobList count "+that.jobList.count()),that.jobsProcessing.hasOwnProperty(job.id)||!0!==that.isLoaded)return!0===job.sync&&(job.hasOwnProperty("processTimeout")&&that.currentJobStartTime+job.processTimeout<(new Date).getTime()&&(that.removeJob(job),that.addJob(job)),!0);if(job.hasOwnProperty("interval")&&job.lastExecutedTime+job.interval>(new Date).getTime())return!0===job.sync;switch(logger.debug("Executing Job: "+job.id+" | "+job.type),job.type){case"ContactSearch":that.jobsProcessing[job.id]=!0,that.contactSearch(job);break;case"CleanupContact":that.jobsProcessing[job.id]=!0,that.callWrap(job);break;case"PopTask":that.jobsProcessing[job.id]=!0,that.popTask(job);break;case"PostContactWork":that.jobsProcessing[job.id]=!0,that.postContactWork(job);break;case"CreateTask":that.jobsProcessing[job.id]=!0,that.createTask(job);break;case"GetAgentInfo":that.jobsProcessing[job.id]=!0,that.getAgentInfo(job);break;case"GetTeamUnavailableCodes":that.jobsProcessing[job.id]=!0,that.getTeamUnavailableCodes(job);break;case"GetAgentSkills":that.jobsProcessing[job.id]=!0,that.getAgentSkills(job);break;case"GetAddressBookByAgent":that.jobsProcessing[job.id]=!0,that.getAddressBookByAgent(job);break;case"ScreenPop":that.jobsProcessing[job.id]=!0,that.salesforceScreenPop(job);break;case"CanPopTask":that.jobsProcessing[job.id]=!0,that.updateSfResultScreenPop(job);break;case"GetAgentSkillAssignments":that.jobsProcessing[job.id]=!0,that.getAgentSkillAssignments(job);break;case"GetAllSkills":that.jobsProcessing[job.id]=!0,that.getAllSkills(job);break;case"GetAllUnavailableCodes":that.jobsProcessing[job.id]=!0,that.getAllUnavailableCodes(job);break;case"GetTeams":that.jobsProcessing[job.id]=!0,that.getTeams(job);break;case"GetTeamDetails":that.jobsProcessing[job.id]=!0,that.getTeamDetails(job);break;case"OnUpdateIndicatorsEvent":that.jobsProcessing[job.id]=!0,that.onUpdateIndicatorsEvent(job);break;case"OnUpdateMessagesEvent":that.jobsProcessing[job.id]=!0,that.onUpdateMessagesEvent(job);break;case"OnUpdateChatTranscript":that.jobsProcessing[job.id]=!0,that.onUpdateChatTranscript(job);break;case"GetQuickReply":that.jobsProcessing[job.id]=!0,that.getQuickReply(job);break;case"GetPermissions":that.jobsProcessing[job.id]=!0,that.getPermissions(job);break;case"GetBusinessUnit":that.jobsProcessing[job.id]=!0,that.getBusinessUnit(job);break;case"GetPromiseKeeper":that.jobsProcessing[job.id]=!0,that.getPromiseKeeper(job);break;case"GetTimeZones":that.jobsProcessing[job.id]=!0,that.getTimeZone(job);break;case"GetBrandingProfiles":that.jobsProcessing[job.id]=!0,that.getBrandingProfiles(job);break;case"GetParkedEmails":that.jobsProcessing[job.id]=!0,that.getParkedEmailDetails(!1,job)}if(!0===job.sync)return that.currentJobStartTime=(new Date).getTime(),!0}catch(ex){return logger.error("Error processing job: ",ex.message),that.removeJob(job),!0}}),setTimeout($.proxy(this.processJobs,this),100)},enableClickToDial:function(eventListener){var that=this;AgentConsoleSalesforce.enableClickToDial(function(response){var result;"Lightning"===that.sfMode?IC_Validation.isNotNullOrEmpty(response)&&(result=response):IC_Validation.isNotNullOrEmpty(response.result)&&(result=IC_Common.parseJSON(response.result)),IC_Validation.isNotNullOrEmpty(result)&&(result.number=result.number.replace(/[`~!@$%^&()_|\-=?;:'",.<>\{\}\[\]\\\/\s]/gi,""),eventListener(result))})},disableClickToDial:function(){AgentConsoleSalesforce.disableClickToDial()},getIcSessionId:function(){return localStorage.icSessionId},getAccessTokenByRefreshToken:function(){var that=this;this.refreshAccessToken(this.OAuthInfo.refreshTokenUri,this.OAuthInfo.refreshToken,function(data){if(logger.trace("getTokenByRefreshToken success"),that.getAccessTokenCalled=!1,that.isEvolve()){var response={};response.accessToken=data.token,response.refreshToken=data.refreshToken,response.resource_server_base_uri=that.OAuthInfo.baseUri,response.expiresIn=data.tokenExpirationTimeSec,that.updateEvolveAccessToken(response)}else that.updateNewAccessToken(data)},function(){logger.warn("getTokenByRefreshToken failed, trying authorizationUrl."),that.isEvolve()?(that.flushStore(),that.getAccessTokenCalled=!1,that.updateAgentLogoutState()):that.getAccessToken(that.callCenterSettings.icAuthorizationUrl,"",null,null,null,function(data){logger.trace("refreshAccessToken by authorizationUrl success"),that.getAccessTokenCalled=!1,that.updateNewAccessToken(data),that.agentLogin(function(response,status,statusText){logger.trace("getTokenByRefreshToken >>> getAccessToken <<< agentLogin status:"+status+" statusText:"+statusText)},function(status,statusText){logger.error("getTokenByRefreshToken >>> getAccessToken <<< agentLogin status:"+status+" statusText:"+statusText),that.updateAgentLogoutState()},!0)},function(status,statusText,response){logger.error("refreshAccessToken by authorizationUrl <<< status:"+status+" statusText:"+statusText+" data:"+JSON.stringify(response)),that.getAccessTokenCalled=!1,that.updateAgentLogoutState()})})},updateNewAccessToken:function(data){this.OAuthInfo.accessToken=data.access_token,this.OAuthInfo.baseUri=IC_Common.trimUrl(data.resource_server_base_uri),this.OAuthInfo.refreshToken=data.refresh_token,this.OAuthInfo.refreshTokenUri=data.refresh_token_server_uri,this.OAuthInfo.expiresIn=data.expires_in,this.OAuthInfo.accessTokenTime=(new Date).getTime(),this.updateAuthInfo()},updateEvolveAccessToken:function(response){this.OAuthInfo.accessToken=response.accessToken,this.OAuthInfo.baseUri=IC_Common.trimUrl(response.resource_server_base_uri),this.OAuthInfo.refreshToken=response.refreshToken,this.OAuthInfo.refreshTokenUri=this.callCenterSettings.evolveAuthUrl+"/public/user/refresh",this.OAuthInfo.expiresIn=response.expiresIn,this.OAuthInfo.accessTokenTime=(new Date).getTime(),this.updateAuthInfo()},loginAgent:function(sfUserId,stationId,phoneNo,onSuccess,onError,isAutoLoginDisabled){if(this.isEvolve()&&(this.isAutoLogin=!1),!0!==this.checkPollingStarted&&(setInterval($.proxy(this.checkPollingWindow,this),1e3),this.checkPollingStarted=!0),IC_Validation.isNotNullOrEmpty(phoneNo)?stationId="":phoneNo="",this.userInfo={stationId:stationId,phoneNo:phoneNo},this.initializeTab(),IC_Validation.isNotNullOrUndefinedString(localStorage.OAuthInfo)&&(this.OAuthInfo=IC_Common.parseJSON(localStorage.OAuthInfo)),IC_Validation.isNotNullOrUndefinedString(localStorage.icSessionId))this.icSessionId=localStorage.icSessionId,onSuccess({sessionId:this.icSessionId}),this.getCacheAgents(),this.loadDataStores(),this.isLoaded=!0;else{if(this.setSessionStarted(!1),!1===this.isAutoLogin&&!1===isAutoLoginDisabled)return void $(document).trigger(this.AutoLoginDisabledEvent);this.updateAgentLoginState(),AgentConsoleSalesforce.setSoftphonePanelLayout(this.callCenterSettings.lightningHeight,this.callCenterSettings.lightningWidth),this.icLogin(onSuccess,onError)}},checkSalesforceUserAndFlushStorage:function(sfUserId){(localStorage.sfUserId!==sfUserId||this.isTokenExpired())&&(this.flushWebStorage(),localStorage.sfUserId=sfUserId)},icLogin:function(onSuccess,onError){var that=this;that.agentInfo.webServer=IC_Common.parseUrl(that.OAuthInfo.baseUri).hostname,localStorage.agentInfo=JSON.stringify(that.agentInfo);var timestampUrl=that.OAuthInfo.baseUri+that.serverTimeUri;that.getRequest(timestampUrl,function(data){localStorage.serverTimestampOnStart=new Date(data.ServerTime).getTime(),localStorage.localTimestampOnStart=(new Date).getTime()},function(status,statusText,response){logger.warn("icAuthToken <<< getServerTimestamp status:"+status+" statusText:"+statusText+" data:"+JSON.stringify(response))}),that.agentLogin(onSuccess,function(status,statusText,response){logger.warn("icAuthToken <<< agentLogin status:"+status+" statusText:"+statusText+" data:"+JSON.stringify(response)),that.updateAgentLogoutState(),onError(status,statusText,response)})},agentLogin:function(onSuccess,onError,isNewTokenRequest){var url=this.OAuthInfo.baseUri+this.loginUri,payloadUrlEncoded={stationId:this.userInfo.stationId,stationPhoneNumber:this.userInfo.phoneNo},that=this;this.postRequest(url,this.URLEncoded,payloadUrlEncoded,function(data,status,statusText){try{logger.debug("AgentLogin Success: ",JSON.stringify(data),isNewTokenRequest),that.sessionCreated(!1,data,isNewTokenRequest),onSuccess(data,status,statusText)}catch(ex){logger.error("agentLogin success callback:"+ex.message)}},function(status,statusText,response){logger.error("agentLogin: status:"+status+" statusText:"+statusText,JSON.stringify(response)),409===status?that.joinSession(function(data,status,statusText){that.sessionCreated(!0,data,isNewTokenRequest),onSuccess(data,status,statusText)},onError):onError(status,statusText,response)})},startWS:function(){var notificationServer=this.callCenterSettings.evolveNotificationUrl;if(this.isTokenExpired())return logger.info("Notification service - Token is Expired!"),!1;var customIdentifier,that=this;if(null===this.sock){var options={server:(customIdentifier=that.agentInfo.agentuuid,encodeURIComponent(customIdentifier))};this.sock=new SockJS(notificationServer,null,options)}this.sock.onopen=function(){var authCommand;logger.trace("Evolve WebSocket Connected."),authCommand={command:"CONNECT",headers:{sessionToken:that.OAuthInfo.accessToken,isSingleSession:!1,clientLocale:that.clientLocale,clientTimezone:that.clientTimezoneName}},that.sock.send(JSON.stringify(authCommand))},this.sock.onmessage=function(e){logger.trace("Evolve Notification Received - Message : "+e.data);var message=IC_Common.parseJSON(e.data);that.resetTryToConnectInterval(message.command),that.onGetEvolveMessage(message)},this.sock.onclose=function(){"Logged out"!=that.agentInfo.cState.state?that.retryToConnectWithTimeout():(logger.trace("Evolve WebSocket Connection Closed."),that.sock=null)}},resetTryToConnectInterval:function(command){logger.debug("Notification service onmessage command: "+command),"CONNECTED"===command&&(this.notificationConnectRetryCount=1,this.clearConnectionInterval())},calculateConnectionTimeInterval:function(){this.notificationConnectRetryCount>20?this.timeIntervalForWSConnection=9e5:this.notificationConnectRetryCount>10?this.timeIntervalForWSConnection=6e4:this.notificationConnectRetryCount>5&&(this.timeIntervalForWSConnection=3e4),logger.debug("Notification service retryToConnect notificationConnectRetryCount"+this.notificationConnectRetryCount)},clearConnectionInterval:function(){this.notificationConnectRetryTimerId&&(clearTimeout(this.notificationConnectRetryTimerId),this.notificationConnectRetryTimerId=!1)},retryToConnectWithTimeout:function(){this.clearConnectionInterval(),this.calculateConnectionTimeInterval(),that=this,this.notificationConnectRetryTimerId=setTimeout($.proxy(this.retryToConnect,this),this.timeIntervalForWSConnection,!0)},retryToConnect:function(){logger.debug("Notification service retryToConnect isClientInitiateCloseConnection "+this.isClientInitiateCloseConnection),this.isClientInitiateCloseConnection?this.notificationConnectRetryCount=1:(this.notificationConnectRetryCount+=1,this.sock=null,this.startWS(),logger.debug("Notification service retryToConnect "))},onGetEmbeddedUrlsSuccess:function(response,status,statusText){localStorage.embeddedUrls=[];var linkArr=[];if(response.links.forEach(function(linkItem){linkArr.push(linkItem.appContext+linkItem.url)}),localStorage.embeddedUrls=linkArr,this.isEmbeddedUrlsListEmpty=!1,messageItemsLength=this.socketMsgsToProcess.length,messageItemsLength>0)for(let i=0;i<messageItemsLength;i++)this.processMessage(this.socketMsgsToProcess[i])},onGetEmbeddedUrlsFailure:function(statusCode,statusText,response){this.embeddedAPIFailureCounter++,this.embeddedAPIFailureCounter<3&&setTimeout(()=>{this.getRequestEvolve(this.supportedPagesUrl,$.proxy(this.onGetEmbeddedUrlsSuccess,this),$.proxy(this.onGetEmbeddedUrlsFailure,this))},3e4),logger.error("onGetEmbeddedUrlsFailure "+this.embeddedAPIFailureCounter+" <<< status:"+statusCode+" statusText:"+statusText+" response: "+JSON.stringify(response))},onGetEvolveMessage:function(message){"CONNECTED"===message.command?(this.supportedPagesUrl=this.callCenterSettings.evolveWebServerUrl+this.getEvolveSupportedEmbeddedPagesUri,this.getRequestEvolve(this.supportedPagesUrl,$.proxy(this.onGetEmbeddedUrlsSuccess,this),$.proxy(this.onGetEmbeddedUrlsFailure,this))):"MESSAGE"==message.command&&"IN_APP"===message.headers.notificationTargetType&&(this.isEmbeddedUrlsListEmpty?this.socketMsgsToProcess.push(message):this.processMessage(message))},processMessage:function(message){if(this.agentMessage.scrollMsgCount=0,IC_Validation.isNullOrEmptyOrEmptySpace(message.data.notificationURL)||function(notificationURL){for(var isSupproted=!1,xList=localStorage.embeddedUrls.split(","),i=0;i<xList.length;i++)if(-1!=notificationURL.indexOf(xList[i])){isSupproted=!0;break}return isSupproted}(message.data.notificationURL)){var msg={id:message.headers.notificationUuid,publisher:message.headers.publisher,readMsg:message.headers.isRead,receivedTime:new Date(message.headers.publishDate).format(this.localeDateTimeFormat),scrollMsg:!1,sub:message.displayData.title,msg:message.displayData.content,isEvolve:!0,evolveNotificationurl:message.data.notificationURL};(function(messages,msg){for(var i=0;i<messages.length;i++)if(messages[i].id==msg.id)return messages[i]=msg,!0})(this.agentMessage.message,msg)||(this.agentMessage.message.unshift(msg),this.agentMessage.message.sort(function(a,b){return new Date(b.receivedTime).getTime()-new Date(a.receivedTime).getTime()})),"false"===msg.readMsg&&this.agentMessage.scrollMsgCount++,localStorage.agentMessage=JSON.stringify(this.agentMessage),this.triggerEvent("agentMessage",this.AgentMessageEvent)}},updateEvolveNotifications:function(message){this.agentMessage.scrollMsgCount=0;for(var i=0;i<message.length;i++)this.agentMessage.message[i].id==message[i].id&&(this.agentMessage.message[i]=message[i]),"false"===message[i].readMsg&&this.agentMessage.scrollMsgCount++;localStorage.agentMessage=JSON.stringify(this.agentMessage),this.triggerEvent("agentMessage",this.AgentMessageEvent)},connectScreenAgent:function(){if(this.amIPolling&&"true"!=localStorage.isScreenAgentConnected){var url=this.screenAgentConnectAPI.replace("{port}",this.agentInfo.portNumber),payload={agentCorrelationKey:this.agentInfo.agentuuid},that=this;this.postRequestEvolve(url,this.JSONEncoded,JSON.stringify(payload),function(response,status,statusText){logger.trace("connectScreenAgent status: "+status+" statusText: "+statusText,JSON.stringify(response)),localStorage.isScreenAgentConnected="true"},function(status,statusText,response){logger.trace("connectScreenAgent status: "+status+" statusText: "+statusText,JSON.stringify(response)),200!==status?setTimeout($.proxy(that.connectScreenAgent,that),6e4):localStorage.isScreenAgentConnected="true"})}},disconnectScreenAgent:function(){var url=this.screenAgentDisconnectAPI.replace("{port}",this.agentInfo.portNumber),that=this;this.postRequestEvolve(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.trace("disconnectScreenAgent status: "+status+" statusText: "+statusText,JSON.stringify(response)),localStorage.isScreenAgentConnected="false"},function(status,statusText,response){logger.trace("disconnectScreenAgent status: "+status+" statusText: "+statusText,JSON.stringify(response)),200!==status?setTimeout($.proxy(that.disconnectScreenAgent,that),6e4):localStorage.isScreenAgentConnected="false"})},getEvolveSchedule:function(successCallback,errorCallback){var today,startDate,endDate,url;today=new Date,startDate=new Date(today.getFullYear(),today.getMonth(),today.getDate(),0,0,0),today.setDate(today.getDate()+6),endDate=new Date(today.getFullYear(),today.getMonth(),today.getDate(),0,0,0),url=this.callCenterSettings.evolveWebServerUrl+this.getEvolveScheduleUri.replace("{userId}",this.agentInfo.userId).replace("{startDate}",IC_Common.toISODateString(startDate)).replace("{endDate}",IC_Common.toISODateString(endDate)),this.getRequestEvolve(url,function(response,status,statusText){logger.trace("getEvolveSchedule success. status: "+status+" statusText: "+statusText,JSON.stringify(response)),successCallback(response)},function(status,statusText,response){logger.error("getEvolveSchedule failed. status: "+status+" statusText: "+statusText,JSON.stringify(response)),errorCallback()})},joinSession:function(onSuccess,onError){var url=this.OAuthInfo.baseUri+this.sessionJoinUri;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){try{logger.debug("joinSession: ",JSON.stringify(response),status,statusText),onSuccess(response,status,statusText)}catch(ex){logger.error("joinSession success callback:"+ex.message)}},function(status,statusText,response){logger.error("joinSession:- status:"+status+" statusText:"+statusText,JSON.stringify(response)),onError()})},logout:function(callback,logoutParams){var url=this.OAuthInfo.baseUri+this.logoutUri.replace("{sessionId}",this.getIcSessionId()),payload={forceLogoff:logoutParams?logoutParams.forceLogoff:"",endContacts:logoutParams?logoutParams.endContacts:"",ignorePersonalQueue:logoutParams?logoutParams.ignorePersonalQueue:""},headerData={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8,application/json","Content-Type":this.URLEncoded,Authorization:"bearer "+this.OAuthInfo.accessToken},that=this;this.xmlHttpRequest("DELETE",url,headerData,payload,function(response,status,statusText){logger.debug("logout status:"+status+" statusText:"+statusText,JSON.stringify(response))},function(status,statusText,response){if(logger.error("logout status:"+status+" statusText:"+statusText,JSON.stringify(response)),IC_Validation.isNotNullOrEmpty(response)){var errorInfo=IC_Common.parseJSON(response);if(IC_Validation.isNotNullOrEmpty(errorInfo.error_description)){var errorCode="AgentStillHasContacts"==errorInfo.error_description?"Agent_LogoffAgent_InvalidCallCount":errorInfo.error_description;that.addCustomError(errorCode,"Medium")}}}),this.isEvolve()&&this.cx1Logout(callback)},cx1Logout:function(onSuccess,onError){url=this.callCenterSettings.evolveAuthUrl+"/public/user/logout",this.postRequestEvolve(url,this.JSONEncoded,null,function(response,status,statusText){logger.debug("User-Hub logout:- status:"+status+" statusText:"+statusText,JSON.stringify(response)),"function"==typeof onSuccess&&onSuccess()},function(status,statusText,response){logger.error("User-Hub logout:- status:"+status+" statusText:"+statusText,JSON.stringify(response)),"function"==typeof onError&&onError()},!0),AgentConsoleSalesforce.closeCXone()},getNextEvent:function(){try{if(!0!==this.amIPolling)return void logger.debug("getNextEvent Stopped, amIPolling:"+this.amIPolling);logger.debug("GetNextEvent requested >>>");var url=this.OAuthInfo.baseUri+this.getNextEventUri.replace("{sessionId}",this.getIcSessionId())+"?timeout="+this.longPollingTimeout;this.getRequest(url,$.proxy(this.onGetNextEventSuccess,this),$.proxy(this.onGetNextEventFailure,this)),((new Date).getTime()-this.OAuthInfo.accessTokenTime)/1e3>=this.OAuthInfo.expiresIn-600&&1!=this.getAccessTokenCalled&&(this.getAccessTokenCalled=!0,this.getAccessTokenByRefreshToken())}catch(e){logger.error("Exception in getNextEvent, "+ex)}},onGetNextEventSuccess:function(response,status,statusText){var sessionEndEvent,isValidSession=!0,sessionID=null,that=this,isSessionStarted=!1,contactIds={},i=0,resetPCQueueCount=!1,updateSkillsEvent=!1;if(logger.debug("getNextEventSuccess <<< status:"+status+" statusText:"+statusText),this.resetGetNextFailureCount(),this.removeGetNextEventErrors(),200==status){"Session Ended"===statusText&&(isValidSession=!1);try{var events=response.events,errorEvents=(sessionID=response.sessionId,[]),getAdminData=!1;if(events.sort(function(a,b){return new Date(a.StartTimeUTC).getTime()-new Date(b.StartTimeUTC).getTime()}),"object"==typeof events&&events.length>0&&$.each(events,function(index,event){logger.debug("getNextEventSuccess eventType: "+event.Type+" eventData: "+JSON.stringify(event)),0===Object.keys(event).length?getAdminData=!0:"AgentState"===event.Type?that.onAgentStateEvent(event):"AgentSessionStart"===event.Type?(that.onAgentSessionStartEvent(event),isSessionStarted=!0):"AgentLeg"===event.Type?that.onAgentLegEvent(event):"CallContactEvent"===event.Type?(!0===resetPCQueueCount&&(resetPCQueueCount=!1,that.pcQueueContacts=[],localStorage.pcQueueContacts=JSON.stringify(that.pcQueueContacts)),that.onContactEvent(event),contactIds[event.ContactID]=!0):"WorkItemContactEvent"===event.Type?(that.onContactEvent(event),contactIds[event.ContactID]=!0):"ChatContactEvent"===event.Type?(that.onChatContactEvent(event),contactIds[event.ContactID]=!0):"EmailContactEvent"===event.Type&&that.isEmailFeatureEnabled?(that.onEmailContactEvent(event),contactIds[event.ContactId]=!0):"VoiceMailContactEvent"===event.Type?(that.onVoiceMailContactEvent(event),contactIds[event.ContactId]=!0):"VoiceMailPlayBackEvent"===event.Type?that.onVoiceMailPlayBackEvent(event):"Mute"===event.Type?that.onMuteEvent(event):"HoursOfOperation"===event.Type?that.onHoursOfOperation(event):"AgentSessionEnd"===event.Type||"RemoteAgentSessionEnd"===event.Type?!0===isValidSession&&(isValidSession=!1,sessionEndEvent=event):"NaturalCallingSkillList"===event.Type?that.onSkillRunningLowEvent(event):"AgentError"===event.Type?errorEvents.push(event):"UpdateDialerCampaign"===event.Type?that.onUpdateDialerCampaign(event):"UpdateSkill"===event.Type?that.onUpdateSkill(event):"ChatText"===event.Type?that.onChatText(event):"RunApp"===event.Type?that.onRunAppEvent(event):"PageOpen"===event.Type?that.onPageOpenEvent(event):"UpdateIndicators"===event.Type?that.addIntervalJob("OnUpdateIndicatorsEvent",100,-1,"",event):"UpdateMessages"===event.Type?that.addIntervalJob("OnUpdateMessagesEvent",100,-1,"",event):"Indicator"===event.Type?that.onIndicatorEvent(event):"UpdateUnavailableCodes"===event.Type?that.onUpdateUnavailableCodesEvent(event):"UpdateSkills"===event.Type?updateSkillsEvent=!0:"UpdateDialerCampaigns"===event.Type?that.onUpdateDialerCampaignsEvent(event):"UpdateChatTranscript"===event.Type?that.addJob({id:IC_Common.generateUniqueId("job"),type:"OnUpdateChatTranscript",data:event}):"UpdateCallbacks"===event.Type?that.addIntervalJob("GetPromiseKeeper",100,-1):"PromiseKeeper"===event.Type?that.showCommitmentReminder(event):"UpdatePermissions"===event.Type?that.addIntervalJob("GetPermissions",100,-1):"ChatPatronTyping"===event.Type?that.onChatPatronTypingEvent(event):"ChatPreview"===event.Type?that.onChatPreviewEvent(event):"MchAgentSettingsChangeEvent"===event.Type&&that.onMCHAgentSettingsChangeEvent(event)}),!0===getAdminData&&this.getAdminData(!0),!0===updateSkillsEvent&&this.onUpdateSkillsEvent(event),errorEvents.length>0&&this.onEventError(errorEvents),!0===isSessionStarted)for(i=0;i<this.contacts.length;i++)contactIds.hasOwnProperty(this.contacts[i].id)||"Parked"===this.contacts[i].status||this.processOrphanContact(this.contacts[i])}catch(ex){logger.error("getNextEventSuccess, exception in processing events. "+ex)}!1===isValidSession&&(this.onAgentSessionEndEvent(sessionEndEvent),logger.debug("getNextEventSuccess, agent session ended."))}else 304===status&&(localStorage.lastIcSessionIdUpdate=(new Date).getTime());isValidSession&&(IC_Validation.isNotNullOrEmpty(sessionID)&&this.updateSessionId(sessionID),this.getNextEvent())},onGetNextEventFailure:function(statusCode,statusText,response){if(logger.error("getNextEventFailure <<< status:"+statusCode+" statusText:"+statusText+" response: "+JSON.stringify(response)),409===statusCode)this.onAgentSessionEndEvent();else{!0!==this.documentUnloaded&&(this.setGetNextFailureCount(),1===this.getNextEventFailureCount?logger.warn("Ignoring first getNextEventFailure."):this.getNextEventFailureCount<=3?this.addCustomError("Custom_GetNextErrorAttemptWarn","Info"):this.addCustomError("Custom_GetNextErrorAttempt","Medium"),setTimeout($.proxy(this.getNextEvent,this),1e4))}},resetGetNextFailureCount:function(){this.getNextEventFailureCount=0,localStorage.getNextEventFailureCount="0"},setGetNextFailureCount:function(){IC_Validation.isNumber(localStorage.getNextEventFailureCount)&&(this.getNextEventFailureCount=parseInt(localStorage.getNextEventFailureCount,10)),this.getNextEventFailureCount++,localStorage.getNextEventFailureCount=this.getNextEventFailureCount},setAgentState:function(state,reason){var url=this.OAuthInfo.baseUri+this.setAgentStateUri.replace("{sessionId}",this.getIcSessionId()),payloadJson={state:state,reason:reason},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("setAgentState success <<< status:"+status+" statusText:"+statusText+" response:"+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_AgentStateChangeErrorAttempt","Medium"),logger.error("setAgentState failure <<< status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},dialAgentLeg:function(){var url=this.OAuthInfo.baseUri+this.dialAgentLegUri.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("dialAgentLeg success <<< status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_AgentDialLegErrorAttempt","Medium"),logger.error("dialAgentLeg failure <<< status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},endAgentLeg:function(){var url=this.OAuthInfo.baseUri+this.endAgentLegUri.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("endAgentLeg success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_AgentEndLegErrorAttempt","Medium"),logger.error("endAgentLeg:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},acceptContact:function(contactId){var url=this.OAuthInfo.baseUri+this.acceptContactUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("acceptContact success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("acceptContact:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},rejectContact:function(contactId){var url=this.OAuthInfo.baseUri+this.rejectContactUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("rejectContact success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("ajax error @ rejectContact:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},snoozeContact:function(contactId){var url=this.OAuthInfo.baseUri+this.snoozeContactUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("snoozeContact success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("snoozeContact:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},holdContact:function(contactId,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.holdContactUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){try{logger.debug("holdContact success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback(response,status,statusText)}catch(ex){logger.error("holdContact success callback:"+ex.message)}},function(status,statusText,response){logger.error("holdContact:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.addCustomError("Custom_HoldErrorAttempt","Medium")})},resumeContact:function(contactId){var url=this.OAuthInfo.baseUri+this.resumeContactUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("resumeContact success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_ResumeErrorAttempt","Medium"),logger.error("resumeContact:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},endContact:function(contactId){var url=this.OAuthInfo.baseUri+this.endContactUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("endContact success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_ContactEndErrorAttempt","Medium"),logger.error("endContact:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},conferenceContacts:function(onSuccessCallback){var url=this.OAuthInfo.baseUri+this.conferenceContactUri.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){try{logger.debug("conferenceContacts success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback(response,status,statusText)}catch(ex){logger.error("conferenceContacts success callback:"+ex.message)}},function(status,statusText,response){that.addCustomError("Custom_ConferenceErrorAttempt","Medium"),logger.error("conferenceContacts:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferContacts:function(){var url=this.OAuthInfo.baseUri+this.transferContactUri.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("transferContacts success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_TransferErrorAttempt","Medium"),logger.error("transferContacts:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferWorkItemContactToSkill:function(workItemContactId,skillName,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.transferWorkItemSkillUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",workItemContactId),payloadJson={targetSkillName:skillName},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("transferWorkItemContactToSkill success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback()},function(status,statusText,response){that.addCustomError("Custom_TransferWISkillErrorAttempt","Medium"),logger.error("transferWorkItemContactToSkill status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferWorkItemContactToAgent:function(workItemContactId,agentUserName,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.transferWorkItemAgentUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",workItemContactId),payloadJson={targetAgentName:agentUserName},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("transferWorkItemContactToAgent success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback()},function(status,statusText,response){that.addCustomError("Custom_TransferWIAgentErrorAttempt","Medium"),logger.error("transferWorkItemContactToAgent status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferVoiceMailContactToSkill:function(voiceMailContactId,skillId,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.transferVoiceMailSkillUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",voiceMailContactId),payloadJson={targetSkillId:skillId},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("transferVoiceMailContactToSkill success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback()},function(status,statusText,response){that.addCustomError("Custom_TransferVMSkillErrorAttempt","Medium"),logger.error("transferVoiceMailContactToSkill status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferVoiceMailContactToAgent:function(voiceMailContactId,agentId,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.transferVoiceMailAgentUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",voiceMailContactId),payloadJson={targetAgentId:agentId},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("transferVoiceMailContactToAgent success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback()},function(status,statusText,response){that.addCustomError("Custom_TransferVMAgentErrorAttempt","Medium"),logger.error("transferVoiceMailContactToAgent status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},addChat:function(){var url=this.OAuthInfo.baseUri+this.postAddChat.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("addChat success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_AddChatErrorAttempt","Medium"),logger.error("addChat:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferChat:function(chatContactId,skillName){var url=this.OAuthInfo.baseUri+this.transferChatUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",chatContactId),payloadJson={targetSkillName:skillName},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("transferChatContactToSkill success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_TransferWIAgentErrorAttempt","Medium"),logger.error("transferChatContactToSkill:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferChatToAgent:function(chatContactId,agentId){var url=this.OAuthInfo.baseUri+this.transferChatToAgentUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",chatContactId),payloadJson={targetAgentId:agentId},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("transferChatContactToAgent success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_TransferWIAgentErrorAttempt","Medium"),logger.error("transferChatContactToAgent:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},addEmail:function(){var url=this.OAuthInfo.baseUri+this.postAddEmail.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){that.getParkedEmailDetails(!0),logger.debug("addEmail success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("addEmail Failed:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferEmailToSkill:function(emailContactId,skillID,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.transferEmailToSkillUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",emailContactId),payloadJson={targetSkillID:skillID},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("transferEmailContactToSkill success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback(emailContactId)},function(status,statusText,response){that.addCustomError("Custom_TransferWIAgentErrorAttempt","Medium"),logger.error("transferEmailContactToSkill:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},transferEmailToAgent:function(emailContactId,agentID){var url=this.OAuthInfo.baseUri+this.transferEmailToAgentUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",emailContactId),payloadJson={targetAgentId:agentID},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("transferEmailContactToAgent success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_TransferWIAgentErrorAttempt","Medium"),logger.error("transferEmailContactToAgent:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},createEmailOB:function(skillId,toAddress){var url=this.OAuthInfo.baseUri+this.emailOBUri.replace("{sessionId}",this.getIcSessionId()),payloadJson={skillId:skillId,toAddress:toAddress||""},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("OB Email success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),localStorage.popoutActiveTab=0,!1===IC_Common.toBoolean(localStorage.isPopupOpen)&&that.popoutChat()},function(status,statusText,response){that.addCustomError("Custom_EmailErrorAttempt","Medium"),logger.error("OB Email:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getBusinessUnit:function(job){var url=this.OAuthInfo.baseUri+this.getBusinessUnitUri,that=this;url+=IC_Common.formQueryString({fields:"fileExtensions, features, maxConferenceParties"}),this.getRequest(url,function(response,status,statusText){try{logger.debug("Get Business Unit success :- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response));var resultSet=response,resultSetlen=0,fileExtResult=[],i=0;for(that.fileExtList=[],that.featuresList=[],that.maxConference=3,IC_Validation.isNotNull(resultSet)&&IC_Validation.isNotNullOrEmptyArray(resultSet.businessUnits)&&(IC_Validation.isNotNull(resultSet.businessUnits[0].maxConferenceParties)&&(that.maxConference=resultSet.businessUnits[0].maxConferenceParties),IC_Validation.isNotNull(resultSet.businessUnits[0].fileExtensions)&&(resultSetlen=(fileExtResult=resultSet.businessUnits[0].fileExtensions).length),IC_Validation.isNotNull(resultSet.businessUnits[0].features)&&(that.featuresList=resultSet.businessUnits[0].features)),i=0;i<resultSetlen;i++)that.fileExtList.push(fileExtResult[i].extension);localStorage.featuresList=JSON.stringify(that.featuresList),localStorage.fileExtList=JSON.stringify(that.fileExtList),that.triggerEvent("featuresList",that.BUFeaturesListEvent),localStorage.maxConference=that.maxConference,that.triggerEvent("maxConference",that.MaxConferenceHandleEvent)}catch(ex){logger.error("Get Business Unit success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),logger.error("Get Business Unit:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},isIntegratedSoftphoneEnabled:function(callBack){var getBusinessUnitUri=this.OAuthInfo.baseUri+this.getBusinessUnitUri,getPermissionsUri=this.OAuthInfo.baseUri+this.getPermissionsUri.replace("{agentId}",localStorage.agentId),integratedSoftphone={isEnabledInBusinessUnit:null,isEnabledInSecurityProfile:null,isAudioCodesConfigured:null},that=this;function onServiceCompleted(){null!=integratedSoftphone.isEnabledInBusinessUnit&&null!=integratedSoftphone.isEnabledInSecurityProfile&&null!=integratedSoftphone.isAudioCodesConfigured&&(that.isIntegratedSoftphone=1==integratedSoftphone.isEnabledInBusinessUnit&&1==integratedSoftphone.isEnabledInSecurityProfile&&1==integratedSoftphone.isAudioCodesConfigured,localStorage.isIntegratedSoftphone=that.isIntegratedSoftphone,callBack(that.isIntegratedSoftphone))}getBusinessUnitUri+=IC_Common.formQueryString({fields:"features"}),this.getRequest(getBusinessUnitUri,function(response,status,statusText){try{if(logger.debug("isIntegratedSoftphoneEnabled-getBusinessUnit :- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),integratedSoftphone.isEnabledInBusinessUnit=!1,IC_Validation.isNotNull(response)&&IC_Validation.isNotNullOrEmptyArray(response.businessUnits)&&IC_Validation.isNotNull(response.businessUnits[0].features)){that.featuresList=response.businessUnits[0].features;for(var i=0;i<that.featuresList.length;i++)110==that.featuresList[i].productId&&1==that.featuresList[i].isEnabled&&(integratedSoftphone.isEnabledInBusinessUnit=!0,logger.debug("isIntegratedSoftphoneEnabled-getBusinessUnit :- IntegratedSoftphone option is enabled at BusinessUnit Level"))}}catch(ex){logger.error("isIntegratedSoftphoneEnabled-getBusinessUnit success callback:"+ex.message)}finally{onServiceCompleted()}},function(status,statusText,response){logger.error("isIntegratedSoftphoneEnabled-getBusinessUnit :- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),onServiceCompleted()}),this.getRequest(getPermissionsUri,function(response,status,statusText){try{logger.debug("isIntegratedSoftphoneEnabled-getPermissions :- status:"+status+" statusText:"+statusText),integratedSoftphone.isEnabledInSecurityProfile=!1,$.grep(response.permissions,function(event){return"agentsfsoftphone"===event.Key.toLowerCase()}).length>0&&(integratedSoftphone.isEnabledInSecurityProfile=!0,logger.debug("isIntegratedSoftphoneEnabled-getPermissions :- IntegratedSoftphone option is enabled at SecurityProfile Level"))}catch(ex){logger.error("isIntegratedSoftphoneEnabled-getPermissions success callback:"+ex.message)}finally{onServiceCompleted()}},function(status,statusText,response){logger.error("isIntegratedSoftphoneEnabled-getPermissions :- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),onServiceCompleted()}),this.getAgentSettings(function(agentSettings){IC_Validation.isValidObject(agentSettings)&&IC_Validation.isNotNullOrEmpty(agentSettings.webRTCType)&&"audiocodes"==agentSettings.webRTCType.toLowerCase()?(integratedSoftphone.isAudioCodesConfigured=!0,logger.debug("isIntegratedSoftphoneEnabled-getAgentSettings :- audioCodes server details are configured"),onServiceCompleted()):(logger.error("isIntegratedSoftphoneEnabled-getAgentSettings :- audioCodes server details are not configured"),integratedSoftphone.isAudioCodesConfigured=!1,onServiceCompleted())})},getSoftphoneEnabled:function(){if(IC_Validation.isNotNullOrUndefinedString(localStorage.isIntegratedSoftphone))return IC_Common.toBoolean(localStorage.isIntegratedSoftphone)},sendEmail:function(emailContent,emailType,callBack){var url="";"reply"===emailType||"replyAll"===emailType?url=this.OAuthInfo.baseUri+this.replyEmailUri.replace("{sessionId}",this.getIcSessionId()):"forward"===emailType||"draft"===emailType?url=this.OAuthInfo.baseUri+this.forwardEmailUri.replace("{sessionId}",this.getIcSessionId()):"outbound"===emailType&&(url=this.OAuthInfo.baseUri+this.sendOBEmailUri.replace("{sessionId}",this.getIcSessionId())),url=url.replace("{contactId}",emailContent.contactId);var payloadJson={skillId:emailContent.skillId,toAddress:emailContent.toAddress,fromAddress:emailContent.fromAddress,ccAddress:emailContent.ccAddress,bccAddress:emailContent.bccAddress,subject:emailContent.subject,bodyHtml:emailContent.bodyHtml,attachments:emailContent.attachments,attachmentNames:emailContent.attachmentNames},that=this,ignoreTimeout=!1;IC_Validation.isNotNullOrUndefinedString(emailContent.attachmentNames)&&(ignoreTimeout=!0),logger.trace("ContactID: "+emailContent.contactId," SendEmail EmailType: "+emailType),this.updateMailProgress(!0),this.showSpinner(),this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){that.hideSpinner(),logger.debug("SendEmail success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.updateMailProgress(!1),callBack(!0)},function(status,statusText,response){that.hideSpinner(),that.updateMailProgress(!1),callBack(!1),that.addCustomError("Agent_DeliverInboundEmail_Error","Medium"),logger.error("SendEmail:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},ignoreTimeout)},updateMailProgress:function(mailSending){this.isMailSending=mailSending,localStorage.isMailSending=this.isMailSending,$(document).trigger(this.MailProgressEvent)},showSpinner:function(){$("#overlay").addClass("overlay"),$("#agentConsolePopoutContainer").addClass("disableContainer"),$(".progressBar").showfn()},hideSpinner:function(){$(".progressBar").hide(),$("#agentConsolePopoutContainer").removeClass("disableContainer"),$("#overlay").removeClass("overlay")},playVoiceMail:function(playTimestamp,position,contactId){var url=this.OAuthInfo.baseUri+this.playVoiceMailUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),payloadJson={playTimestamp:playTimestamp,position:position},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("playVoiceMail success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_PlayVoiceMailError","Medium"),logger.error("playVoiceMail:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},pauseVoiceMail:function(contactId){var url=this.OAuthInfo.baseUri+this.pauseVoiceMailUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("pauseVoiceMail success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_PauseVoiceMailError","Medium"),logger.error("pauseVoiceMail:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getFile:function(fileServerPath,callBack){var url=this.OAuthInfo.baseUri+this.fileUri;url+=IC_Common.formQueryString({fileName:fileServerPath}),this.getRequest(url,callBack,null,!0)},chatSendTxt:function(contactId,msg){var url=this.OAuthInfo.baseUri+this.sendChatText.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),payloadJson={chatText:msg},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("addChat success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_AddChatErrorAttempt","Medium"),logger.error("addChat:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},null,!1)},enableActiveChat:function(contactId){var url=this.OAuthInfo.baseUri+this.activateChat.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("enableActiveChat success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_AddChatErrorAttempt","Medium"),logger.error("enableActiveChat:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},triggerContactEvent:function(){logger.trace("triggerContactEvent"),localStorage.contacts=JSON.stringify(AgentConsoleDataStore.contacts)},getChatConversation:function(contactId,callback){var url=this.OAuthInfo.baseUri+this.getChatTranscript.replace("{contactId}",contactId),messages=[];this.getRequest(url,function(response,status,statusText){try{if(logger.debug("getChatConversation: "+JSON.stringify(response)),response.hasOwnProperty("messages")&&response.messages.hasOwnProperty("Messages"))for(var i=0;i<response.messages.Messages.length;i++){var msgDetail,event=response.messages.Messages[i];event.hasOwnProperty("Text")&&(msgDetail={msg:event.Text,id:IC_Common.generateChatMessageId(event.Text,event.TimeStamp),type:event.PartyType,label:event.Label,time:new Date(event.TimeStamp).getTime()},messages.push(msgDetail))}}catch(ex){logger.error("getChatConversation success callback:"+ex.message)}finally{callback(messages)}logger.debug("getChatConversation:- success status:"+status+" statusText:"+statusText+" response: "+response)},function(status,statusText,response){logger.error("getChatConversation:- error status:"+status+" statusText:"+statusText+" response: "+response),callback(messages)})},loginDialer:function(skillName){var url=this.OAuthInfo.baseUri+this.dialerLogin.replace("{sessionId}",this.getIcSessionId()),payloadJson={skillName:skillName},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("loginDialer success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),localStorage.agentInfo=JSON.stringify(that.agentInfo),that.triggerEvent("agentInfo",that.AgentInfoEvent)},function(status,statusText,response){that.addCustomError("Custom_DialerLoginErrorAttempt","Medium"),logger.error("loginDialer:- status:"+status+" statusText:"+statusText,response),localStorage.agentInfo=JSON.stringify(that.agentInfo),that.triggerEvent("agentInfo",that.AgentInfoEvent)})},logoutDialer:function(){var url=this.OAuthInfo.baseUri+this.dialerLogout.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify({}),function(response,status,statusText){logger.debug("logoutDialer status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),localStorage.agentInfo=JSON.stringify(that.agentInfo),that.triggerEvent("agentInfo",that.AgentInfoEvent)},function(status,statusText,response){logger.error("logoutDialer status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.addCustomError("Custom_DialerLogoutErrorAttempt","Medium")})},dialerAMDOverrideContact:function(contactId,type){var url=this.OAuthInfo.baseUri+this.dialerAMDOverride.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId).replace("{type}",type);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("dialerAMDOverrideContact status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("dialerAMDOverrideContact status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},disposeBadNumberCall:function(contactId,type){var url=this.OAuthInfo.baseUri+this.disposeBadCall.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId).replace("{type}",type);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("disposeBadNumberCall success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("disposeBadNumberCall:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},dialPhone:function(phoneNumber,skillName){var url=this.OAuthInfo.baseUri+this.dialPhoneUri.replace("{sessionId}",this.getIcSessionId()),payload={phoneNumber:phoneNumber,skillName:skillName},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payload),function(response,status,statusText){that.setContactInitiationTab(),logger.debug("dialPhone success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_DialErrorAttempt","Medium"),logger.error("dialPhone:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},dialSkill:function(skillName){var url=this.OAuthInfo.baseUri+this.dialSkillUri.replace("{sessionId}",this.getIcSessionId()),payload={skillName:skillName},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payload),function(response,status,statusText){that.setContactInitiationTab(),logger.debug("dialSkill success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_DialSkillErrorAttempt","Medium"),logger.error("dialSkill:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},continueReskill:function(canContinue){var url=this.OAuthInfo.baseUri+this.continueReskillUri.replace("{sessionId}",this.getIcSessionId()),payload={continueReskill:canContinue};this.postRequest(url,this.JSONEncoded,JSON.stringify(payload),function(response,status,statusText){logger.debug("continueReskill success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("continueReskill:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},dialConsultAgent:function(userName){var url=this.OAuthInfo.baseUri+this.dialConsultAgentUri.replace("{sessionId}",this.getIcSessionId()),payload={agentUserName:userName},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payload),function(response,status,statusText){that.setContactInitiationTab(),logger.debug("dialConsultAgent success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_DialAgentErrorAttempt","Medium"),logger.error("dialConsultAgent:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},dialAgentPersonalQueue:function(userName){var url=this.OAuthInfo.baseUri+this.dialPersonalQueueUri.replace("{sessionId}",this.getIcSessionId()),payload={agentUserName:userName},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payload),function(response,status,statusText){that.setContactInitiationTab(),logger.debug("dialAgentPersonalQueue success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("dialAgentPersonalQueue:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},acceptAgentConsult:function(contactId){var url=this.OAuthInfo.baseUri+this.acceptAgentConsultUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){that.setContactInitiationTab(),logger.debug("acceptAgentConsult success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("acceptAgentConsult:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},muteAgent:function(){var url=this.OAuthInfo.baseUri+this.muteAgenUri.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("muteAgent success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_MuteErrorAttempt","Medium"),logger.error("muteAgent:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},unmuteAgent:function(){var url=this.OAuthInfo.baseUri+this.unmuteAgenUri.replace("{sessionId}",this.getIcSessionId()),that=this;this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("unmuteAgent success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_UnmuteErrorAttempt","Medium"),logger.error("unmuteAgent:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},setDisposition:function(contactId,primDispId,secDispId,dispPayload,callbackNumber,notes,type){var payloadJson,url=this.OAuthInfo.baseUri+this.setDispositionUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),commitmentAmount="",callbackTime="",that=this;if(logger.trace("ContactID: "+contactId," setDisposition request fired dispname: ",primDispId,"dispPayload: ",dispPayload,"callbackNumber: ",callbackNumber,"notes: ",notes),"Dialer"===type)if(!1===dispPayload.isReschedule)callbackTime="",callbackNumber="",commitmentAmount=dispPayload.data;else{var datVal=new Date(dispPayload.data);callbackTime=IC_Common.toISODateString(datVal)}payloadJson={primaryDispositionId:primDispId,primaryDispositionNotes:notes,primaryCommitmentAmount:commitmentAmount,primaryCallbackTime:callbackTime,primaryCallbackNumber:callbackNumber,secondaryDispositionId:secDispId},this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){that.updateContactDispositionState(contactId),logger.debug("setDispositionContact success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_ContactDispErrorAttempt","Medium"),logger.error("setDispositionContact:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},recordCall:function(contactId){var url=this.OAuthInfo.baseUri+this.recordCallUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("recordCall success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("recordCall:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},maskCall:function(contactId){var url=this.OAuthInfo.baseUri+this.maskCallUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("maskCall success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("maskCall:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},unmaskCall:function(contactId){var url=this.OAuthInfo.baseUri+this.unmaskCallUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("unmaskCall success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("unmaskCall:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},updateAgentLoginState:function(){this.agentInfo.cState={state:"Logging in",reason:"",nState:[]},this.agentInfo.lgId="",localStorage.agentInfo=JSON.stringify(this.agentInfo),this.triggerEvent("agentInfo",this.AgentInfoEvent)},updateAgentLogoutState:function(ignoreTriggerEvent){this.agentInfo.cState={state:"Logged out",reason:"",nState:[]},this.agentInfo.lgState="Disconnected",this.agentInfo.lgId="",localStorage.agentInfo=JSON.stringify(this.agentInfo),IC_Validation.isNullOrEmpty(ignoreTriggerEvent)&&$(document).trigger(this.AgentInfoEvent),IC_Validation.isNotNullOrEmpty(localStorage.lightningHeight)||IC_Validation.isNotNullOrEmpty(localStorage.lightningWidth)||(localStorage.lightningHeight=this._LightningHeight,localStorage.lightningWidth=this._LightningWidth),AgentConsoleSalesforce.setSoftphonePanelLayout(localStorage.lightningHeight,localStorage.lightningWidth)},setSoftphoneHeightWidth:function(){IC_Validation.isNotNullOrEmpty(localStorage.lightningHeight)&&IC_Validation.isNotNullOrEmpty(localStorage.lightningWidth)&&AgentConsoleSalesforce.setSoftphonePanelLayout(localStorage.lightningHeight,localStorage.lightningWidth)},updateAuthInfo:function(){localStorage.OAuthInfo=JSON.stringify(this.OAuthInfo)},updateSessionId:function(sessionId){this.icSessionId=sessionId,localStorage.icSessionId=sessionId,localStorage.lastIcSessionIdUpdate=(new Date).getTime()},sessionCreated:function(joinSession,data,isNewTokenRequest){this.agentInfo.joinSession=joinSession,localStorage.agentInfo=JSON.stringify(this.agentInfo),this.updateSessionId(data.sessionId),this.isLoaded=!0,localStorage.isLoaded="true",!0!==isNewTokenRequest&&this.getAdminData(!1)},getAdminData:function(updateAgentInfo){var skillCallback="";this.getCacheAgents(),this.addIntervalJob("GetAllUnavailableCodes",100,-1),this.addIntervalJob("GetTeams",100,-1),!0===updateAgentInfo&&(skillCallback="GetAgentInfo"),this.addIntervalJob("GetAllSkills",100,-1,skillCallback)},getTeams:function(job){var url=this.OAuthInfo.baseUri+this.getTeamsUri,that=this;url=IC_Common.appendQueryString(url,{fields:"teamId,teamName",isActive:!0}),logger.trace("getTeams request fired"),this.getRequest(url,function(response,status,statusText){try{var team,len=response.teams.length,i=0;for(that.teamList=[],i=0;i<len;i++)team=response.teams[i],that.teamList.push({id:team.teamId,name:team.teamName});localStorage.teamList=JSON.stringify(that.teamList),localStorage.teamListUpdateTime=(new Date).getTime(),logger.debug("getTeams:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.triggerEvent("teamList",that.TeamListEvent)}catch(ex){logger.error("getTeams success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetTeamsError"),that.addIntervalJob(job.type,job.interval,job.hitCount),logger.error("getTeams:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getTeamDetails:function(job){var url=this.OAuthInfo.baseUri+this.getTeamDetailsUri.replace("{teamId}",this.agentInfo.teamId),that=this;this.getRequest(url,function(response,status,statusText){try{if(void 0!==response.teams&&response.teams.length>0){var teamObj=response.teams[0];that.agentInfo.teamDefaultMaxChats&&(that.agentInfo.maxChatsAllowed=teamObj.maxConcurrentChats),that.agentInfo.useTeamMaxEmailInbox&&(that.agentInfo.maxEmailInboxAllowed=teamObj.maxEmailInboxCount),localStorage.agentInfo=JSON.stringify(that.agentInfo)}}catch(ex){logger.error("getTeamDetails success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetTeamDetailsError"),that.addIntervalJob(job.type,job.interval,job.hitCount),logger.error("ajax error @ getTeamDetails:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getPermissions:function(job){var url=this.OAuthInfo.baseUri+this.getPermissionsUri.replace("{agentId}",this.agentInfo.id),that=this,keys=["hideagentpresence","hideagentidentityinfo","hideagentcallerid","hideagentphonenumber","recordcontact","masking","multipartyconferencing"];this.getRequest(url,function(response,status,statusText){try{var key=response.permissions;that.permissionsList=[];for(var i=0;i<keys.length;i++){var objarr=$.grep(key,function(event){return event.Key.toLowerCase()===keys[i]});objarr.length>0&&(objarr[0].Key=objarr[0].Key.toLowerCase(),that.permissionsList.push(objarr[0]))}localStorage.permissionsList=JSON.stringify(that.permissionsList),that.triggerEvent("permissionsList",that.PermissionsListEvent)}catch(ex){logger.error("getPermissions success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job)})},getBrandingProfiles:function(job){var that=this;this.isEvolve()?this.getCXOneBrandingProfiles(function(){that.removeJob(job)}):this.getICBrandingProfiles(function(){that.removeJob(job)})},getICBrandingProfiles:function(callback){var url=this.OAuthInfo.baseUri+this.getBrandingProfilesUri,that=this;url+=IC_Common.formQueryString({businessUnitId:this.agentInfo.busNo,fields:"profileId, active, coBrand, sfdcAgentLogo"}),this.getRequest(url,function(response,status,statusText){try{that.brandingProfile={},IC_Validation.isNotNullOrEmpty(response)&&(that.brandingProfile={profileId:response.profileId,active:response.active,coBrand:response.coBrand,sfdcAgentLogo:IC_Validation.isNotNullOrEmpty(response.sfdcAgentLogo)?response.sfdcAgentLogo:""}),localStorage.brandingProfile=JSON.stringify(that.brandingProfile),that.triggerEvent("brandingProfile",that.BrandingProfilesEvent)}catch(ex){logger.error("getICBrandingProfiles success callback:"+ex.message)}finally{callback()}},function(status,statusText,response){callback()})},getCXOneBrandingProfiles:function(callback){var url=this.callCenterSettings.evolveWebServerUrl+this.getCXoneBrandingProfileUri,that=this;url+="?fields=profileId,status,coBrand,sfdcLogoUrl",this.getRequest(url,function(response,status,statusText){try{that.brandingProfile={},IC_Validation.isNotNullOrEmpty(response)&&IC_Validation.isNotNullOrEmpty(response.brandingProfile)&&(that.brandingProfile={profileId:response.brandingProfile.profileId,active:"ACTIVE"==response.brandingProfile.status,coBrand:response.brandingProfile.coBrand,sfdcAgentLogo:IC_Validation.isNotNullOrEmpty(response.brandingProfile.sfdcLogoUrl)?response.brandingProfile.sfdcLogoUrl:""}),localStorage.brandingProfile=JSON.stringify(that.brandingProfile),that.triggerEvent("brandingProfile",that.BrandingProfilesEvent)}catch(ex){logger.error("getCXOneBrandingProfiles success callback:"+ex.message)}finally{callback()}},function(status,statusText,response){callback()})},getPromiseKeeper:function(job){var url=this.OAuthInfo.baseUri+this.getPromiseKeeperUri.replace("{agentId}",this.agentInfo.id),that=this;this.getRequest(url,function(response,status,statusText){try{that.promiseKeeperList=[],that.promiseKeeperList=response.callbacks,localStorage.promiseKeeperList=JSON.stringify(that.promiseKeeperList),that.triggerEvent("promiseKeeperList",that.PromiseKeeperEvent)}catch(ex){logger.error("getPromiseKeeper success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job)})},getTimeZone:function(job){var url=this.OAuthInfo.baseUri+this.getTimeZoneUri,that=this;this.getRequest(url,function(response,status,statusText){try{that.timeZoneList=[],that.timeZoneList=response.timeZones,localStorage.timeZoneList=JSON.stringify(that.timeZoneList),that.triggerEvent("timeZoneList",that.TimeZoneEvent)}catch(ex){logger.error("getTimeZone success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job)})},createScheduledCallback:function(firstName,lastName,phoneNumber,skillId,targetAgentId,callbackTime,notes,callback,failureCallback){var url=this.OAuthInfo.baseUri+this.postPromiseKeeperUri,payloadJson={firstName:firstName,lastName:lastName,phoneNumber:phoneNumber,skillId:skillId,targetAgentId:targetAgentId,scheduleDate:callbackTime,notes:notes};this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("createPromiseKeeper success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback()},function(status,statusText,response){logger.error("createScheduledCallback failed:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),IC_Validation.isNotNullOrEmpty(response)&&failureCallback(IC_Common.parseJSON(response))})},updateScheduledCallback:function(callbackId,firstName,lastName,phoneNumber,skillId,targetAgentId,callbackTime,notes,callback,failureCallback){var url=this.OAuthInfo.baseUri+this.updatePromiseKeeperUri.replace("{callbackId}",callbackId),payloadJson={firstName:firstName,lastName:lastName,phoneNumber:phoneNumber,skillId:skillId,targetAgentId:targetAgentId,scheduleDate:callbackTime,notes:notes};this.putRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("updateScheduledCallback success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback()},function(status,statusText,response){logger.error("updateScheduledCallback failed:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),IC_Validation.isNotNullOrEmpty(response)&&failureCallback(IC_Common.parseJSON(response))})},reschedulePromieKeeper:function(callbackId,rescheduleDate,callback,failureCallback){var url=this.OAuthInfo.baseUri+this.reschedulePromiseKeeperUri.replace("{callbackId}",callbackId).replace("{sessionId}",this.getIcSessionId()),payloadJson={rescheduleDate:rescheduleDate},that=this;localStorage.openedCommitmentReminderWindow="",this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){localStorage.isRescheduleInProgress="false",logger.debug("reschedulePromiseKeeper success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),localStorage.commitmentReminder=JSON.stringify({action:"complete"}),that.triggerEvent("commitmentReminder",that.RescheduleCommitmentReminderCompletedEvent),callback()},function(status,statusText,response){logger.error("reschedulePromiseKeeper failed:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),localStorage.isRescheduleInProgress="false",IC_Validation.isNotNullOrEmpty(response)&&failureCallback(IC_Common.parseJSON(response))})},proceedPromiseKeeper:function(callbackId,successCallback,failureCallback){var url=this.OAuthInfo.baseUri+this.proceedPromiseKeeperUri.replace("{callbackId}",callbackId).replace("{sessionId}",this.getIcSessionId());this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("proceedPromiseKeeper success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),successCallback()},function(status,statusText,response){failureCallback(),logger.error("proceedPromiseKeeper failed:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},deleteCallback:function(callbackId,notes,callback){var url=this.OAuthInfo.baseUri+this.deleteCallbackUri.replace("{callbackId}",callbackId),payloadJson={description:notes};this.deleteRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("deleteCommitment success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback()},function(status,statusText,response){logger.error("deleteCommitment failed:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getCacheSkillQueue:function(){try{if(!0!==this.amIPolling)return void logger.debug("getCacheQueue Stopped, amIPolling:"+this.amIPolling);var url=this.OAuthInfo.baseUri+this.getCacheSkillQueueUri,that=this,updatedSince=null;updatedSince=IC_Validation.isNotNullOrEmpty(localStorage.lastSkillQueueCachePollTime)?localStorage.lastSkillQueueCachePollTime:IC_Common.toISODateString(new Date(0)),url+=IC_Common.formQueryString({Fields:"SkillId,QueueCount,MediaType,LongestQueueTimeInSeconds",UpdatedSince:updatedSince}),this.getRequest(url,function(response,status,statusText){try{var i=0,resultSet=response.resultSet,resultSetlen=0,skill=null;if(that.removeGetNextEventErrors(),localStorage.lastSkillQueueCachePollTime=resultSet.LastPollTime,IC_Validation.isNotNullOrEmptyArray(resultSet.Queues)&&(resultSetlen=resultSet.Queues.length),logger.debug("getCacheQueueSuccess <<< status:"+status+" statusText:"+statusText+" resultLen:"+resultSetlen),that.skillQueueMap={},resultSetlen>0)for(i=0;i<resultSetlen;i++)if(skill=resultSet.Queues[i],"0"===resultSet.Queues[i].SkillId){var lstSkill=that.skillQueueMap.hasOwnProperty(0)?that.skillQueueMap[0]:[];lstSkill.push(skill),that.skillQueueMap[0]=lstSkill}else that.skillQueueMap[resultSet.Queues[i].SkillId]=skill;AgentConsoleDataStore.lastNewSkillQueueUpdateTime!=localStorage.lastNewSkillQueueUpdateTime&&(localStorage.lastNewSkillQueueUpdateTime=AgentConsoleDataStore.lastNewSkillQueueUpdateTime),localStorage.skillQueueMap=JSON.stringify(that.skillQueueMap),localStorage.skillQueueMapUpdateTime=(new Date).getTime(),that.triggerEvent("skillQueueMap",that.SkillQueueEvent)}catch(ex){logger.error("Exception in getCacheQueueSuccess, "+ex)}finally{localStorage.skillRealTimeEventCount=0,setTimeout($.proxy(that.getCacheSkillQueue,that),5e3)}},function(status,statusText,response){if(logger.error("getCacheQueueFailure <<< status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),0!==status){var skillEventFailCount=!1===IC_Validation.isNotNullOrUndefinedString(localStorage.skillRealTimeEventCount)?0:parseInt(localStorage.skillRealTimeEventCount);skillEventFailCount<2?localStorage.skillRealTimeEventCount=skillEventFailCount+1:(that.addCustomError("Custom_SkillCacheErrorAttempt","Medium"),localStorage.skillRealTimeEventCount=0),setTimeout($.proxy(that.getCacheSkillQueue,that),5e3)}}),this.clearExpiredMessage()}catch(ex){logger.error("Exception in getCacheQueueFailure, "+ex)}},getCacheAgents:function(){try{if(IC_Validation.isNotNullOrEmpty(this.lastAgentCachePollTime)&&!1===this.pollAgentsCache||this.failureCount==this.maxFailureCount||IC_Validation.isNullOrEmpty(this.OAuthInfo)||IC_Validation.isNullOrEmpty(this.OAuthInfo.baseUri))return void setTimeout($.proxy(this.getCacheAgents,this),5e3);var url=this.OAuthInfo.baseUri+this.getCacheAgentsUri,that=this,updatedSince=null;updatedSince=IC_Validation.isNotNullOrEmpty(this.lastAgentCachePollTime)?this.lastAgentCachePollTime:IC_Common.toISODateString(new Date(0)),url+=IC_Common.formQueryString({Fields:"agentId,firstName,lastName,skillId,teamId,lastUpdateTime,agentStateId,userName,isACW,outStateCode,outStateDescription,agentStateName,isActive",UpdatedSince:updatedSince}),this.getRequest(url,function(response,status,statusText){this.failureCount=0;try{var i=0,resultSet=response.resultSet,resultSetlen=0,agent=null;if(that.lastAgentCachePollTime=resultSet.lastPollTime,IC_Validation.isNotNullOrEmptyArray(resultSet.agentState)&&(resultSetlen=resultSet.agentState.length),logger.debug("getCacheAgentSuccess <<< status:"+status+" statusText:"+statusText+" resultLen:"+resultSetlen),resultSetlen>0)for(i=0;i<resultSetlen;i++)agent=resultSet.agentState[i],that.agentListMap[resultSet.agentState[i].agentId]={id:agent.agentId,fn:agent.firstName,ln:agent.lastName,teamId:agent.teamId,utime:agent.lastUpdateTime,stateId:agent.agentStateId,un:agent.userName,acw:agent.isACW,osc:agent.outStateCode,osd:agent.outStateDescription,asn:agent.agentStateName,ia:agent.isActive};updatedSince===IC_Common.toISODateString(new Date(0))&&$(document).trigger(that.AgentListEvent),$(document).trigger(that.AgentStateChangeEvent)}catch(ex){logger.error("Exception in getCacheAgent, "+ex)}finally{setTimeout($.proxy(that.getCacheAgents,that),5e3)}},function(status,statusText,response){if(logger.error("getCacheAgentFailure <<< status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.failureCount++,that.failureCount<that.maxFailureCount){var retryInterval=5e3+that.failureTimeInterval*that.failureCount;logger.warn("getCacheAgent setTimeout request fired, timeinterval: "+retryInterval+"ms"),setTimeout($.proxy(that.getCacheAgents,that),retryInterval)}else setTimeout($.proxy(that.getCacheAgents,that),5e3),logger.error("getCacheAgent maximum failures reached, stop further API calls."),that.addCustomError("Custom_GetAgentStateCacheError","Medium")})}catch(ex){logger.error("getCacheAgents:"+ex.message)}},getAgentSkillAssignments:function(job){var url=this.OAuthInfo.baseUri+this.getAgentSkillAssignmentsUri,that=this;this.getRequest(url,function(response,status,statusText){try{var skill,agentSkills=response.agentSkillAssignments,i=0,len=agentSkills.length;for(that.agentSkillMap={},i=0;i<len;i++)skill=agentSkills[i],IC_Validation.isNotNullOrEmpty(that.agentSkillMap[agentSkills[i].AgentId])||(that.agentSkillMap[skill.AgentId]={}),that.agentSkillMap[skill.AgentId][skill.SkillId]=1;localStorage.agentSkillMap=JSON.stringify(that.agentSkillMap),localStorage.agentSkillMapUpdateTime=(new Date).getTime(),that.triggerEvent("agentSkillMap",that.AgentSkillAssignmentsEvent),logger.debug("getAgentSkillAssignments:- status:"+status+" statusText:"+statusText+" AgentSkillAssignments Count: "+len)}catch(ex){logger.error("getAgentSkillAssignments success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetAgentSkillAssignmentsError"),that.addIntervalJob(job.type,job.interval,job.hitCount),logger.error("getAgentSkillAssignments:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getAllUnavailableCodes:function(job){var url=this.OAuthInfo.baseUri+this.getUnavailableCodeUri,that=this;logger.trace("getAllUnavailableCodes request fired"),this.getRequest(url,function(response,status,statusText){try{that.allUnavailableList={};for(var unavailableCodes=response.unavailableCodes||[],i=0;i<unavailableCodes.length;i++){var respObj=unavailableCodes[i],cObj={id:respObj.outstateId,desc:respObj.outstateName,acw:IC_Common.toBoolean(respObj.isAcw),timeout:respObj.agentTimeoutMins,active:IC_Common.toBoolean(respObj.isActive)};that.allUnavailableList[cObj.id]=cObj}localStorage.allUnavailableList=JSON.stringify(that.allUnavailableList),localStorage.allUnavailableListUpdateTime=(new Date).getTime(),that.triggerEvent("allUnavailableList",that.AllUnavailableCodeListEvent),logger.debug("getAllUnavailableCodes:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getAllUnavailableCodes success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetAllUnavailableCodesError"),that.addIntervalJob(job.type,job.interval,job.hitCount),logger.error("getAllUnavailableCodes:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getAllSkills:function(job){var url=this.OAuthInfo.baseUri+this.getSkillsUri,that=this;url=IC_Common.appendQueryString(url,{fields:"skillId,skillName,mediaTypeId,mediaTypeName,isActive,isOutbound,acwTypeId,requireDisposition,allowSecondaryDisposition,outboundStrategy,isRunning,priorityBlending,emailFromAddress,emailFromEditable,screenPopTriggerEvent,agentOverrideBadNumber",isActive:!0}),logger.trace("getAllSkills request fired"),this.getRequest(url,function(response,status,statusText){try{that.allSkillList={};for(var i=0,len=response.skills.length;i<len;i++){var skillObj=response.skills[i],cObj={id:skillObj.skillId,name:skillObj.skillName,typeId:skillObj.mediaTypeId,typeName:skillObj.mediaTypeName,active:skillObj.isActive,isOutbound:skillObj.isOutbound,isDialer:!1,useAcw:3===skillObj.acwTypeId,useDisposition:2===skillObj.acwTypeId,reqDisposition:skillObj.requireDisposition,useSecDispositions:skillObj.allowSecondaryDisposition,strategy:skillObj.outboundStrategy,isNatural:skillObj.isRunning,isPriorityBlending:skillObj.priorityBlending,emailFromAddress:skillObj.emailFromAddress,emailFromEditable:skillObj.emailFromEditable,screenPopTriggerEvent:skillObj.screenPopTriggerEvent,agentOverrideBadNumber:skillObj.agentOverrideBadNumber};that.allSkillList[cObj.id]=cObj}logger.info("getAllSkills. Triggering loadAgentSkillInformation"),that.loadAgentSkillInformation(),localStorage.allSkillListUpdateTime=(new Date).getTime(),localStorage.allSkillList=JSON.stringify(that.allSkillList),that.triggerEvent("allSkillList",that.SkillListEvent),logger.debug("getAllSkills:- status:"+status+" statusText:"+statusText+" AllSkills Count: "+response.skills.length)}catch(ex){logger.error("getAllSkills success callback:"+ex.message)}finally{logger.info("Skill list fetched :"+job.callback),that.removeJob(job),"GetAgentInfo"===job.callback?that.addIntervalJob("GetAgentInfo",100,-1):"GetAgentSkills"===job.callback&&that.addIntervalJob("GetAgentSkills",100,-1)}},function(status,statusText,response){logger.info("Skill list failed :"+job.callback),that.removeJob(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetAllSkillsError"),that.addIntervalJob(job.type,job.interval,job.hitCount,job.callback),logger.error("getAllSkills:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getSkillAgents:function(skillId,callback){var url=this.OAuthInfo.baseUri+this.getSkillAgentsUri.replace("{skillId}",skillId),that=this;url=IC_Common.appendQueryString(url,{fields:"agentId,isActive"}),logger.trace("getSkillAgents fired for skillId: "+skillId),this.getRequest(url,function(response,status,statusText){try{var agentSkills=response.resultSet.agentSkillAssignments,len=IC_Validation.isNotNullOrUndefinedString(agentSkills)?agentSkills.length:0;logger.debug("getSkillAgents:- status:"+status+" statusText:"+statusText+" skills length: "+len);for(var agentList=[],i=0;i<len;i++){var respObj=agentSkills[i];IC_Common.toBoolean(respObj.isActive)&&agentList.push(respObj.agentId)}}catch(ex){logger.error("getSkillAgents success callback:"+ex.message)}finally{callback(agentList)}},function(status,statusText,response){that.addCustomError("Unable to get agents for this skill.","Medium"),logger.error("getSkillAgents:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response));callback([])})},getSkillDetails:function(skillId,callback){var url=this.OAuthInfo.baseUri+this.getSkillDetailsUri.replace("{skillId}",skillId);this.getRequest(url,function(response,status,statusText){logger.debug("getSkillDetails:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response));try{var skillObj=response,skillDetails={};skillDetails.emailParking=skillObj.emailParking,skillDetails.useSecDispositions=skillObj.allowSecondaryDisposition,skillDetails.reqDisposition=skillObj.requireDisposition,skillDetails.agentTypingIndicator=skillObj.agentTypingIndicator,skillDetails.patronTypingPreview=skillObj.patronTypingPreview,skillDetails.useDisposition="2"===skillObj.acwTypeId,skillDetails.prevSnooze=skillObj.prevSnooze,skillDetails.prevRequeue=skillObj.prevRequeue,skillDetails.prevReschedule=skillObj.prevReschedule,skillDetails.prevDisposition=skillObj.prevDisposition,skillDetails.agentOverrideBadNumber=skillObj.agentOverrideBadNumber}catch(ex){logger.error("getSkillDetails success callback:"+ex.message)}finally{callback(skillDetails)}},function(status,statusText,response){logger.error("getSkillDetails:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response));callback({})})},parkEmail:function(contactId,data,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.parkEmailUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),that=this,payloadJson={skillId:data.skillId,toAddress:data.toAddress,fromAddress:data.fromAddress,ccAddress:data.ccAddress,bccAddress:data.bccAddress,subject:data.subject,bodyHtml:data.bodyHtml,attachments:data.attachments,attachmentNames:data.attachmentNames,isDraft:data.isDraft,originalAttachmentNames:data.originalAttachmentNames,tags:this.getContactTags(contactId)};this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("parkEmail success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),localStorage.inboxLimitValidation="false","function"==typeof onSuccessCallback&&(that.removeContactResult(contactId),onSuccessCallback())},function(status,statusText,response){logger.error("parkEmail:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getContactTags:function(contactId){for(var tags="",contact=null,cLen=this.contacts.length,i=0;i<cLen;i++)if(contactId==(contact=this.contacts[i]).id){if(IC_Validation.isNotNullOrEmptyArray(contact.tags))for(var j=0,tLen=contact.tags.length;j<tLen;j++)tags+=contact.tags[j].tagId+"|";tags=tags.substr(0,tags.length-1);break}return tags},onParkEmailLimitValidation:function(){localStorage.inboxLimitValidation="true",this.triggerEvent("inboxLimitValidation",this.ParkedEmailLimitValidation)},unParkEmail:function(contactId,isImmediate,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.unParkEmailUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId),payloadJson={isImmediate:isImmediate};this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("unParkEmail success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback()},function(status,statusText,response){logger.error("unParkEmail:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},emailRestore:function(contactId,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.emailRestoreUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("emailRestore success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback()},function(status,statusText,response){logger.error("emailRestore:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},previewParkedEmail:function(contactId,onSuccessCallback,stopSetPreviewEmail){var url=this.OAuthInfo.baseUri+this.previewParkedEmailUri.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactId);this.postRequest(url,this.JSONEncoded,"{}",function(response,status,statusText){logger.debug("previewParkedEmail success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback()},function(status,statusText,response){logger.error("previewParkedEmail:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},parkPopoutEmail:function(contact,callback){if("true"===localStorage.isPopupOpen)localStorage.parkEmailId=contact.id,this.triggerEvent("parkEmailId",this.EmailParkEvent);else{var storedEmailInfo=this.getPersistEmailInfo(contact.id)||{},parkEmailData={skillId:contact.skillId,toAddress:contact.toAddress,fromAddress:contact.fromAddress,ccAddress:contact.ccAddress,bccAddress:contact.bccAddres,subject:contact.subject,bodyHtml:contact.bodyHTML,attachments:"",attachmentNames:"",isDraft:!1,originalAttachmentNames:contact.attachments},modifiedKeys=Object.keys(storedEmailInfo);storedEmailInfo.id==contact.id&&(-1!=modifiedKeys.indexOf("to")&&(parkEmailData.toAddress=storedEmailInfo.to),-1!=modifiedKeys.indexOf("cc")&&(parkEmailData.ccAddress=storedEmailInfo.cc),-1!=modifiedKeys.indexOf("bcc")&&(parkEmailData.bccAddress=storedEmailInfo.bcc),-1!=modifiedKeys.indexOf("sub")&&(parkEmailData.subject=storedEmailInfo.sub),-1!=modifiedKeys.indexOf("content")&&(parkEmailData.bodyHtml=storedEmailInfo.content),parkEmailData.isDraft=!!IC_Validation.isNotNullOrEmpty(storedEmailInfo.action)),this.parkEmail(contact.id,parkEmailData,callback)}},getParkedEmailDetails:function(forceCall,job){if(clearTimeout(this.parkedEmailTimer),"{}"!=JSON.stringify(this.OAuthInfo)){var url=this.OAuthInfo.baseUri+this.getParkedEmailDetailsUri,that=this;!0===this.amIPolling||!0===forceCall?(url+=IC_Common.formQueryString({fields:"",agentId:this.agentInfo.id}),logger.trace("getParkedEmailDetails request fired"),this.getRequest(url,function(response,status,statusText){that.parkedEmailList=[];try{var isExisting=!1;logger.debug("getParkedEmailDetails:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),IC_Validation.isNotNullOrEmpty(response)&&(that.parkedEmailList=response.resultSet.parkedContacts,that.parkedEmailList.sort(function(a,b){var firstTime=new Date(a.lastUpdateTime).getTime();return new Date(b.lastUpdateTime).getTime()-firstTime}));var dataStoreContacts=$.grep(AgentConsoleDataStore.contacts,function(item){return"Parked"===item.status});dataStoreContacts.length!==that.parkedEmailList.length&&$.grep(that.parkedEmailList,function(item){for(var dsContact in isExisting=!1,dataStoreContacts)dataStoreContacts[dsContact].id===item.contactId&&(isExisting=!0);isExisting||IC_Validation.isNotNullOrUndefinedString(item.contactId)&&that.previewParkedEmail(item.contactId,null,!0)}),localStorage.parkedEmailList=JSON.stringify(that.parkedEmailList),that.triggerEvent("parkedEmailList",that.ParkedEmailDetailsEvent)}catch(ex){logger.error("getParkedEmailDetails success callback:"+ex.message)}finally{logger.trace("getParkedEmailDetails setTimeout request fired"),IC_Validation.isNotNull(job)&&that.removeJob(job),that.parkedEmailTimer=setTimeout($.proxy(that.getParkedEmailDetails,that),3e4)}},function(status,statusText,response){logger.error("getParkedEmailDetails:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),IC_Validation.isNotNull(job)&&that.removeJob(job),that.parkedEmailTimer=setTimeout($.proxy(that.getParkedEmailDetails,that),3e4)})):logger.info("Stopped getParkedEmailDetails")}},getAgentSkills:function(job){var url=this.OAuthInfo.baseUri+this.getAgentSkillsUri.replace("{agentId}",this.agentInfo.id),that=this;url=IC_Common.appendQueryString(url,{fields:"skillId, skillName, isOutbound, isDialer, isNaturalCallingRunning, outboundStrategy, priorityBlending, mediaTypeId, isRestricted, isActive",isSkillActive:!0}),this.getRequest(url,function(response,status,statusText){try{that.agentSkillList=[];for(var i=0;i<response.agentSkillAssignments.length;i++){var respObj=response.agentSkillAssignments[i];if(respObj.isActive&&!respObj.isRestricted){var cObj={id:respObj.skillId,name:respObj.skillName,isOutbound:respObj.isOutbound,isDialer:respObj.isDialer,isNatural:respObj.isNaturalCallingRunning,strategy:respObj.outboundStrategy,isPriorityBlending:respObj.priorityBlending,typeId:respObj.mediaTypeId};that.agentSkillList.push(cObj)}}that.loadAgentSkillInformation(),that.triggerEvent("allSkillList",that.SkillListEvent),logger.debug("getAgentSkills:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getAgentSkills success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetAgentsSkillsError"),that.addIntervalJob(job.type,job.interval,job.hitCount),logger.error("getAgentSkills:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},loadAgentSkillInformation:function(){localStorage.agentSkillList=JSON.stringify(this.agentSkillList),localStorage.agentSkillListUpdateTime=(new Date).getTime(),this.triggerEvent("agentSkillList",this.AgentSkillListEvent)},getAgentInfo:function(job){var url=this.OAuthInfo.baseUri+this.getAgentUri.replace("{agentId}",this.agentInfo.id),that=this;this.getRequest(url,function(response,status,statusText){logger.debug("getAgentInfo:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response));try{if(void 0!==response.agents&&response.agents.length>0){var agentObj=response.agents[0];that.agentInfo.teamId=agentObj.teamId,that.agentInfo.teamName=agentObj.teamName,that.agentInfo.userName=agentObj.userName,that.agentInfo.fName=agentObj.firstName,that.agentInfo.lName=agentObj.lastName,that.agentInfo.userId=agentObj.userId,that.agentInfo.chatRefusalTimeout=!0===IC_Validation.isNotNullOrUndefinedString(agentObj.chatRefusalTimeout)?parseInt(agentObj.chatRefusalTimeout):45,that.agentInfo.maxChatsAllowed=agentObj.maxConcurrentChats,that.agentInfo.maxEmailInboxAllowed=agentObj.maxEmailInboxCount,!0!==agentObj.teamDefaultMaxChats&&!0!==agentObj.useTeamMaxEmailInboxCount||(that.agentInfo.teamDefaultMaxChats=agentObj.teamDefaultMaxChats,that.agentInfo.useTeamMaxEmailInbox=agentObj.useTeamMaxEmailInboxCount,that.addIntervalJob("GetTeamDetails",100,-1)),that.addIntervalJob("GetTeamUnavailableCodes",100,-1),that.addIntervalJob("GetAgentSkills",100,-1),that.addIntervalJob("GetAddressBookByAgent",100,-1),that.addIntervalJob("OnUpdateMessagesEvent",100,-1),that.isEmailFeatureEnabled&&(that.addIntervalJob("GetBusinessUnit",100,-1),that.addIntervalJob("GetQuickReply",100,-1)),localStorage.agentInfo=JSON.stringify(that.agentInfo),that.triggerEvent("agentInfo",that.AgentInfoEvent),IC_Validation.isNotNullOrUndefinedString(localStorage.cHistory)&&(that.cHistoryArr=IC_Common.parseJSON(localStorage.cHistory),that.fireContactHistorySortEvent())}}catch(ex){logger.error("getAgentInfo success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetAgentInfoError"),that.addIntervalJob(job.type,job.interval,job.hitCount),logger.error("getAgentInfo:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getTeamUnavailableCodes:function(job){var url=this.OAuthInfo.baseUri+this.getTeamUnavailableCodeUri.replace(/{teamId}/g,this.agentInfo.teamId),that=this;this.getRequest(url,function(response,status,statusText){logger.debug("getTeamUnavailableCodes:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response));try{that.teamUnavailableList=[];for(var unavailableCodes=response.resultSet.unavailableCodes||[],i=0;i<unavailableCodes.length;i++){var respObj=unavailableCodes[i],cObj={id:respObj.outstateId,desc:respObj.outstateName,acw:IC_Common.toBoolean(respObj.isAcw),timeout:respObj.agentTimeoutMins,active:IC_Common.toBoolean(respObj.isActive)};that.teamUnavailableList.push(cObj)}localStorage.teamUnavailableList=JSON.stringify(that.teamUnavailableList),localStorage.teamUnavailableListUpdateTime=(new Date).getTime(),that.triggerEvent("teamUnavailableList",that.UnavailableListEvent)}catch(e){logger.error("getTeamUnavailableCodes success callback:"+e.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetTeamUnavailableCodesError"),that.addIntervalJob(job.type,job.interval,job.hitCount),logger.error("getTeamUnavailableCodes:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getDispositions:function(skillObj,callBack){var url=this.OAuthInfo.baseUri+this.getDispositionsUri.replace("{skillId}",skillObj.id),dispositions=[],that=this;this.getRequest(url,function(response,status,statusText){try{for(var i=0;i<response.dispositions.length;i++){var respObj=response.dispositions[i];if(respObj.hasOwnProperty("dispositionId")){var dispObj={id:respObj.dispositionId,name:respObj.dispositionName,order:respObj.displayOrder,isPreviewDisposition:respObj.isPreviewDisposition};IC_Validation.isNullOrEmpty(respObj.requireCommitmentAmount)||(dispObj.isAmount="boolean"==typeof respObj.requireCommitmentAmount?respObj.requireCommitmentAmount:IC_Common.toBoolean(respObj.requireCommitmentAmount),dispObj.isDate="boolean"==typeof respObj.requireRescheduleDate?respObj.requireRescheduleDate:IC_Common.toBoolean(respObj.requireRescheduleDate)),dispositions.push(dispObj)}}skillObj.dispositions=dispositions,localStorage.allSkillList=JSON.stringify(that.allSkillList),localStorage.allSkillListUpdateTime=(new Date).getTime(),localStorage.dispSkillId=skillObj.id,that.inMemStorage.dispSkillId=skillObj.id,that.triggerEvent("dispSkillId",that.DispositionEvent,[skillObj.id]),logger.debug("getDispositions:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getDispositions success callback:"+ex.message)}finally{"function"==typeof callBack&&callBack()}},function(status,statusText,response){logger.error("getDispositions:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getContactHistory:function(fromDate,toDate,callback){var url=this.OAuthInfo.baseUri+this.getContactStatesUri.replace("{agentId}",this.agentInfo.id)+"?startDate="+fromDate+"&endDate="+toDate,contactData=[];this.getRequest(url,function(response,status,statusText){try{response.contactList.hasOwnProperty("contactStates")&&(contactData=response.contactList.contactStates),logger.debug("getContactHistory:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getContactHistory success callback:"+ex.message)}finally{callback(contactData)}},function(status,statusText,response){logger.error("getContactHistory:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback(contactData)})},getAgentPerformanceHistory:function(fromDate,toDate,callback){var agentPerformance,url=this.OAuthInfo.baseUri+this.getAgentPerformanceUri.replace("{agentId}",this.agentInfo.id)+"?startDate="+fromDate+"&endDate="+toDate;this.getRequest(url,function(response,status,statusText){try{IC_Validation.isNotNullOrUndefinedString(response.agentPerformance)&&(agentPerformance=response.agentPerformance[0]),logger.debug("getAgentPerformanceHistory:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getAgentPerformanceHistory success callback:"+ex.message)}finally{callback(agentPerformance)}},function(status,statusText,response){logger.error("getAgentPerformanceHistory:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback(agentPerformance)})},getTeamPerformanceHistory:function(fromDate,toDate,callback){var url=this.OAuthInfo.baseUri+this.getTeamPerformanceUri.replace("{teamId}",this.agentInfo.teamId),teamPerformance="",params={startDate:fromDate,endDate:toDate,fields:"inboundHandled,outboundHandled,totalHandled,availableTime,unavailableTime,inboundTalkTime,outboundTalkTime,loginTime"};url=IC_Common.appendQueryString(url,params),this.getRequest(url,function(response,status,statusText){try{IC_Validation.isNotNullOrUndefinedString(response.teamPerformanceTotal)&&IC_Validation.isNotNullOrUndefinedString(response.teamPerformanceTotal[0])&&(teamPerformance=response.teamPerformanceTotal[0]),logger.debug("getTeamPerformanceUri:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getTeamPerformanceUri success callback:"+ex.message)}finally{callback(teamPerformance)}},function(status,statusText,response){logger.error("getTeamPerformanceUri:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback(teamPerformance)})},persistContactHistoryFilterData:function(sortByItem,filterItem,searchText){this.cHistory.sortByItem=sortByItem,this.cHistory.filterItem=filterItem,this.cHistory.searchText=searchText;var i,aId=this.agentInfo.id,sortItem={id:this.agentInfo.id,sortByItem:sortByItem,filterItem:filterItem,searchText:searchText},index=-1,len=this.cHistoryArr.length;if(len>0){for(i=len-1;i>-1;i--)if(aId===this.cHistoryArr[i].id){index=i;break}-1!==index?this.cHistoryArr.slice(index,index+1):10===len&&this.cHistoryArr.slice(0,1)}this.cHistoryArr.push(sortItem),this.cHistory=sortItem,localStorage.cHistory=JSON.stringify(this.cHistoryArr)},fireContactHistorySortEvent:function(){if(IC_Validation.isValidObject(this.agentInfo)){var i,aId=this.agentInfo.id;for(i=this.cHistoryArr.length-1;i>-1;i--)if(aId===this.cHistoryArr[i].id){this.cHistory=this.cHistoryArr[i],$(document).trigger(this.ContactHistoryEvent);break}}},getAcwFlag:function(state,reason){var key,unavailObj,isAcw=!1;if(IC_Validation.isNotNullOrUndefinedString(state)&&"Unavailable"===state&&IC_Validation.isNotNullOrUndefinedString(reason))for(key in this.allUnavailableList)if(this.allUnavailableList.hasOwnProperty(key)&&(unavailObj=this.allUnavailableList[key]).desc===reason){isAcw=unavailObj.acw;break}return isAcw},getAddressBookByAgent:function(job){var url=this.OAuthInfo.baseUri+this.getAddressBookAgentNameUri.replace("{username}",this.agentInfo.id),that=this;url+=IC_Common.formQueryString({includeEntries:!1}),this.getRequest(url,function(response,status,statusText){that.addressBooksByAgent=[];try{IC_Validation.isNotNullOrUndefinedString(response)&&IC_Validation.isNotNullOrUndefinedString(response.addressBooks)&&(that.addressBooksByAgent=response.addressBooks),logger.debug("getAddressBookByAgent:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getAddressBookByAgent success callback:"+ex.message)}finally{that.loadAddressBook(job)}},function(status,statusText,response){that.loadAddressBook(job),that.addAPIJobErrorMsg(job.hitCount,"Custom_GetAddressBookByAgentError"),that.addIntervalJob(job.type,job.interval,job.hitCount),logger.error("getAddressBookByAgent:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},loadAddressBook:function(job){var len,addressBookName,addressBookId,addressBookType,addressBooks=[];this.addressBookList=[],localStorage.addressBookList="[]",IC_Validation.isNotNullOrEmptyArray(this.addressBooksByAgent)&&(addressBooks=addressBooks.concat(this.addressBooksByAgent)),len=addressBooks.length;for(var i=0;i<len;i++){IC_Validation.isNotNullOrEmpty(addressBooks[i].AddressBookName)?addressBookName=addressBooks[i].AddressBookName:IC_Validation.isNotNullOrEmpty(addressBooks[i].addressBookName)&&(addressBookName=addressBooks[i].addressBookName),IC_Validation.isNotNullOrEmpty(addressBooks[i].AddressBookId)?addressBookId=addressBooks[i].AddressBookId:IC_Validation.isNotNullOrEmpty(addressBooks[i].addressBookId)&&(addressBookId=addressBooks[i].addressBookId),IC_Validation.isNotNullOrEmpty(addressBooks[i].AddressBookType)?addressBookType=addressBooks[i].AddressBookType:IC_Validation.isNotNullOrEmpty(addressBooks[i].addressBookType)&&(addressBookType=addressBooks[i].addressBookType);var addressBookNameEntry={id:addressBookId,name:addressBookName,type:addressBookType};this.addressBookList.push(addressBookNameEntry)}this.addressBookList.sort(function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?1:0}),localStorage.addressBookList=JSON.stringify(this.addressBookList),$(document).trigger(this.AddressBooksEvent),this.removeJob(job)},getAddressBook:function(){IC_Validation.isNotNullOrUndefinedString(localStorage.addressBookList)&&(this.addressBookList=IC_Common.parseJSON(localStorage.addressBookList),$(document).trigger(this.AddressBooksEvent))},getAddressBookEntries:function(addressBookId,callback,searchText,sortField){var addressBook,url=this.OAuthInfo.baseUri+this.getAddressBookEntriesUri.replace("{addressBookId}",addressBookId),addressBookEntries=[];url+=IC_Common.formQueryString({updatedSince:"10/10/1800",searchString:searchText||"",fields:"addressBookEntryId,firstName,lastName,phone,mobile,email",skip:0,top:1e3,orderby:sortField||""}),this.getRequest(url,function(response,status,statusText){try{if(!IC_Validation.isNotNullOrUndefinedString(response))return void logger.debug("getAddressBookEntries:- status:"+status+" statusText:"+statusText+" response: No Entries");void 0!==(addressBook=response.addressBook).addressBookEntries&&(addressBookEntries=addressBook.addressBookEntries),logger.debug("getAddressBookEntries:- status:"+status+" statusText:"+statusText+" addressbook entries count:"+addressBookEntries.length)}catch(ex){logger.error("getAddressBookEntries success callback:"+ex.message)}finally{callback(addressBookEntries,searchText,addressBookId)}},function(status,statusText,response){logger.error("getAddressBookEntries:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback(addressBookEntries,searchText,addressBookId)})},getDynamicAddressBookEntries:function(addressBookId,isFullLoad,updatedSince,callback){var addressBook,url=this.OAuthInfo.baseUri+this.getDynamicAddressBookEntriesUri.replace("{addressBookId}",addressBookId),addressBookEntries=[],latestUpdatedSince=null,fullLoad=!1;url+=IC_Common.formQueryString({fullLoad:isFullLoad,updatedSince:updatedSince}),logger.trace("getDynamicAddressBookEntries request fired addressBookName: "+addressBookId),this.getRequest(url,function(response,status,statusText){try{IC_Validation.isNotNullOrUndefinedString(response)?(void 0!==(addressBook=response.addressBook).addressBookEntries&&(addressBookEntries=addressBook.addressBookEntries),addressBook&&addressBook.serverTime&&(latestUpdatedSince=addressBook.serverTime),addressBook&&addressBook.fullLoad&&(fullLoad=IC_Common.toBoolean(addressBook.fullLoad)),logger.debug("getDynamicAddressBookEntries:- status:"+status+" statusText:"+statusText+" address book entries count: "+addressBookEntries.length)):logger.debug("getDynamicAddressBookEntries:- status:"+status+" statusText:"+statusText+" response: No Entries")}catch(ex){logger.error("getDynamicAddressBookEntries success callback:"+ex.message)}finally{callback(addressBookEntries,latestUpdatedSince,fullLoad)}},function(status,statusText,response){logger.error("getDynamicAddressBookEntries:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback(addressBookEntries,null,fullLoad)})},getFeedbackCategoryAndPriority:function(){var url=this.OAuthInfo.baseUri+this.getFeedbackCategoryPriorityUri,that=this;this.getRequest(url,function(response,status,statusText){try{var category,priority,categoryLen=response.CategoriesAndPriorities.feedbackCategories.length,priorityLen=response.CategoriesAndPriorities.feedbackPriorities.length,i=0,j=0;for(that.category=[],that.priority=[],i=0;i<categoryLen;i++)category=response.CategoriesAndPriorities.feedbackCategories[i],that.category.push({id:category.id,value:category.name});for(j=0;j<priorityLen;j++)priority=response.CategoriesAndPriorities.feedbackPriorities[j],that.priority.push({id:priority.id,value:priority.name,name:priority.name});localStorage.category=JSON.stringify(that.category),localStorage.priority=JSON.stringify(that.priority),$(document).trigger(that.FeedbackCategoryEvent),logger.debug("getFeedbackCategoryAndPriority:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getFeedbackCategoryAndPriority success callback:"+ex.message)}},function(status,statusText,response){logger.error("ajax error @ getFeedbackCategoryAndPriority:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},getQuickReply:function(job){var url=this.OAuthInfo.baseUri+this.quickReplyUri.replace("{sessionId}",this.getIcSessionId()).replace("{agentId}",this.agentInfo.id),that=this;this.getRequest(url,function(response,status,statusText){try{if(logger.debug("getQuickReply success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.quickReply=[],IC_Validation.isNotNullOrUndefinedString(response)&&IC_Validation.isNotNullOrEmptyArray(response.quickReplies))for(var i=0;i<response.quickReplies.length;i++){for(var respObj=response.quickReplies[i],cObj={id:respObj.quickReplyId,title:respObj.title,key:respObj.keyWords,content:respObj.content,isFav:"1"===respObj.isFavorite,skill:{}},skillObj={},j=0;j<respObj.skills.length;j++)skillObj[respObj.skills[j].skillId]=respObj.skills[j].skillName;cObj.skill=skillObj,that.quickReply.push(cObj)}localStorage.quickReply=JSON.stringify(that.quickReply)}catch(ex){logger.error("getQuickReply success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){logger.error("getQuickReply:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.removeJob(job),0!=status&&that.addAPIJobErrorMsg(job.hitCount,"Custom_GetQuickReplyErrorAttempt"),that.addIntervalJob(job.type,job.interval,job.hitCount)})},sendDTMFTones:function(dtmfValue){var url=this.OAuthInfo.baseUri+this.sendDTMFUri.replace("{sessionId}",this.getIcSessionId()),payloadJson={DtmfSequence:dtmfValue,ToneDurationMS:120,ToneSpacingMS:120},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("feedback success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("feedback success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.addCustomError("Custom_SendDTMFTones","Medium")})},submitFeedbackForm:function(categoryId,priority,comment,customData){var contactId=localStorage.lastAttentedContactId;""===contactId&&(contactId="0");var url=this.OAuthInfo.baseUri+this.feedbackUri.replace("{sessionId}",this.getIcSessionId()),payloadJson={categoryId:categoryId,priority:priority,comment:comment,customData:customData,contactId:contactId},that=this;logger.trace("submitFeedbackForm request fired categoryId: "+categoryId+" priority: "+priority+" comment: "+comment+" customData: "+customData+" contactId: "+contactId),this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("submitFeedbackForm success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){logger.error("submitFeedbackForm success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),that.addCustomError("Custom_AddfeedbackAttempt","Medium")})},addAPIJobErrorMsg:function(hitCount,msg){hitCount%4==0&&this.addCustomError(msg,"Medium")},addCustomError:function(errorCode,errorLevel){logger.trace("addCustomError errorCode: "+errorCode+" errorLevel: "+errorLevel);try{var errorId=(new Date).getTime();if(!1===this.errorList.contains(function(i,e){return e.messages.contains(function(i,m){return m.code===errorCode})}))return this.errorList.push({id:errorId,messages:[{level:errorLevel,code:errorCode}]}),localStorage.errorList=JSON.stringify(this.errorList),this.triggerEvent("errorList",this.APIErrorEvent),errorId;"Custom_SessionEnd"===errorCode&&this.triggerEvent("errorList",this.APIErrorEvent)}catch(ex){logger.error("addCustomError:"+ex.message)}return null},onEventError:function(errorEvents){logger.trace("onEventError fired");try{var errorMessages=[],i=0,errorCode=null,dupErrorCodes={};for(i=0;i<errorEvents.length;i++){var errorObj=errorEvents[i];errorCode=errorObj.Target+"_"+errorObj.Command+"_"+errorObj.ResultCode,dupErrorCodes.hasOwnProperty(errorCode)||(errorMessages.push({level:errorObj.ErrorLevel,code:errorCode}),dupErrorCodes[errorCode]=!0)}errorMessages.length>0&&this.errorList.push({id:(new Date).getTime(),messages:errorMessages}),localStorage.errorList=JSON.stringify(this.errorList),this.triggerEvent("errorList",this.APIErrorEvent)}catch(ex){logger.error("onEventError: "+ex.message)}},onAgentStateEvent:function(event){try{if(this.agentInfo.cState={state:event.CurrentState,reason:event.CurrentOutReason,time:new Date(event.StartTimeUTC).getTime(),timeout:parseInt(event.AcwTimeout),acw:IC_Common.toBoolean(event.IsAcw)},"object"==typeof event.NextStates){this.agentInfo.nState=[];for(var i=0;i<event.NextStates.length;i++)this.agentInfo.nState.push({state:event.NextStates[i].State,reason:event.NextStates[i].OutReason,acw:this.getAcwFlag(event.NextStates[i].State,event.NextStates[i].OutReason)})}localStorage.agentInfo=JSON.stringify(this.agentInfo),this.triggerEvent("agentInfo",this.AgentInfoEvent)}catch(ex){logger.error("onAgentStateEvent: "+ex.message)}},onAgentSessionStartEvent:function(event){try{var dialerCampaignExists=!IC_Validation.isNullOrEmpty(this.agentInfo.dialerCampaign);this.agentInfo.id=event.AgentId,this.agentInfo.busNo=event.BusNo,this.agentInfo.mask=IC_Common.toBoolean(event.CanMask),this.agentInfo.phNo=event.StationPhoneNumber,this.agentInfo.stationId=event.StationId,this.agentInfo.callerId=event.StationCallerId,this.agentInfo.sessionId=event.SessionId,this.agentInfo.dialerCampaign=event.DialerCampaign,this.agentInfo.dialerLoginTime=IC_Validation.isNullOrEmpty(event.DialerCampaignStartTime)?this.getServerTimestamp():new Date(event.DialerCampaignStartTime).getTime(),this.agentInfo.enabledForMCH=IC_Common.toBoolean(event.EnabledForMCH),this.agentInfo.agentuuid=event.AgentUUId,this.agentInfo.portNumber=IC_Validation.isNullOrEmpty(event.portNumber)?"31322":event.portNumber,dialerCampaignExists&&IC_Validation.isNullOrEmpty(this.agentInfo.dialerCampaign)&&(this.isSkillRunningLow=!0,localStorage.isSkillRunningLow=this.isSkillRunningLow,this.pcQueueContacts=[],localStorage.pcQueueContacts=JSON.stringify(this.pcQueueContacts),this.triggerEvent("pcQueueContacts",this.SkillRunningLowEvent)),localStorage.agentInfo=JSON.stringify(this.agentInfo),!0!==this.isSessionStarted()?(this.addIntervalJob("GetPermissions",100,-1),this.addIntervalJob("GetAgentInfo",100,-1),this.addIntervalJob("GetPromiseKeeper",100,-1),this.addIntervalJob("GetTimeZones",100,-1),this.addIntervalJob("GetBrandingProfiles",100,-1),this.addIntervalJob("GetParkedEmails",100,-1),$(document).trigger(this.AgentSessionStartEvent),this.setSessionStarted(!0)):IC_Validation.isValidObject(this.agentInfo.cState)&&(this.triggerEvent("permissionsList",this.PermissionsListEvent),this.triggerEvent("agentInfo",this.AgentInfoEvent),this.triggerEvent("promiseKeeperList",this.PromiseKeeperEvent),this.triggerEvent("timeZoneList",this.TimeZoneEvent),this.triggerEvent("brandingProfile",this.BrandingProfilesEvent),this.triggerEvent("parkedEmailList",this.ParkedEmailDetailsEvent))}catch(ex){logger.error("onAgentSessionStartEvent: "+ex.message)}},onMCHAgentSettingsChangeEvent:function(event){this.agentInfo.chatThreshold=event.ChatThreshold,this.agentInfo.emailThreshold=event.EmailThreshold,this.agentInfo.workItemThreshold=event.WorkItemThreshold,this.agentInfo.contactAutoFocus=event.ContactAutoFocus,localStorage.agentInfo=JSON.stringify(this.agentInfo)},onAgentLegEvent:function(event){try{this.agentInfo.lgState=event.Status,this.agentInfo.lgId=event.AgentLegId,this.agentInfo.lgFinalState=IC_Common.toBoolean(event.FinalState),localStorage.agentInfo=JSON.stringify(this.agentInfo),this.triggerEvent("agentInfo",this.AgentInfoEvent)}catch(ex){logger.error("onAgentLegEvent: "+ex.message)}},onSkillRunningLowEvent:function(event){try{this.isSkillRunningLow=IC_Common.toBoolean(event.Empty),localStorage.isSkillRunningLow=this.isSkillRunningLow,this.triggerEvent("isSkillRunningLow",this.SkillRunningLowEvent)}catch(ex){logger.error("onSkillRunningLowEvent: "+ex.message)}},onUpdateDialerCampaign:function(event){var i,len,naturalCallingSkill={};for(i=0,len=event.Campaign.length;i<len;i++){naturalCallingSkill[event.Campaign[i].SkillName]=!0}for(i=0,len=this.agentSkillList.length;i<len;i++){var skill=this.agentSkillList[i];naturalCallingSkill.hasOwnProperty(skill.name)?this.allSkillList[skill.id].isNatural=!0:this.allSkillList[skill.id].isNatural=!1}localStorage.allSkillList=JSON.stringify(this.allSkillList),localStorage.allSkillListUpdateTime=(new Date).getTime(),this.triggerEvent("allSkillList",this.SkillListEvent)},onUpdateSkill:function(event){if(event.hasOwnProperty("Skill")){this.agentSkillList=[],this.agentSkillMap[this.agentInfo.id]={};for(var i=0,len=event.Skill.length;i<len;i++){var skillObj=event.Skill[i],cObj={id:IC_Common.toNumber(skillObj.SkillId),name:skillObj.SkillName,typeId:IC_Common.toNumber(skillObj.MediaTypeId),typeName:skillObj.MediaTypeName,active:IC_Common.toBoolean(skillObj.IsActive),isOutbound:IC_Common.toBoolean(skillObj.IsOutbound),isDialer:IC_Common.toBoolean(skillObj.IsDialer),useAcw:IC_Common.toBoolean(skillObj.UseACW),useDisposition:IC_Common.toBoolean(skillObj.UseDisposition),reqDisposition:IC_Common.toBoolean(skillObj.RequireDisposition),useSecDispositions:IC_Common.toBoolean(skillObj.UseSecondaryDispositions),strategy:skillObj.OutboundStrategy,isNatural:IC_Common.toBoolean(skillObj.IsNaturalCallingRunning),isPriorityBlending:IC_Common.toBoolean(skillObj.PriorityBlending),dispositions:[]};cObj.active&&(this.allSkillList[cObj.id]=cObj,this.agentSkillMap[this.agentInfo.id][cObj.id]=1,this.agentSkillList.push(cObj))}localStorage.agentSkillList=JSON.stringify(this.agentSkillList),localStorage.agentSkillListUpdateTime=(new Date).getTime(),this.triggerEvent("agentSkillList",this.AgentSkillListEvent),localStorage.agentSkillMap=JSON.stringify(this.agentSkillMap),localStorage.agentSkillMapUpdateTime=(new Date).getTime(),this.triggerEvent("agentSkillMap",this.AgentSkillAssignmentsEvent),localStorage.allSkillList=JSON.stringify(this.allSkillList),localStorage.allSkillListUpdateTime=(new Date).getTime(),this.triggerEvent("allSkillList",this.SkillListEvent)}},onHoursOfOperation:function(event){try{IC_Validation.isNullOrEmpty(this.skillClosed)&&(this.skillClosed={}),this.skillClosed.showPrompt=IC_Common.toBoolean(event.ShowContinueReskill),localStorage.skillClosed=JSON.stringify(this.skillClosed),this.triggerEvent("skillClosed",this.SkillClosedHoursEvent)}catch(ex){logger.error("onHoursOfOperation: "+ex.message)}},onMuteEvent:function(event){try{this.agentInfo.lgMuted=IC_Common.toBoolean(event.AgentMuted),localStorage.agentInfo=JSON.stringify(this.agentInfo),this.triggerEvent("agentInfo",this.AgentInfoEvent)}catch(ex){logger.error("onMuteEvent: "+ex.message)}},processContact:function(con){if(!1===this.amIPolling){var j,hasContact,cId,lstContact=IC_Common.parseJSON(con),len=this.contacts.length,i=0,contacts=this.contacts;for(logger.trace("processContact fired"),i=0;i<len;i++)if(IC_Validation.isNotNullOrUndefinedString(contacts[i])){for(cId=contacts[i].id,hasContact=!1,j=0;j<lstContact.length;j++)if(cId===lstContact[j].id){hasContact=!0;break}!1===hasContact&&(logger.info("onStorage : Clearing contact - "+cId),this.processOrphanContact(contacts[i],!0,!1))}}},processOrphanContact:function(contact,taskCreation,canUpdateResult){try{contact.status="EmailContactEvent"===contact.contactType?"Discarded":"Disconnected",contact.finalState=!0,"ChatContactEvent"===contact.contactType&&(contact.active=!1),contact.taskCreation=!1!==taskCreation,!1===IC_Validation.isNotNullOrUndefinedString(contact.canUpdateResult)&&(contact.canUpdateResult=!1),contact.canUpdateResult=!1!==canUpdateResult,logger.debug("Processed Orphan Contact: "+contact.id+" taskCreation: "+taskCreation+" canUpdateResult: "+canUpdateResult),localStorage.contacts=JSON.stringify(this.contacts),this.triggerEvent("contacts",this.ContactEvent,[contact.contactType])}catch(ex){logger.error("processOrphanContact: "+ex.message)}},onChatText:function(event){try{var contact,msgDetail={id:IC_Common.generateChatMessageId(event.Message,event.TimeStamp),msg:event.Message,type:event.PartyType,label:event.Label,time:new Date(event.TimeStamp).getTime()},i=0;for(i=0;i<this.contacts.length;i++)if("ChatContactEvent"===(contact=this.contacts[i]).contactType&&contact.roomId===event.RoomId){IC_Validation.isNotNullOrEmptyArray(this.chatMsg[contact.id])?this.chatMsg[contact.id].length>11&&this.chatMsg[contact.id].splice(0,1):this.chatMsg[contact.id]=[],this.chatMsgUpdatedContactId=contact.id,localStorage.chatMsgUpdatedContactId=this.chatMsgUpdatedContactId,this.chatMsg[contact.id].push(msgDetail);break}localStorage.chatMsg=JSON.stringify(this.chatMsg),this.triggerEvent("chatMsg",this.ChatMsgEvent)}catch(ex){logger.error("onChatText: "+ex.message)}},onUpdateChatTranscript:function(job){var that=this,contactId=job.data.ContactID;this.getChatConversation(contactId,function(messages){try{var i,len=messages.length-1,j=0;for(that.chatMsg[contactId]=[],i=len;i>=0&&!(j>10);i--)that.chatMsg[contactId].splice(0,0,messages[i]),j++;logger.debug("loadIntialChatTranscript: loading... "+that.chatMsg[contactId].length),that.chatMsgUpdatedContactId=contactId,localStorage.chatMsgUpdatedContactId=contactId,localStorage.chatMsg=JSON.stringify(that.chatMsg),that.triggerEvent("chatMsg",that.ChatMsgEvent)}catch(ex){logger.error("onUpdateChatTranscript: "+ex.message)}finally{that.removeJob(job)}})},loadIntialChatTranscript:function(contactId,messages){logger.trace("ContactID: "+contactId," loadIntialChatTranscript fired messages: "+messages);var i,msgDetail,len=messages.length-1,j=0;for(this.chatMsg[contactId]=[],i=len;i>=0&&!(j>10);i--){var temp=messages[i];msgDetail={id:IC_Common.generateChatMessageId(temp.Text,temp.TimeStamp),msg:temp.Text,type:temp.PartyType,time:new Date(temp.TimeStamp).getTime()},this.chatMsg[contactId].splice(0,0,msgDetail),j++}logger.debug("loadIntialChatTranscript: loading... "+this.chatMsg[contactId].length),this.chatMsgUpdatedContactId=contactId,localStorage.chatMsgUpdatedContactId=contactId,localStorage.chatMsg=JSON.stringify(this.chatMsg),this.triggerEvent("chatMsg",this.ChatMsgEvent)},onChatContactEvent:function(event){try{var chatObj={id:event.ContactID,status:event.Status,contactType:event.Type,skillId:event.Skill||event.SkillId,time:new Date(event.StartTime).getTime(),lastStateTime:new Date(event.LastStateChangeTime).getTime(),screenPopUrl:event.ScreenPopUrl,finalState:IC_Common.toBoolean(event.FinalState),refusalTimeout:parseInt(event.RefusalTimeout),active:IC_Common.toBoolean(event.IsActive),roomId:event.RoomId,customData:event.CustomData,tags:[],isRefused:!1},isNewChat=this.contacts.isNewObject(chatObj,function(a,b){return a.id===b.id});this.contacts.addOrUpdate(chatObj,function(a,b){return a.id===b.id&&("Incoming"===a.status&&"Active"===b.status?b.activeTime=chatObj.lastStateTime:a.hasOwnProperty("activeTime")&&(b.activeTime=a.activeTime),"Incoming"===a.status&&"Disconnected"===b.status&&(b.isRefused=!0),b.tags=a.tags,!0)}),!0===isNewChat&&this.addIntervalJob("GetQuickReply",100,-1),IC_Validation.isNotNullOrEmptyArray(event.Messages)&&this.loadIntialChatTranscript(event.ContactID,event.Messages),localStorage.contacts=JSON.stringify(this.contacts),localStorage.lastAttentedContactId=chatObj.id,this.triggerEvent("contacts",this.ContactEvent,[event.Type])}catch(ex){logger.error("onContactEvent: "+ex.message)}},onEmailContactEvent:function(event){try{var emailObj={id:event.ContactId,contactId:event.ContactId,status:event.Status,contactType:event.Type,type:event.EmailType,skillId:event.Skill||event.SkillId,isInbound:IC_Common.toBoolean(event.IsInbound),time:new Date(event.StartTimeUTC).getTime(),lastStateTime:new Date(event.LastStateChangeTimeUTC).getTime(),screenPopUrl:event.ScreenPopUrl,finalState:IC_Common.toBoolean(event.FinalState),fromAddress:IC_Validation.isNotNullOrUndefinedString(event.FromAddress)?event.FromAddress:"",toAddress:event.ToAddress,ccAddress:IC_Validation.isNotNullOrUndefinedString(event.CcAddress)?event.CcAddress:"",bccAddres:IC_Validation.isNotNullOrUndefinedString(event.BccAddress)?event.BccAddress:"",subject:IC_Validation.isNotNullOrUndefinedString(event.Subject)?event.Subject:"",bodyHTML:IC_Validation.isNotNullOrUndefinedString(event.BodyHTML)?IC_Common.parseEmailHtml(event.BodyHTML):"",body:IC_Validation.isNotNullOrUndefinedString(event.Body)?event.Body:"",sentDate:IC_Validation.isNotNullOrUndefinedString(event.SentDate)?new Date(event.SentDate).getTime():"",attachments:event.Attachments,pocAddress:event.POCAddress,customData:event.CustomData,isDraft:IC_Common.toBoolean(event.IsDraft),tags:[]},isNewEmail=this.contacts.isNewObject(emailObj,function(a,b){return a.id===b.id});this.contacts.addOrUpdate(emailObj,function(a,b){return a.id===b.id&&(b.tags=a.tags),a.id===b.id}),function(){if(!IC_Validation.isNullOrEmptyOrEmptySpace(event.Tags)){var oldTags=IC_Validation.isNotNullOrEmptyArray(emailObj.tags)?emailObj.tags:[];emailObj.tags=[];for(var tags=event.Tags.split("|"),i=0,length=tags.length;i<length;i++){var alreadyAddedTag=oldTags.filter(function(tag){return tag.tagId===tags[i]});0==alreadyAddedTag.length?emailObj.tags.push({tagId:tags[i],isActive:"",notes:"",tagName:"",isLoaded:!1}):emailObj.tags.push(alreadyAddedTag[0])}}}(),!0===isNewEmail&&(this.addIntervalJob("GetBusinessUnit",100,-1),this.addIntervalJob("GetQuickReply",100,-1)),localStorage.contacts=JSON.stringify(this.contacts),"Interrupted"!=emailObj.status&&(localStorage.lastAttentedContactId=emailObj.id),this.triggerEvent("contacts",this.ContactEvent,[event.Type])}catch(ex){logger.error("onEmailContactEvent: "+ex.message)}},onVoiceMailPlayBackEvent:function(event){var playBackObject={id:event.ContactId,position:IC_Common.toNumber(event.PlayBackPosition),isPaused:IC_Common.toBoolean(event.PlayBackPaused),startTime:this.getServerTimestamp()};this.vmPlayBack[playBackObject.id]=playBackObject,localStorage.vmPlayBack=JSON.stringify(this.vmPlayBack),this.triggerEvent("vmPlayBack",this.VoiceMailPlayBackEvent)},onVoiceMailContactEvent:function(event){try{var voiceObj={id:event.ContactId,mId:event.MasterID,status:event.Status,contactType:event.Type,skillId:event.Skill||event.SkillId,inbound:IC_Common.toBoolean(event.IsInbound),time:new Date(event.StartTime).getTime(),lastStateTime:new Date(event.LastStateChangeTime).getTime(),screenPopUrl:event.ScreenPopUrl,to:event.To,from:event.From,createdDate:new Date(event.CreatedDate).getTime(),fileDuration:parseInt(event.FileDuration),finalState:IC_Common.toBoolean(event.FinalState),fileName:event.FileName,mailType:event.VoiceMailType,label:event.Label,customData:event.CustomData,startDateTime:IC_Common.toSFDateString(new Date(event.StartTime)),lastStateDateTime:IC_Common.toSFDateString(new Date(event.LastStateChangeTime)),tags:[],isRefused:!1},contactsLength=this.contacts.length,callPlayBack=!1,i=0,newCall=!0;for(i=0;i<this.contacts.length;i++)if(this.contacts[i].id===voiceObj.id){var obj=this.contacts[i];obj.from===voiceObj.from&&obj.to===voiceObj.to&&("Incoming"===obj.status&&"Active"===voiceObj.status?callPlayBack=!0:"Incoming"!==obj.status||"Disconnected"!==voiceObj.status&&"Discarded"!==voiceObj.status||(voiceObj.isRefused=!0),voiceObj.tags=this.contacts[i].tags,this.contacts[i]=voiceObj),newCall=!1;break}!0===newCall&&this.contacts.addOrUpdate(voiceObj,function(a,b){return a.id===b.id}),localStorage.contacts=JSON.stringify(this.contacts),localStorage.lastAttentedContactId=voiceObj.id,this.triggerEvent("contacts",this.ContactEvent,[event.Type]),(callPlayBack=this.contacts.length===contactsLength+1&&"Active"===voiceObj.status||callPlayBack)&&this.playVoiceMail(!0,0,voiceObj.id)}catch(ex){logger.error("onVoiceMailContactEvent: "+ex.message)}},onContactEvent:function(event){try{var callObj={id:event.ContactID,status:event.Status,contactType:event.Type,type:event.CallType,dnis:event.DNIS,ani:event.ANI,skillId:event.Skill||event.SkillId,inbound:IC_Common.toBoolean(event.IsInbound),time:new Date(event.StartTimeUTC).getTime(),lastStateTime:new Date(event.LastStateChangeTimeUTC).getTime(),timeout:IC_Common.toNumber(event.Timeout),screenPopUrl:event.ScreenPopUrl,disconnectCode:event.DisconnectCode,logging:IC_Common.toBoolean(event.IsLogging),allowDisp:"WorkItemContactEvent"==event.Type?event.AllowDispositions:IC_Common.toBoolean(event.AllowDispositions),finalState:IC_Common.toBoolean(event.FinalState),refusalTimeout:IC_Common.toNumber(event.RefusalTimeout),linked:IC_Common.toBoolean(event.IsLinked),name:event.Label,workItemId:event.WorkItemId,workItemPayload:event.WorkItemPayload,workItemType:event.WorkItemType,otherInfo:event.OtherInformationNewFormat,deliveryType:event.DeliveryType,taskCreation:!0,startDateTime:IC_Common.toSFDateString(new Date(event.StartTimeUTC)),lastStateDateTime:IC_Common.toSFDateString(new Date(event.LastStateChangeTimeUTC)),customData:event.CustomData,tags:[],isRefused:!1,externalId:event.ExternalId},i=0,newCall=!0;if("NaturalCalling"!==event.CallType||this.pcDeliveryType.hasOwnProperty(event.DeliveryType)||!1!==IC_Common.toBoolean(event.IsLinked)){if("NaturalCalling"===callObj.type&&!0===callObj.linked||"NaturalCalling"===callObj.type&&this.pcDeliveryType.hasOwnProperty(callObj.deliveryType))if("Active"===callObj.status||"Disconnected"===callObj.status||this.pcDeliveryType.hasOwnProperty(callObj.deliveryType)){for(i=0;i<this.pcQueueContacts.length;i++)if(this.pcQueueContacts[i].id===callObj.id){this.pcQueueContacts[i]=callObj;break}}else for(i=0;i<this.pcQueueContacts.length;i++)if(this.pcQueueContacts[i].id===callObj.id){this.pcQueueContacts.splice(i,1);break}for(i=0;i<this.contacts.length;i++){if("NaturalCalling"===callObj.type&&!0===callObj.linked&&"NaturalCalling"===this.contacts[i].type&&this.contacts[i].id!==callObj.id){if(this.callPriority[callObj.status]<this.callPriority[this.contacts[i].status]||this.contacts[i].lastStateTime>callObj.lastStateTime&&this.callPriority[this.contacts[i].status]>1){"Disconnected"!==this.contacts[i].status&&(this.pcQueueContacts.addOrUpdate(this.contacts[i],function(a,b){return a.id===b.id}),logger.debug("ContactID: "+this.contacts[i].id," pcQueueContacts addOrUpdate status: "+this.contacts[i].status)),this.processOrphanContact(this.contacts[i],!1),this.contacts.splice(i,1);break}newCall=!1,this.pcQueueContacts.addOrUpdate(callObj,function(a,b){return a.id===b.id})}if(this.contacts[i].id===callObj.id){var obj=this.contacts[i];callObj.workItemPayload=obj.workItemPayload,("NaturalCalling"===callObj.type||obj.ani===callObj.ani&&obj.dnis===callObj.dnis&&obj.time===callObj.time||"CallBackDisconnected"===callObj.status||IC_Validation.isNullOrEmpty(obj.dnis))&&("Incoming"===obj.status&&"Disconnected"===callObj.status&&(callObj.isRefused=!0),callObj.tags=this.contacts[i].tags,this.contacts[i]=callObj),newCall=!1;break}}if(("CallContactEvent"==callObj.contactType&&"Regular"==callObj.type&&"Disconnected"==callObj.status||!0===newCall)&&this.addIntervalJob("GetBusinessUnit",100,-1),"WorkItemContactEvent"==callObj.contactType&&callObj.workItemType==IC_Util.SalesforceOmnichannelRouting&&IC_Validation.isJSON(callObj.workItemPayload))if("Incoming"===callObj.status){var workItemPayload=JSON.parse(callObj.workItemPayload);this.omniChannelRoutingInfo.contactId==callObj.id&&(AgentConsoleDataStore.omniChannelRoutingInfo={},localStorage.omniChannelRoutingInfo="{}"),OmnichannelClient.canOmniChannelAcceptAgentWork(workItemPayload.ServiceChannelId,$.proxy(this.onCanOmniChannelAcceptAgentWorkComplete,this,callObj.id))}else"Active"===callObj.status?OmnichannelClient.onWorkItemAcceptedorRejected(callObj,!1):callObj.isRefused&&"Disconnected"===callObj.status&&OmnichannelClient.onWorkItemAcceptedorRejected(callObj,!0);!0===newCall&&(this.contacts.addOrUpdate(callObj,function(a,b){return a.id===b.id}),logger.debug("ContactID: "+callObj.id," contacts the new contact")),localStorage.pcQueueContacts=JSON.stringify(this.pcQueueContacts),this.triggerEvent("pcQueueContacts",this.PCQueueEvent),localStorage.contacts=JSON.stringify(this.contacts),localStorage.lastAttentedContactId=callObj.id,this.triggerEvent("contacts",this.ContactEvent,[event.Type])}else{for(i=0;i<this.pcQueueContacts.length;i++)if(this.pcQueueContacts[i].id===callObj.id){"Disconnected"===event.Status?this.pcQueueContacts.splice(i,1):this.pcQueueContacts[i]=callObj,newCall=!1;break}for(i=0;i<this.contacts.length;i++)if(this.contacts[i].id===callObj.id){this.processOrphanContact(this.contacts[i],!1),this.contacts.splice(i,1);break}!0===newCall&&"Disconnected"!==event.Status&&(this.pcQueueContacts.addOrUpdate(callObj,function(a,b){return a.id===b.id}),logger.debug("ContactID: "+event.ContactID," pcQueueContacts addOrUpdate status: "+event.Status)),localStorage.pcQueueContacts=JSON.stringify(this.pcQueueContacts),this.triggerEvent("pcQueueContacts",this.PCQueueEvent)}}catch(ex){logger.error("onContactEvent: "+ex.message)}},onCanOmniChannelAcceptAgentWorkComplete:function(contactid,canAccept){logger.debug("onCanOmniChannelAcceptAgentWorkComplete >>> contactid: "+contactid+" , canAccept: "+canAccept);var contacts=AgentConsoleDataStore.getContacts(function(contact){return contact.id==contactid&&"Incoming"==contact.status});if(this.omniChannelRoutingInfo={contactId:contactid,canAccept:canAccept,autoRejected:!1},1==contacts.length)if(canAccept){var workItemPayload=JSON.parse(contacts[0].workItemPayload);OmnichannelClient.createAgentWork(workItemPayload.WorkItemId,workItemPayload.ServiceChannelId)}else this.rejectContact(contactid),this.omniChannelRoutingInfo.autoRejected=!0;localStorage.omniChannelRoutingInfo="{}",localStorage.omniChannelRoutingInfo=JSON.stringify(this.omniChannelRoutingInfo),this.triggerEvent("omniChannelRoutingInfo",this.OmniChannelReadyStateChangedEvent)},getTagsUpdateToContact:function(contact){"Consult"!==contact.type&&("PersonalQueue"!==contact.type||"PersonalQueue"===contact.type&&"0"!==contact.skillId)&&AgentConsoleDataStore.getTagsforSkill(contact.skillId,contact.id)},getTagsforSkill:function(skillId,contactId){if(-1==this.tagsLoadedContacts.indexOf(contactId)){this.tagsLoadedContacts.push(contactId);var url=this.OAuthInfo.baseUri+this.getTagsforSkillUri.replace("{skillId}",skillId),that=this;logger.trace("getTagsforSkill request fired skill id: "+skillId),this.skillTagsMap[skillId]={},this.getRequest(url,function(response,status,statusText){if(logger.debug("getTagsforSkill success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),localStorage.tagsLoadedContacts=JSON.stringify(that.tagsLoadedContacts),204==status)logger.debug("getTagsforSkill success:- No tags avaialable!");else try{void 0!==response.resultSet&&response.resultSet.tags.length>0&&(that.skillTagsMap[response.resultSet.skillId]=response.resultSet.tags),logger.debug("getTagsforSkill:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))}catch(ex){logger.error("getTagsforSkill success callback:"+ex.message)}localStorage.skillTagsMap=JSON.stringify(that.skillTagsMap),that.triggerEvent("skillTagsMap",that.SkillTagsUpdateEvent)},function(status,statusText,response){0!==status&&that.addCustomError("Custom_GetSkillTagsError","Medium"),logger.error("getTagsforSkill:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})}},removeSkillTags:function(skillId){for(var contacts=AgentConsoleDataStore.contacts,isContactwithSameSKillExists=!1,contact=null,i=0;i<contacts.length;i++)0!=(contact=contacts[i]).finalState&&"Parked"!==contact.status||contact.skillId!=skillId||(isContactwithSameSKillExists=!0);isContactwithSameSKillExists||IC_Validation.isNotNullOrEmpty(this.skillTagsMap[skillId])&&(delete this.skillTagsMap[skillId],localStorage.skillTagsMap=JSON.stringify(this.skillTagsMap))},updateTagsForContact:function(tag,contactId){var url=this.OAuthInfo.baseUri+this.postTagsForContactUri.replace("{contactId}",contactId),payloadJson=tag,that=this;logger.trace("Updating Tags for Contact payloadJson",payloadJson),logger.trace("ContactID: "+contactId),this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("updateTagsForContact success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_UpdateContactTags","Medium"),logger.error("updateTagsForContact:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},onAgentSessionEndEvent:function(event){try{for(var i=0;i<this.contacts.length;i++)this.processOrphanContact(this.contacts[i]);"true"==localStorage.isScreenAgentConnected&&this.disconnectScreenAgent(),this.flushStore(),null!=this.sock&&(this.isClientInitiateCloseConnection=!0,this.timeIntervalForWSConnection=0,this.clearConnectionInterval(),this.sock.close()),this.updateAgentLogoutState(),$(document).trigger(this.AgentSessionEndEvent)}catch(ex){logger.error("onAgentSessionEndEvent: "+ex.message)}},onRunAppEvent:function(event){try{"OpenURL"===event.ActionType&&this.checkAndPopUrl(event.ActionValue,"runapp")}catch(ex){logger.error("onRunAppEvent: "+ex.message)}},checkAndPopUrl:function(url,type){var contactId,anchor=IC_Common.createAnchor(url);IC_Common.isSFDomain(anchor.hostname)?(url=IC_Common.getSFRelativeUrl(anchor),logger.debug("onRunAppEvent - opening page :"+url),contactId=this.getActiveContactId(),url=IC_Common.appendQueryString(url,{_c:contactId})+anchor.hash,this.storeScreenPop(type,url)):(logger.debug("onRunAppEvent - opening page :"+url),AgentConsoleSalesforce.doScreenPopNewWindow(url))},scriptList:function(scriptName,callBack){var url=this.OAuthInfo.baseUri+this.getScriptListUri;url+=IC_Common.formQueryString({scriptName:scriptName}),this.getRequest(url,function(response,status,statusText){try{response.hasOwnProperty("scripts")&&IC_Validation.isNotNullOrEmptyArray(response.scripts)&&"function"==typeof callBack&&callBack(response.scripts[0].scriptId)}catch(ex){logger.error("onScriptListEvent success callback:"+ex.message)}})},spawnScript:function(scriptId,skillId,parameters,startDate){var url=this.OAuthInfo.baseUri+this.spawnScriptUri.replace("{scriptId}",scriptId),payload={skillid:skillId,parameters:parameters,startdate:startDate},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payload),function(response,status,statusText){logger.debug("spawnScript success:- status:"+status+"statusText:"+statusText+"response:"+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_SpawnScriptError","Medium"),logger.error("spawnScript:- status:"+status+"statusText:"+statusText+"response:"+JSON.stringify(response))})},signalScript:function(contactId,processedArgs){var url=this.OAuthInfo.baseUri+this.signalScriptUri.replace("{contactId}",contactId),payloadJson={p1:processedArgs[1],p2:processedArgs[2],p3:processedArgs[3],p4:processedArgs[4],p5:processedArgs[5]},that=this;this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("signalScript success:- status:"+status+"statusText:"+statusText+"response:"+JSON.stringify(response))},function(status,statusText,response){that.addCustomError("Custom_SignalScriptError","Medium"),logger.error("signalScript:- status:"+status+"statusText:"+statusText+"response:"+JSON.stringify(response))})},onPageOpenEvent:function(event){try{var openEventWinName=event.ContactID,openedWindows={};if("OPEN"===event.Action||"PREVIEW"===event.Action)logger.debug("onPageOpenEvent - opening page :"+event.PageUri),openedWindows[openEventWinName]=AgentConsoleSalesforce.doScreenPopNewWindow(event.PageUri);else if("CLOSE"===event.Action&&(logger.debug("onPageCloseEvent - opening page :"+event.PageUri),openedWindows.hasOwnProperty(openEventWinName))){var openedWindow=openedWindows[openEventWinName];openedWindow&&!openedWindow.closed&&openedWindow.close(),delete openedWindows[openEventWinName]}}catch(ex){logger.error("onPageOpenEvent: "+ex.message)}},onUpdateMessagesEvent:function(job){var url=this.OAuthInfo.baseUri+this.getAgentMessages.replace("{agentId}",this.agentInfo.id),that=this;this.getRequest(url,function(response,status,statusText){try{if(response.hasOwnProperty("messages")&&IC_Validation.isNotNullOrEmptyArray(response.messages)){var i,message,msg,len=response.messages.length;for(i=0;i<len;i++)message=response.messages[i],that.agentMessage.expiredMsg.hasOwnProperty(message.MessageId)||(msg={id:message.MessageId,msg:message.MessageText,msgHint:message.MessageHint,sub:message.Subject,expTimer:6e4*IC_Common.toNumber(message.ExpireTimer),indicatorId:message.IndicatorId,validTime:new Date(message.ValidUntil).getTime(),receivedTime:new Date(message.start_date).format(that.localeDateTimeFormat),readMsg:!1,scrollMsg:!1,isEvolve:!1,evolveNotificationurl:"",receivedTimestamp:that.getServerTimestamp()},that.agentMessage.expiredMsg[msg.id]=!1,that.agentMessage.message.push(msg),that.agentMessage.message.sort(function(a,b){return new Date(b.receivedTime).getTime()-new Date(a.receivedTime).getTime()}),that.agentMessage.scrollMsgCount++,that.triggerEvent("agentMessage",that.AgentMessageNotifyEvent))}localStorage.agentMessage=JSON.stringify(that.agentMessage),that.triggerEvent("agentMessage",that.AgentMessageEvent)}catch(ex){logger.error("onUpdateMessagesEvent success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addIntervalJob(job.type,job.interval,job.hitCount,"",job.data),logger.warn("onUpdateMessagesEvent:- status:"+status+" statusText:"+statusText,response)})},clearExpiredMessage:function(){if(!IC_Validation.isNullOrEmpty(this.agentMessage)){var i,message,len=this.agentMessage.message.length,currentServerTime=this.getServerTimestamp(),agentMessage=Object.clone(this.agentMessage),msgRemoved=!1;for(i=0;i<len;i++)currentServerTime-(message=agentMessage.message[i]).receivedTimestamp>message.expTimer&&(logger.debug("clearExpiredMessage :"+message.id),this.agentMessage.message.remove(function(i,a){return message.id===a.id}),this.agentMessage.expiredMsg[message.id]=!0,this.agentMessage.scrollMsgCount--,msgRemoved=!0);msgRemoved&&(localStorage.agentMessage=JSON.stringify(this.agentMessage),this.triggerEvent("agentMessage",this.AgentMessageEvent))}},updateAgentMsgReadStatus:function(msgId){var i,len=this.agentMessage.message.length;for(logger.trace("updateAgentMsgReadStatus: "+msgId),i=0;i<len;i++)if(this.agentMessage.message[i].id===msgId){this.agentMessage.message[i].readMsg=!0,localStorage.agentMessage=JSON.stringify(this.agentMessage);break}},updateAgentMsgScrollStatus:function(msgId){var i,len=this.agentMessage.message.length;for(logger.trace("updateAgentMsgScrollStatus: "+msgId),i=0;i<len;i++)if(this.agentMessage.message[i].id===msgId){this.agentMessage.message[i].scrollMsg=!0,localStorage.agentMessage=JSON.stringify(this.agentMessage);break}},onUpdateIndicatorsEvent:function(job){var url=this.OAuthInfo.baseUri+this.getAgentIndicator.replace("{agentId}",this.agentInfo.id),that=this;logger.trace("onUpdateIndicatorsEvent: "+this.agentInfo.id),this.getRequest(url,function(response,status,statusText){try{if(IC_Validation.isNullOrEmpty(that.indicators)?that.indicators={agentIndicator:[],contactIndicator:[]}:that.indicators.agentIndicator=[],response.hasOwnProperty("indicators")&&IC_Validation.isNotNullOrEmptyArray(response.indicators)){var i,indicator,obj,len=response.indicators.length;for(i=0;i<len;i++)obj={name:(indicator=response.indicators[i]).IndicatorName,cId:indicator.SenderContactId,img:indicator.ImageFile,type:indicator.ActionType,action:indicator.Action,toolTip:indicator.ToolTip,enable:IC_Common.toBoolean(indicator.Enable)},that.indicators.agentIndicator.push(obj)}localStorage.indicators=JSON.stringify(that.indicators),that.triggerEvent("indicators",that.AgentIndicatorEvent),logger.debug("onUpdateIndicatorsEvent:- status:"+status+" statusText:"+statusText+" response:"+JSON.stringify(response))}catch(ex){logger.error("onUpdateIndicatorsEvent success callback:"+ex.message)}finally{that.removeJob(job)}},function(status,statusText,response){that.removeJob(job),that.addIntervalJob(job.type,job.interval,job.hitCount,"",job.data),logger.error("onUpdateIndicatorsEvent:- status:"+status+" statusText:"+statusText+" response:"+JSON.stringify(response))})},onIndicatorEvent:function(event){var obj={name:event.Name,contactID:event.ContactID,id:IC_Validation.isNullOrEmpty(event.ContactID)?event.Name:event.ContactID+"_"+event.Name,img:event.ImageUri,type:event.ActionType,action:event.ActionUri,toolTip:event.ToolTip,enable:"On"===event.IndicatorState};IC_Validation.isNullOrEmpty(this.indicators)&&(this.indicators={agentIndicator:[],contactIndicator:[]}),this.indicators.contactIndicator.addOrUpdate(obj,function(a,b){return a.id===b.id}),localStorage.indicators=JSON.stringify(this.indicators),this.triggerEvent("indicators",this.AgentIndicatorEvent)},onChatPatronTypingEvent:function(event){try{var chatPatronTyping={isTyping:event.IsTyping,isTextEntered:event.IsTextEntered,partyType:event.PartyType,label:event.Label,roomId:event.RoomId};this.chatPatronTyping.addOrUpdate(chatPatronTyping,function(a,b){return a.roomId===b.roomId}),localStorage.chatPatronTyping=JSON.stringify(this.chatPatronTyping),this.triggerEvent("chatPatronTyping",this.ChatPatronTypingEvent)}catch(ex){logger.error("onChatPatronTypingEvent: "+ex.message)}},onChatPreviewEvent:function(event){try{var chatPreview={type:event.Type,previewText:event.PreviewText,roomId:event.RoomId,time:event.TimeStamp};this.chatPreview.addOrUpdate(chatPreview,function(a,b){return a.roomId===b.roomId}),localStorage.chatPreview=JSON.stringify(this.chatPreview),this.triggerEvent("chatPreview",this.ChatPreviewEvent)}catch(ex){logger.error("onChatPreviewEvent: "+ex.message)}},clearChatPatronId:function(id){for(var i=0;i<this.chatPatronTyping.length;i++)if(this.chatPatronTyping[i].roomId===id){this.chatPatronTyping.splice(i,1);break}for(i=0;i<this.chatPreview.length;i++)if(this.chatPreview[i].roomId===id){this.chatPreview.splice(i,1);break}localStorage.chatPatronTyping=JSON.stringify(this.chatPatronTyping),localStorage.chatPreview=JSON.stringify(this.chatPreview)},onChatAgentTyping:function(typing,contactID,onSuccessCallback){var url=this.OAuthInfo.baseUri+this.postAgentTypingIndicator.replace("{sessionId}",this.getIcSessionId()).replace("{contactId}",contactID),payloadJson={isTyping:typing.isTyping,isTextEntered:typing.isTextEntered};this.postRequest(url,this.JSONEncoded,JSON.stringify(payloadJson),function(response,status,statusText){logger.debug("onChatAgentTyping success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),"function"==typeof onSuccessCallback&&onSuccessCallback()},function(status,statusText,response){"function"==typeof onSuccessCallback&&409===status?onSuccessCallback():logger.error("onChatAgentTyping failure:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},onUpdateUnavailableCodesEvent:function(event){this.addIntervalJob("GetAllUnavailableCodes",100,-1),this.addIntervalJob("GetTeamUnavailableCodes",100,-1)},onUpdateSkillsEvent:function(event){this.loadSkillsJob()},loadSkillsJob:function(){!1===this.isJobExists("GetAllSkills")&&this.addIntervalJob("GetAllSkills",100,-1);!1===this.isJobExists("GetAgentSkills")&&this.addIntervalJob("GetAgentSkills",100,-1)},isJobExists:function(jobType){var jobExists=!1;return this.jobList.forEach(function(index,job){if(job.type===jobType)return logger.trace("Job already exists Type :"+jobType),jobExists=!0,!1}),jobExists},onUpdateDialerCampaignsEvent:function(event){this.loadSkillsJob()},clearContactIndicator:function(contactId){IC_Validation.isNullOrEmpty(this.indicators)||IC_Validation.isNullOrEmpty(this.indicators.contactIndicator)||(this.indicators.contactIndicator=$.grep(this.indicators.contactIndicator,function(contactIndicator){if(contactIndicator.contactID!=contactId)return-1}),localStorage.indicators=JSON.stringify(this.indicators),this.triggerEvent("indicators",this.AgentIndicatorEvent))},triggerEvent:function(eventKey,event,eventType){logger.trace("triggerEvent:- eventKey:"+eventKey+" event:"+event),IC_Common.isIE11()?(this.updateEventKeys(eventKey,!0),localStorage[eventKey]&&localStorage[eventKey].length>2e3&&setTimeout(function(){localStorage.nextEventUpdated=eventKey,$(document).trigger(event,eventType)},500)):$(document).trigger(event,eventType)},updateEventKeys:function(eventKey,isUpdate){var count=1==this.eventKeys.hasOwnProperty(eventKey)?this.eventKeys[eventKey]:0;return(count=1==isUpdate?count+1:count-1)<=0?delete this.eventKeys[eventKey]:this.eventKeys[eventKey]=count,count},updateContactDispositionState:function(contactId){for(var contact,i=0;i<this.contacts.length;i++)if((contact=this.contacts[i]).id===contactId&&"ChatContactEvent"!==contact.contactType){this.lastDispContactId=contactId,localStorage.lastDispContactId=this.lastDispContactId,$(document).trigger(this.ContactEvent);break}},removeContactFromStore:function(contactId){var i=0,removedContact=null,contacts=IC_Common.parseJSON(localStorage.contacts);for(logger.debug("removeContactFromStore :"+contacts.length),i=0;i<this.contacts.length;i++)if(this.contacts[i].id===contactId){logger.debug("ContactID: "+contactId," removeContactFromStore : deleting contact from memory."),this.contacts[i]=null,this.contacts.splice(i,1);break}for(i=0;i<contacts.length;i++)if(contacts[i].id===contactId){removedContact=contacts[i],contacts[i]=null,contacts.splice(i,1);break}if(IC_Validation.isValidObject(removedContact)&&(this.contacts=contacts,removedContact.id===this.lastDispContactId&&(this.lastDispContactId="",localStorage.lastDispContactId=this.lastDispContactId),localStorage.contacts=JSON.stringify(this.contacts),logger.debug("removeContactFromStore after:"+localStorage.contacts)),IC_Validation.isValidObject(removedContact)&&"ChatContactEvent"===removedContact.contactType&&this.chatMsg.hasOwnProperty(removedContact.id))delete this.chatMsg[removedContact.id],this.chatMsgUpdatedContactId=removedContact.id,localStorage.chatMsgUpdatedContactId=this.chatMsgUpdatedContactId,localStorage.chatMsg=JSON.stringify(this.chatMsg);else if(IC_Validation.isValidObject(removedContact)&&"EmailContactEvent"===removedContact.contactType){for(var emailDatas=this.persistEmailInfo,removedContactIdx=-1,emailIdx=0,length=emailDatas.length;emailIdx<length;emailIdx++)if(emailDatas[emailIdx].id==removedContact.id){removedContactIdx=emailIdx;break}-1!=removedContactIdx&&this.persistEmailInfo.splice(removedContactIdx,1),localStorage.persistEmailInfo=JSON.stringify(this.persistEmailInfo)}else IC_Validation.isValidObject(removedContact)&&"VoiceMailContactEvent"===removedContact.contactType&&(delete this.vmPlayBack[removedContact.id],localStorage.vmPlayBack=JSON.stringify(this.vmPlayBack));var contactIndex=this.tagsLoadedContacts.indexOf(contactId);return-1!=contactIndex&&(this.tagsLoadedContacts.splice(contactIndex,1),localStorage.tagsLoadedContacts=JSON.stringify(this.tagsLoadedContacts)),removedContact},containsErrorCodeById:function(errorId,errorCode){var i=0;for(logger.trace("containsErrorCodeById:- errorId:"+errorId+"errorCode:"+errorCode),i=0;i<this.errorList.length;i++)if(this.errorList[i].id===errorId)return this.errorList[i].messages.contains(function(i,m){return m.code===errorCode});return!1},removeErrorFromStore:function(errorId){var i=0;for(logger.trace("removeErrorFromStore:- errorId:"+errorId),i=0;i<this.errorList.length;i++)if(this.errorList[i].id===errorId){this.errorList[i]=null,this.errorList.splice(i,1);break}localStorage.errorList=JSON.stringify(this.errorList),this.triggerEvent("errorList",this.APIErrorEvent)},removeGetNextEventErrors:function(){var i=0;try{for(i=this.errorList.length-1;i>=0;i--)this.errorList[i].messages.contains(function(i,m){return"Custom_GetNextErrorAttempt"===m.code||"Custom_GetNextErrorAttemptWarn"===m.code})&&(this.errorList[i]=null,this.errorList.splice(i,1));localStorage.errorList=JSON.stringify(this.errorList),this.triggerEvent("errorList",this.APIErrorEvent)}catch(e){logger.error("removeGetNextEventErrors",e)}},flushStore:function(){logger.trace("flushStore triggered"),this.userInfo={},this.OAuthInfo={},this.allSkillList={},this.unavailableList=[],this.agentSkillList=[],this.contacts=[],this.sfResult=[],this.addressBookList=[],this.agentListMap={},this.agentSkillMap={},this.teamList={},this.permissionsList=[],this.fileExtList=[],this.promiseKeeperList=[],this.timeZoneList=[],this.isLoaded=!1,this.jobsProcessing={},this.pcQueueContacts=[],this.isSkillRunningLow=!0,this.lastAgentCachePollTime=null,this.chatMsg={},this.chatMsgUpdatedContactId="",this.priority=[],this.category=[],this.agentMessage={expiredMsg:{},message:[],scrollMsgCount:0},this.indicators={agentIndicator:[],contactIndicator:[]},this.cHistory={},this.cHistoryArr=[],this.skillQueueMap={},this.lastDispContactId="",this.quickReply=[],this.vmPlayBack={},this.isMailSending=!1,this.brandingProfile={},this.commitmentReminder={},this.persistEmailInfo=[],this.flushWebStorage(),this.chatPatronTyping=[],this.sfMode="",this.lastNewSkillQueueUpdateTime=0,this.pcPreviewNotes={},this.skillTagsMap={},this.tagsLoadedContacts=[],this.tagsUpdatedContact={},this.featuresList=[],this.wfoUrl="",this.getNextEventFailureCount=0,this.maxConference=3,this.isIntegratedSoftphone=null,this.agentSettings={},this.agentLegAcceptRejectActions="",this.clientLocale="",this.clientTimezoneName=""},flushWebStorage:function(){logger.trace("flushWebStorage triggered"),this.amIPolling=!1,this.jobList.clear(),localStorage.OAuthInfo="{}",localStorage.icSessionId="",localStorage.lastIcSessionIdUpdate="0",localStorage.allUnavailableList="{}",localStorage.allUnavailableListUpdateTime=(new Date).getTime(),localStorage.allSkillList="{}",localStorage.allSkillListUpdateTime=(new Date).getTime(),localStorage.teamUnavailableList="[]",localStorage.teamUnavailableListUpdateTime=(new Date).getTime(),localStorage.agentSkillList="[]",localStorage.agentSkillListUpdateTime=(new Date).getTime(),localStorage.agentListMap="{}",localStorage.agentSkillMap="{}",localStorage.agentSkillMapUpdateTime=(new Date).getTime(),localStorage.teamList="[]",localStorage.teamListUpdateTime=(new Date).getTime(),localStorage.contacts="[]",localStorage.errorList="[]",localStorage.sfResult="[]",localStorage.customVariables="{}",localStorage.skillQueueMap="{}",localStorage.skillQueueMapUpdateTime=(new Date).getTime(),localStorage.addressBookList="[]",localStorage.serverTimestampOnStart="",localStorage.localTimestampOnStart="",localStorage.pcQueueContacts="[]",localStorage.isSkillRunningLow="true",localStorage.chatMsg="{}",localStorage.chatMsgUpdatedContactId="",localStorage.priority="[]",localStorage.category="[]",localStorage.agentMessage=JSON.stringify(this.agentMessage),localStorage.indicators="",localStorage.skillRealTimeEventCount="0",localStorage.isLoaded="false",localStorage.lastDispContactId="",localStorage.lastAttentedContactId="",localStorage.persistEmailInfo="[]",localStorage.quickReply="[]",localStorage.vmPlayBack="{}",localStorage.permissionsList="[]",localStorage.fileExtList="[]",localStorage.promiseKeeperList="[]",localStorage.isMailSending="false",localStorage.timeZoneList="[]",localStorage.parkedEmailList="[]",localStorage.parkEmailId="",localStorage.persistChatEditorSetting="{}",localStorage.commitmentReminder=null,localStorage.openedCommitmentReminderWindow="",localStorage.ProceedCommitmentReminderPending="0",localStorage.isRescheduleInProgress="false",localStorage.brandingProfile="{}",localStorage.previewParkedEmailId="",localStorage.clickedAddresbookEmail="",localStorage.sfMode="",localStorage.lastNewSkillQueueUpdateTime="0",localStorage.pcPreviewNotes="{}",localStorage.skillTagsMap="{}",localStorage.tagsLoadedContacts="[]",localStorage.tagsUpdatedContact="{}",localStorage.featuresList="[]",localStorage.wfoUrl="",localStorage.isScreenAgentConnected="false",localStorage.getNextEventFailureCount="0",localStorage.maxConference="3",localStorage.removeItem("nextEventUpdated"),localStorage.isIntegratedSoftphone=null,localStorage.agentSettings="{}",localStorage.agentId="",localStorage.isSessionStarted="false",localStorage.connectedAudioCodeServer=null,localStorage.agentLegCall=null,localStorage.agentLegAcceptRejectActions=""},getRequest:function(url,onSuccess,onError,ignoreTimeout){var errorHandler=onError;"function"!=typeof errorHandler&&(errorHandler=$.proxy(this.onDataStoreError,this)),this.xmlHttpRequest("GET",url,{Authorization:"bearer "+this.OAuthInfo.accessToken},null,onSuccess,errorHandler,null,ignoreTimeout)},postRequest:function(url,contentType,data,onSuccess,onError,ignoreTimeout,processData){var errorHandler=onError;"function"!=typeof errorHandler&&(errorHandler=$.proxy(this.onDataStoreError,this)),this.xmlHttpRequest("POST",url,{"Content-Type":contentType,Authorization:"bearer "+this.OAuthInfo.accessToken},data,onSuccess,errorHandler,null,ignoreTimeout,null,processData)},postRequestEvolve:function(url,contentType,data,onSuccess,onError,withCred){var errorHandler=onError;"function"!=typeof errorHandler&&(errorHandler=$.proxy(this.onDataStoreError,this)),this.xmlHttpRequest("POST",url,{"Content-Type":contentType},data,onSuccess,errorHandler,null,null,withCred)},getRequestEvolve:function(url,onSuccess,onError,ignoreTimeout){var errorHandler=onError;"function"!=typeof errorHandler&&(errorHandler=$.proxy(this.onDataStoreError,this)),this.xmlHttpRequest("GET",url,{Authorization:"bearer "+this.OAuthInfo.accessToken},null,onSuccess,errorHandler,null,ignoreTimeout)},putRequest:function(url,contentType,data,onSuccess,onError){var errorHandler=onError;"function"!=typeof errorHandler&&(errorHandler=$.proxy(this.onDataStoreError,this)),this.xmlHttpRequest("PUT",url,{"Content-Type":contentType,Authorization:"bearer "+this.OAuthInfo.accessToken},data,onSuccess,errorHandler)},deleteRequest:function(url,contentType,data,onSuccess,onError){var errorHandler=onError;"function"!=typeof errorHandler&&(errorHandler=$.proxy(this.onDataStoreError,this)),this.xmlHttpRequest("DELETE",url,{"Content-Type":contentType,Authorization:"bearer "+this.OAuthInfo.accessToken},data,onSuccess,errorHandler)},onDataStoreError:function(xhr){IC_Validation.isNotNullOrEmpty(this.onErrorCallback)},xmlHttpRequest:function(httpMethod,url,jsonHeaderData,formData,onSuccess,onError,async,ignoreTimeout,withCred,processData){logger.trace(httpMethod+" "+url),IC_Validation.isNotNullOrUndefinedString(ignoreTimeout)||(ignoreTimeout=!1),IC_Validation.isNotNullOrUndefinedString(withCred)||(withCred=!1),IC_Validation.isNullOrEmpty(processData)&&(processData=!0),$.ajax({dataType:"json",type:httpMethod,data:formData,headers:jsonHeaderData,crossDomain:!0,processData:processData,xhrFields:{withCredentials:withCred},jsonp:!1,timeout:ignoreTimeout?null:17e3,async:"boolean"!=typeof async||async,url:url,cache:!1,success:function(data,textStatus,jqXHR){"function"==typeof onSuccess&&onSuccess(data,jqXHR.status,jqXHR.statusText)},error:function(jqXHR,textStatus,errorThrown){"function"==typeof onError&&onError(jqXHR.status,jqXHR.statusText,jqXHR.responseText)}})},popoutChat:function(){var that=this,width=600,height=IC_Common.isSafari()?600:532;localStorage.isPopupClickflag="1"===localStorage.isPopupClickflag?"2":"1",logger.trace("popoutChat fired localStorage.isPopupClickflag: "+localStorage.isPopupClickflag),!0===IC_Common.toBoolean(localStorage.isPopClose)&&(width=IC_Validation.isNotNullOrUndefinedString(localStorage.popupWidth)?localStorage.popupWidth:width,height=IC_Validation.isNotNullOrUndefinedString(localStorage.popupHeight)?localStorage.popupHeight:height),setTimeout(function(){window.open(location.protocol+"//"+location.host+"/apex/inContactAgentConsolePopout?mode="+that.sfMode,"inContactAgentConsolePopout","width="+width+",height="+height+",scrollbars=no,toolbar=no,screenx=0,screeny=0,location=0,titlebar=0,directories=0,status=0,menubar=0,addressbar=0,resizable=1")},500)},showCommitmentReminder:function(event){event.receivedTime=(new Date).getTime();var openedWindowId=event.CallbackId;if(localStorage.openedCommitmentReminderWindow!==openedWindowId&&!(new Date(event.CallbackExpireTime)<=new Date)){localStorage.isRescheduleInProgress="false",localStorage.openedCommitmentReminderWindow=openedWindowId;var commitmentReminderData={},newKey="";for(var item in event)newKey=item[0].toLowerCase()+item.substr(1),commitmentReminderData[newKey]=event[item];commitmentReminderData.target="Agent"===commitmentReminderData.targetType?"A":"S";var that=this;setTimeout(function(){localStorage.commitmentReminder=JSON.stringify({data:commitmentReminderData,action:"openReminder"});var commitmentReminderURl=location.protocol+"//"+location.host+"/apex/inContactCommitmentReminder?mode="+that.sfMode;that.commitmentReminderWnd=window.open(commitmentReminderURl,"CommitmentReminderWindowID","width=370,height=245,scrollbars=no,toolbar=no,screenx=0,screeny=0,location=0,titlebar=0,directories=0,status=0,menubar=0,addressbar=0,resizable=0"),that.commitmentReminderWnd.focus()},0)}},getSfResult:function(contactId){var sfResult,len,i=0;if(logger.trace("ContactID: "+contactId," getSfResult fired"),IC_Validation.isNotNullOrEmptyArray(this.sfResult))for(len=this.sfResult.length,i=0;i<len;i++)if((sfResult=this.sfResult[i]).cId===contactId)return sfResult;return null},contactSearch:function(job){var that=this,contactId=job.data.contact.id;if(logger.trace("ContactID: "+contactId," contactSearch "),IC_Validation.isValidObject(this.getSfResult(contactId)))return this.triggerEvent("sfResult",this.ContactResultEvent),void this.removeJob(job);AgentConsoleSalesforce.contactSearch(job.data.contact,function(sfResult){try{if(sfResult.isScreenPopped=job.data.isScreenPop,sfResult=that.addClickToDialData(job.data.contact,sfResult),!0===IC_Common.isIE11())0===$.grep(sfResult.whoLst,function(item,index){return item.name==IC_Localization.none}).length&&sfResult.whoLst.splice(0,0,{id:"",name:IC_Localization.none}),0===$.grep(sfResult.whatLst,function(item,index){return item.name==IC_Localization.none}).length&&sfResult.whatLst.splice(0,0,{id:"",name:IC_Localization.none});that.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(that.sfResult),that.triggerEvent("sfResult",that.ContactResultEvent),that.storeClickToDialData(job.data.contact,sfResult),!0===job.data.isScreenPop&&(!1!==sfResult.urlPop||IC_Validation.isNullOrEmpty(sfResult.screenPopUrl)||AgentConsoleSalesforce.doScreenPopNewWindow(sfResult.screenPopUrl),IC_Validation.isNotNullOrEmpty(sfResult.sfScreenPopUrl)&&that.storeScreenPop("contactSearch",sfResult.sfScreenPopUrl))}catch(e){logger.error("Error @ AgentConsoleDataStore:contactSearch",e)}finally{that.removeJob(job)}})},addClickToDialData:function(contact,sfResult){var data=this.getCustomVar("ClickToDialDetail");if(IC_Validation.isValidObject(data)&&data.hasOwnProperty("number")&&!1===contact.inbound&&contact.dnis===data.number)try{var name,object=data.info.objectType.toLowerCase();name="task"===object?"Subject":"case"===object?"CaseNumber":"idea"===object?"Title":"contract"===object?"ContractNumber":"Name",sfResult.results.result.hasOwnProperty(data.info.id)||(sfResult.results.result[data.info.id]={}),sfResult.results.result[data.info.id].object=object,sfResult.results.result[data.info.id].RecordType=object,sfResult.results.result[data.info.id][name]=data.info.name,sfResult.outboundData=data.info.id,!0===data.isDetail&&(sfResult.sfScreenPopUrl=""),logger.info("ClickToDial- isDetail :"+data.isDetail+", Screenpopurl :"+sfResult.sfScreenPopUrl)}catch(e){logger.error("Error @ AgentConsoleDataStore:addClickToDialData",e)}return sfResult},storeClickToDialData:function(contact,sfResult){var data=this.getCustomVar("ClickToDialDetail");IC_Validation.isValidObject(data)&&data.hasOwnProperty("number")&&(!1===contact.inbound&&contact.dnis===data.number&&(logger.info("storeClickToDialData : Updating Salesforce result with :"+data.info.name),this.storeSObjectInfo(data.info,sfResult)),this.setCustomVar("ClickToDialDetail",{}))},salesforceScreenPop:function(job){try{var id=job.contactId,sfResult=this.getSfResult(id);IC_Validation.isValidObject(sfResult)&&!1===sfResult.isScreenPopped&&(logger.trace("sfResult.urlPop: "+sfResult.urlPop+" sfResult.screenPopUrl: "+sfResult.screenPopUrl+" sfResult.sfScreenPopUrl: "+sfResult.sfScreenPopUrl),sfResult.isScreenPopped=!0,this.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(this.sfResult),!1!==sfResult.urlPop||IC_Validation.isNullOrEmpty(sfResult.screenPopUrl)||AgentConsoleSalesforce.doScreenPopNewWindow(sfResult.screenPopUrl),IC_Validation.isNotNullOrEmpty(sfResult.sfScreenPopUrl)&&this.storeScreenPop("contactSearch",sfResult.sfScreenPopUrl))}catch(e){logger.error("Error @ AgentConsoleDataStore:salesforceScreenPop",e)}finally{this.removeJob(job)}},updateSfResultScreenPop:function(job){try{var id=job.contactId,sfResult=this.getSfResult(id);IC_Validation.isValidObject(sfResult)&&!1===sfResult.canPopTask&&(sfResult.canPopTask=!0,this.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(this.sfResult))}catch(e){logger.error("Error @ AgentConsoleDataStore:updateSfResultScreenpop",e)}finally{this.removeJob(job)}},reloadSFResult:function(){logger.trace("reloadSFResult"),IC_Validation.isNotNullOrUndefinedString(localStorage.sfResult)&&(this.sfResult=IC_Common.parseJSON(localStorage.sfResult))},createTask:function(job,popTask){var contact=job.data.contact,notesResult=job.data.notesResult,i=0,index=-1,that=this,sfResult=IC_Common.parseJSON(localStorage.sfResult);if(logger.trace("ContactID: "+contact.id," createTask job"),(sfResult=this.getSfResult(contact.id)).task.notes=notesResult.notes,sfResult.task.disp=notesResult.disp,sfResult.task.secDisp=notesResult.secDisp,sfResult.task.who=notesResult.whoId,sfResult.task.what=notesResult.whatId,IC_Validation.isNullOrEmpty(popTask)){if(IC_Validation.isNotNullOrEmpty(notesResult.whoId)){for(;i<sfResult.whoLst.length;i++)if(sfResult.whoLst[i].id===notesResult.whoId){index=i;break}-1!==index&&sfResult.whoLst.push(sfResult.whoLst[index])}if(i=0,index=-1,IC_Validation.isNotNullOrEmpty(notesResult.whatId)){for(;i<sfResult.whatLst.length;i++)if(sfResult.whatLst[i].id===notesResult.whatId){index=i;break}-1!==index&&sfResult.whatLst.push(sfResult.whatLst[index])}}this.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(this.sfResult),this.getContactDetails(contact,notesResult.disp.value,notesResult.secDisp.value,notesResult.notes,notesResult.dispPayload,function(callInfo){AgentConsoleSalesforce.createTask(callInfo,notesResult.whoId,notesResult.whatId,sfResult.task.id,function(result){try{if(!1===result.isError){var index=result.taskId.search(/00t/i);sfResult=that.getSfResult(contact.id),-1!==index&&IC_Validation.isValidObject(sfResult)&&(sfResult.task.id=result.taskId,that.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(that.sfResult))}}catch(e){logger.error("ContactID: "+contact.id," createTask",e)}finally{that.removeJob(job)}})})},pcPreviewNotesUpdate:function(data){IC_Validation.isNotNullOrEmpty(data)||(data={}),localStorage.pcPreviewNotes=JSON.stringify(data)},postContactWork:function(job){var id=job.data.contact.id,sfResult=this.getSfResult(id);if(IC_Validation.isValidObject(sfResult)&&!0===sfResult.acw)return logger.info("Not Executing Apex postContactWork"),void this.removeJob(job);sfResult.acw=!0,this.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(this.sfResult),sfResult.create?this.createTask(job,sfResult.pop):this.removeJob(job)},popTask:function(job){var contact=job.data.contact,notesResult=job.data.notesResult,taskId=job.data.taskId,canPopTask=job.data.popTask,that=this,searchResult=job.data.searchResult;logger.trace("ContactID: "+contact.id," popTask"),this.removeContactResult(contact.id),this.getContactDetails(contact,notesResult.disp.value,notesResult.secDisp.value,notesResult.notes,notesResult.dispPayload,function(contactInfo){AgentConsoleSalesforce.callWrapTask(contactInfo,notesResult.whoId,notesResult.whatId,taskId,function(result){try{if(!1===result.isError&&(logger.trace("popTask popTaskd: "+result.popTask+" canPopTask "+canPopTask),!0===result.popTask&&!0===canPopTask)){var contactResult={id:contact.id,result:searchResult};that.storeScreenPop("task",result.taskId,contactResult)}}catch(e){logger.error("ContactID: "+contact.id," Error @ callWrap",e)}finally{that.removeJob(job)}})})},callWrap:function(job){var contact=job.data.contact,that=this;logger.trace("ContactID: "+contact.id," callWrap"),this.getContactDetails(contact,job.data.disp.value,job.data.secDisp.value,job.data.notes,job.data.dispPayload,function(contactInfo){AgentConsoleSalesforce.callWrapOther(contactInfo,job.data.objectType,job.data.objectIdList,function(result){that.removeJob(job)})})},addCallWrapJobs:function(data){var contact=data.contact,notesResult=data.notesResult,whatList=data.whatList,whoList=data.whoList,lstObject={},jobData={};IC_Validation.isNullOrEmptyOrEmptySpace(data.entityMappingType)&&(data.entityMappingType=0),logger.trace("ContactID: "+contact.id+", EntityMappingType:"+data.entityMappingType," addCallWrapJobs"),lstObject.callObject=this.getCustomVar("otherPageId"),this.setCustomVar("otherPageId",[]),!1===IC_Validation.isValidObject(lstObject.callObject)&&(lstObject.callObject=[]),lstObject.callObject=lstObject.callObject.concat(whatList,whoList);var lst=[],idsAdded=[];for(var key in lstObject.callObject)if(lstObject.callObject.hasOwnProperty(key)){var obj=lstObject.callObject[key];!IC_Validation.isNotNullOrEmpty(obj.id)||idsAdded.hasOwnProperty(obj.id)||(1!=data.entityMappingType||data.notesResult.whoId!=obj.id&&data.notesResult.whatId!=obj.id)&&0!=data.entityMappingType||(idsAdded[obj.id]=!0,lst.hasOwnProperty(obj.objectType)?lst[obj.objectType]=lst[obj.objectType]+","+obj.id:lst[obj.objectType]=obj.id)}for(var objectType in lst)lst.hasOwnProperty(objectType)&&(jobData.contact=contact,jobData.objectType=objectType,jobData.objectIdList=lst[objectType],jobData.disp=notesResult.disp,jobData.secDisp=notesResult.secDisp,jobData.notes=notesResult.notes,jobData.dispPayload=notesResult.dispPayload,this.addPollingWindowJob({id:IC_Common.generateUniqueId("job"),type:"CleanupContact",data:jobData,sync:!1}))},removeContactResult:function(contactId){logger.trace("ContactID: "+contactId," removeContactResult"),IC_Validation.isNullOrEmpty(contactId)?(this.sfResult=[],localStorage.sfResult=JSON.stringify(this.sfResult)):(this.sfResult.remove(function(i,a){return contactId===a.cId}),localStorage.sfResult=JSON.stringify(this.sfResult))},getContactDetails:function(contactInfo,disposition,secDisposition,comment,payload,callback){logger.info("ContactID: "+contactInfo.id," disposition: "+disposition+" secDisposition: "+secDisposition+" comment: "+comment);var skillObj=this.allSkillList[contactInfo.skillId],skillName="",callDirection=contactInfo.inbound?"Inbound":"Outbound",durationInSeconds=Math.floor((contactInfo.lastStateTime-contactInfo.time)/1e3),screenPopUrl=contactInfo.screenPopUrl,that=this,tags="";if(IC_Validation.isNotNullOrEmpty(skillObj)&&(skillName=skillObj.name,callDirection=skillObj.isOutbound?"Outbound":"Inbound"),isNaN(durationInSeconds)&&(durationInSeconds=0),IC_Validation.isNotNullOrEmptyArray(contactInfo.tags)){tags="-------------------------\n"+IC_Localization.tags+"\n-------------------------\n";for(var j=0,length=contactInfo.tags.length;j<length;j++)tags+=contactInfo.tags[j].tagName+"\n"}if("ChatContactEvent"===contactInfo.contactType)this.getChatConversation(contactInfo.id,function(messages){var i,clientType,len=messages.length-1,chatTrans=" ";for(i=0;i<len;i++){var message=messages[i];"Client"===(clientType=message.type)&&(clientType="Contact"),chatTrans+=clientType+": "+(/<[a-z][\s\S]*>/i.test(message.msg)?$($.parseHTML(message.msg)).text():message.msg)+"\n"}loadCustomData({id:contactInfo.id,contactType:contactInfo.contactType,type:contactInfo.type,time:contactInfo.time,lastStateTime:contactInfo.lastStateTime,screenPopUrl:screenPopUrl,callDirection:"Inbound",durationInSeconds:durationInSeconds,dispositionValue:disposition,secondaryDispositionValue:secDisposition,comment:comment,skillName:skillName,agentName:that.agentInfo.fName+" "+that.agentInfo.lName,chatTranscript:chatTrans,tags:tags},contactInfo.customData)});else{var info={id:contactInfo.id,contactType:contactInfo.contactType,type:contactInfo.type,dnis:contactInfo.dnis,ani:contactInfo.ani,workItemId:contactInfo.workItemId,workItemPayload:contactInfo.workItemPayload,workItemType:contactInfo.workItemType,time:contactInfo.time,lastStateTime:contactInfo.lastStateTime,screenPopUrl:screenPopUrl,callDirection:callDirection,durationInSeconds:durationInSeconds,dispositionValue:disposition,secondaryDispositionValue:secDisposition,comment:comment,skillName:skillName,agentName:this.agentInfo.fName+" "+this.agentInfo.lName,value1:"",value2:"",cDate:"",cAmnt:"",callStartDateTime:contactInfo.startDateTime,callEndDateTime:contactInfo.lastStateDateTime,tags:tags};if("CallContactEvent"===contactInfo.contactType&&(!0===payload.isReschedule?info.cDate=IC_Common.toSFDateString(new Date(payload.data)):info.cAmnt=payload.data),"VoiceMailContactEvent"===contactInfo.contactType&&(info.fileName=contactInfo.fileName,info.fileDuration=contactInfo.fileDuration,info.to=contactInfo.to,info.from=contactInfo.from),IC_Validation.isNotNullOrUndefinedString(contactInfo.otherInfo))try{var otherInfo;otherInfo=IC_Common.getFormatOtherInfo(contactInfo.otherInfo),IC_Validation.isNotNullOrUndefinedString(otherInfo)&&(info.value1=otherInfo.valueOne[1],info.value2=otherInfo.valueTwo[1])}catch(ex){logger.error("ContactID: "+contactInfo.id," Other Information Field: "+ex.message)}"EmailContactEvent"==contactInfo.contactType&&contactInfo.isInbound?that.hasEmailTranscript(contactInfo.id,function(hasEmailTranscript){info.generateEmailTranscriptURL=hasEmailTranscript,loadCustomData(info,contactInfo.customData)}):loadCustomData(info,contactInfo.customData)}function loadCustomData(info,customData){var customVariables="",queryStringVariables="",keyValuePair="",splitIndex=-1;if(!IC_Validation.isNullOrEmptyOrEmptySpace(customData)){for(var i=0,length=(customVariables=customData.split("|")).length;i<length;i++)-1!=(splitIndex=(keyValuePair=customVariables[i]).indexOf("="))&&(queryStringVariables+=keyValuePair.substr(0,splitIndex)+"="+keyValuePair.substring(splitIndex+1)+"&");if((queryStringVariables=queryStringVariables.substr(0,queryStringVariables.length-1)).length>0){var lastCharacter="";info.screenPopUrl.length>0&&(lastCharacter=info.screenPopUrl[$.trim(info.screenPopUrl).length-1]),"?"==lastCharacter||"&"==lastCharacter?info.screenPopUrl+=queryStringVariables:-1==info.screenPopUrl.indexOf("?")?info.screenPopUrl+="?"+queryStringVariables:info.screenPopUrl+="&"+queryStringVariables}}callback(info)}},hasEmailTranscript:function(contactID,callback){var url=this.OAuthInfo.baseUri+this.getEmailTranscriptUri.replace("{contactId}",contactID);this.getRequest(url,function(response,status,statusText){logger.debug("hasEmailTranscript success:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response)),callback(204!=status)},function(status,statusText,response){callback(!1),logger.error("hasEmailTranscript:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})},contactResultUpdate:function(contactId,changedData,value){var i=0,index=-1,sfResult=this.getSfResult(contactId);if(logger.trace("ContactID: "+contactId," contactResultUpdate changedData: "+changedData+" value: ",value),IC_Validation.isValidObject(sfResult)){if(changedData===IC_Util.WhoId){for(;i<sfResult.whoLst.length;i++)if(sfResult.whoLst[i].id===value){index=i;break}-1!==index&&sfResult.whoLst.push(sfResult.whoLst[index]),sfResult.task.who=value}else if(changedData===IC_Util.WhatId){for(;i<sfResult.whatLst.length;i++)if(sfResult.whatLst[i].id===value){index=i;break}-1!==index&&sfResult.whatLst.push(sfResult.whatLst[index]),sfResult.task.what=value}else changedData===IC_Util.Disposition?sfResult.task.disp=value:changedData===IC_Util.Notes?sfResult.task.notes=value:changedData===IC_Util.DispositionPayload?sfResult.task.dispPayload=value:changedData===IC_Util.SecondaryDisposition&&(sfResult.task.secDisp=value);sfResult.task.changedData=changedData,this.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(this.sfResult)}},getActiveContactId:function(){var i,contact,len=this.contacts.length,chatContactCount=0;for(i=0;i<len;i++)if(chatContactCount++,"ChatContactEvent"===(contact=this.contacts[i]).contactType&&"Active"===contact.status)return logger.trace("ContactID: "+contact.id," getActiveContactId status: "+contact.status),contact.id;if(1===chatContactCount)return this.contacts[0].id;for(i=0;i<this.contacts.length;i++)if("Consult"!==(contact=this.contacts[i]).type&&"ChatContactEvent"!==contact.contactType&&"EmailContactEvent"!==contact.contactType)return contact.id;return""},processObjectInfo:function(pageInfo){var id=localStorage.lastAttentedContactId,sfResult=this.getSfResult(id);if(IC_Validation.isValidObject(sfResult)&&IC_Validation.isNotNullOrEmpty(pageInfo)){var info,result=AgentConsoleSalesforce.parsePageInfoResult(pageInfo);logger.debug("processObjectInfo id: "+result.objectId+" name: "+result.objectName+" objectType: "+result.object+", url:"+result.url),IC_Validation.isNotNullOrEmpty(result.object)&&(info={id:result.objectId,name:result.objectName,objectType:result.object,personAccount:!!IC_Validation.isNotNullOrUndefinedString(result.personAccount),contactId:IC_Validation.isNotNullOrUndefinedString(result.contactId)?result.contactId:""},this.storeSObjectInfo(info,sfResult))}},storeSObjectInfo:function(info,sfResult){if("Contact"===info.objectType||"Lead"===info.objectType)this.reloadSFResult(),(sfResult=this.getSfResult(sfResult.cId)).whoLst.push(info),sfResult.task.who=info.id,sfResult.task.changedData=IC_Util.WhoId,this.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(this.sfResult),this.triggerEvent("sfResult",this.ContactResultEvent);else if("Account"===info.objectType&&info.personAccount)this.reloadSFResult(),(sfResult=this.getSfResult(sfResult.cId)).whoLst.push(info),sfResult.task.who=info.contactId,sfResult.task.changedData=IC_Util.WhoId,this.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(this.sfResult),this.triggerEvent("sfResult",this.ContactResultEvent);else if(sfResult.related.hasOwnProperty(info.objectType))this.reloadSFResult(),(sfResult=this.getSfResult(sfResult.cId)).whatLst.push(info),sfResult.task.what=info.id,sfResult.task.changedData=IC_Util.WhatId,this.sfResult.addOrUpdate(sfResult,function(a,b){return a.cId===b.cId}),localStorage.sfResult=JSON.stringify(this.sfResult),this.triggerEvent("sfResult",this.ContactResultEvent);else{var otherPageId=this.getCustomVar("otherPageId");!1===IC_Validation.isValidObject(otherPageId)&&(otherPageId=[]),otherPageId.push(info),this.setCustomVar("otherPageId",otherPageId)}},upsertUserOptions:function(stationId,phoneNo,phoneNumberType,logLevel,isTooltipEnabled,agentAudioSettings,agentVisualSettings,callback){logger.trace("upsertUserOptions fired"),this.setGlobalLogLevel(logLevel),AgentConsoleSalesforce.upsertUserOptions(stationId,phoneNo,phoneNumberType,logLevel,isTooltipEnabled,agentAudioSettings,agentVisualSettings,function(isError,errorMsg){this.AgentConsoleDataStore.agentAudioSettings=agentAudioSettings,this.AgentConsoleDataStore.agentVisualSettings=agentVisualSettings,callback(isError,errorMsg)})},getIANATimeZoneOffset:function(ianaName,callback){logger.trace("getIANATimeZoneOffset fired"),IC_Validation.isNullOrEmpty(ianaName)&&callback(0,"ianaName cannot be empty"),AgentConsoleSalesforce.getIANATimeZoneOffset(ianaName,function(offset,error){callback(offset,error)})},isScc:function(callback){var that=this;logger.trace("isScc fired"),AgentConsoleSalesforce.isInConsole(function(isInConsole){that.isInConsoleView=isInConsole,AgentConsoleSalesforce.onFocusChange(function(pageInfo){that.processObjectInfo(pageInfo)}),callback()})},downloadLog:function(){logger.trace("downloadLog fired");var pattern=/^icLog_/,key="",i=0,logData="",keyArray=[];for(i=0;i<sessionStorage.length;i++)key=sessionStorage.key(i),!0===pattern.test(key)&&keyArray.push(parseInt(key.replace("icLog_","")));for(keyArray.sort(function(a,b){return a-b}),i=0;i<keyArray.length;i++)key="icLog_"+keyArray[i],logData+=sessionStorage.getItem(key);AgentConsoleSalesforce.downloadLog(logData)},refreshAccessToken:function(tokenUrl,refreshToken,onSuccess,onError){logger.trace("refreshAccessToken >>> tokenUrl:"+tokenUrl),AgentConsoleSalesforce.refreshToken(tokenUrl,this.getAuthMode(),refreshToken,function(result){if(IC_Validation.isNullOrEmpty(result.error)&&200===result.statusCode&&!IC_Validation.isNullOrEmpty(result.data)){var data=IC_Common.parseJSON(result.data);IC_Validation.isValidObject(data)?onSuccess(data):onError()}else onError()})},getAccessToken:function(tokenUrl,authCode,idpType,busNo,redirectUri,onSuccess,onError){logger.trace("getAccessToken >>> tokenUrl:"+tokenUrl+" authCode:"+authCode),AgentConsoleSalesforce.authenticate(tokenUrl,this.getAuthMode(),authCode,idpType,busNo,redirectUri,function(result){IC_Validation.isNullOrEmpty(result.error)?200===result.statusCode?onSuccess(IC_Common.parseJSON(result.data)):onError(result.statusCode,result.statusText,result.data):onError(0,result.error)})},getCurrentFocusedWindowId:function(){return AgentConsoleSalesforce.getCurrentFocusedWindowId()},popoutLoadDataStore:function(){if(this.isChatPopOut=!0,this.OAuthInfo=IC_Common.parseJSON(localStorage.OAuthInfo),this.amIPopoutWindow=!0,this.canClearPopValues=!0,AgentConsoleDataStore.lastNewSkillQueueUpdateTime!=localStorage.lastNewSkillQueueUpdateTime&&(AgentConsoleDataStore.lastNewSkillQueueUpdateTime=parseInt(localStorage.lastNewSkillQueueUpdateTime)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentInfo)&&(this.agentInfo=IC_Common.parseJSON(localStorage.agentInfo),$(document).trigger(this.AgentInfoEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.allUnavailableList)&&(this.allUnavailableList=IC_Common.parseJSON(localStorage.allUnavailableList),$(document).trigger(this.AllUnavailableCodeListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.allSkillList)&&(this.allSkillList=IC_Common.parseJSON(localStorage.allSkillList),$(document).trigger(this.SkillListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.teamUnavailableList)&&(this.teamUnavailableList=IC_Common.parseJSON(localStorage.teamUnavailableList),$(document).trigger(this.UnavailableListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentSkillList)&&(this.agentSkillList=IC_Common.parseJSON(localStorage.agentSkillList),$(document).trigger(this.AgentSkillListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentSkillMap)&&(this.agentSkillMap=IC_Common.parseJSON(localStorage.agentSkillMap),$(document).trigger(this.AgentSkillAssignmentsEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.teamList)&&(this.teamList=IC_Common.parseJSON(localStorage.teamList),$(document).trigger(this.TeamListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.permissionsList)&&(this.permissionsList=IC_Common.parseJSON(localStorage.permissionsList),$(document).trigger(this.PermissionsListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.timeZoneList)&&(this.timeZoneList=IC_Common.parseJSON(localStorage.timeZoneList),$(document).trigger(this.TimeZoneEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.promiseKeeperList)&&(this.promiseKeeperList=IC_Common.parseJSON(localStorage.promiseKeeperList),$(document).trigger(this.PromiseKeeperEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.fileExtList)&&(this.fileExtList=IC_Common.parseJSON(localStorage.fileExtList),$(document).trigger(this.FileExtensionsListEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.maxConference)&&(this.maxConference=parseInt(localStorage.maxConference,10),$(document).trigger(this.MaxConferenceHandleEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.quickReply)&&(this.quickReply=IC_Common.parseJSON(localStorage.quickReply)),this.tagsLoadedContacts=localStorage.tagsLoadedContacts?IC_Common.parseJSON(localStorage.tagsLoadedContacts):[],IC_Validation.isNotNullOrUndefinedString(localStorage.skillTagsMap)&&(this.skillTagsMap=IC_Common.parseJSON(localStorage.skillTagsMap)),IC_Validation.isNotNullOrUndefinedString(localStorage.omniChannelRoutingInfo)&&(this.omniChannelRoutingInfo=IC_Common.parseJSON(localStorage.omniChannelRoutingInfo)),IC_Validation.isNotNullOrUndefinedString(localStorage.persistEmailInfo)&&(this.persistEmailInfo=IC_Common.parseJSON(localStorage.persistEmailInfo)),IC_Validation.isNotNullOrUndefinedString(localStorage.contacts))if(this.contacts=IC_Common.parseJSON(localStorage.contacts),IC_Validation.isNotNullOrUndefinedString(localStorage.lastDispContactId)&&(this.lastDispContactId=localStorage.lastDispContactId),0===this.contacts.length)localStorage.removeItem("sfResult");else if(IC_Validation.isNotNullOrUndefinedString(localStorage.sfResult)&&(this.sfResult=IC_Common.parseJSON(localStorage.sfResult)),$(document).trigger(this.ContactEvent),IC_Validation.isValidObject(this.sfResult)){var that=this;this.isInConsoleView||this.amIPopoutWindow||AgentConsoleSalesforce.getPageInfo(function(pageInfo){that.processObjectInfo(pageInfo)})}IC_Validation.isNotNullOrUndefinedString(localStorage.parkedEmailList)&&(this.parkedEmailList=IC_Common.parseJSON(localStorage.parkedEmailList),$(document).trigger(this.ParkedEmailDetailsEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.chatMsg)&&(IC_Validation.isNotNullOrUndefinedString(localStorage.chatMsgUpdatedContactId)&&(this.chatMsgUpdatedContactId=localStorage.chatMsgUpdatedContactId),this.chatMsg=IC_Common.parseJSON(localStorage.chatMsg),$(document).trigger(this.ChatMsgEvent,!0)),IC_Validation.isNotNullOrUndefinedString(localStorage.pcQueueContacts)&&(this.pcQueueContacts=IC_Common.parseJSON(localStorage.pcQueueContacts),$(document).trigger(this.PCQueueEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.isSkillRunningLow)&&(this.isSkillRunningLow=IC_Common.toBoolean(localStorage.isSkillRunningLow),$(document).trigger(this.SkillRunningLowEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.icLogLevel)&&(IC_Util.LogLevel=localStorage.icLogLevel,$(document).trigger(IC_Util.LogLevelEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.cHistory)&&(this.cHistoryArr=IC_Common.parseJSON(localStorage.cHistory),this.fireContactHistorySortEvent()),IC_Validation.isNotNullOrUndefinedString(localStorage.isMailSending)&&(this.isMailSending=IC_Common.toBoolean(localStorage.isMailSending),$(document).trigger(this.MailProgressEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.chatPatronTyping)&&(this.chatPatronTyping=IC_Common.parseJSON(localStorage.chatPatronTyping),$(document).trigger(this.ChatPatronTypingEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.chatPreview)&&(this.chatPreview=IC_Common.parseJSON(localStorage.chatPreview),$(document).trigger(this.ChatPreviewEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.indicators)&&(this.indicators=IC_Common.parseJSON(localStorage.indicators),$(document).trigger(this.AgentIndicatorEvent)),IC_Validation.isNotNullOrUndefinedString(localStorage.agentLegAcceptRejectActions)&&(this.agentLegAcceptRejectActions=localStorage.agentLegAcceptRejectActions,$(document).trigger(this.agentLegAcceptRejectActionsEvent)),this.getCacheAgents()},onWindowFocusChanged:function(isIframe,isFocus){if(isIframe?this.focused.iframe=isFocus:this.focused.window=isFocus,this.focused.iframe||this.focused.window){var currentTab,currentTabKey="browserTab_"+this.browserTabIndex,focusedTime=(new Date).getTime();IC_Validation.isNotNullOrUndefinedString(localStorage[currentTabKey])&&(logger.info("onWindowFocusChanged - Storing "+currentTabKey+" focus time :"+focusedTime),(currentTab=IC_Common.parseJSON(localStorage[currentTabKey])).focusTime=focusedTime,sessionStorage.lastFocusTime=focusedTime,localStorage[currentTabKey]=JSON.stringify(currentTab),!0===IC_Common.isEdge()&&this.onStorageUpdate())}},storeScreenPop:function(type,url,contactResult){logger.trace("storeScreenPop type:"+type+" url:"+url+" contactResult:"+contactResult);var id=IC_Common.generateUniqueId("screenpop");this.screenPop={url:url,type:type,contactResult:contactResult,popId:id},localStorage.screenPop=JSON.stringify(this.screenPop),IC_Common.isIE11()?(IC_Common.setCookie("icScreenPop",id,1),logger.trace("storeScreenPop id-"+id+"url:"+url),this.updateEventKeys("screenPop",!0)):this.controlledScreenPop(type,url,contactResult,id)},getTabIndex:function(tabIndex){return tabIndex<=0?(tabIndex=1,localStorage.noOfBrowserTabs="1",logger.info("getTabIndex "+tabIndex),tabIndex):tabIndex},controlledScreenPop:function(type,url,contactResult,popId){var browserTabKey,browserTab,latestFocusedTabId,contactTabId,vfPageTabId,lastOpenTab,i=1,len=IC_Common.toNumber(localStorage.noOfBrowserTabs),lastFocusTime=0,lastContactPageOpenTime=0,lastVfPageOpenTime=0,lastOpenTime=0;for(logger.info("url:"+url+" type:"+type+" noOfBrowserTabs:"+len),len=this.getTabIndex(len),i=1;i<=len;i++)browserTabKey="browserTab_"+i,IC_Validation.isNotNullOrUndefinedString(localStorage[browserTabKey])&&(browserTab=IC_Common.parseJSON(localStorage[browserTabKey]),logger.info(browserTabKey+": "+localStorage[browserTabKey]),logger.trace("lastFocusTime browserTab lastFocusTime:"+lastFocusTime+" newFocusTime:"+browserTab.focusTime),lastFocusTime<browserTab.focusTime&&(lastFocusTime=browserTab.focusTime,latestFocusedTabId=browserTab.id),lastOpenTime<browserTab.pageOpenTime&&(lastOpenTime=browserTab.pageOpenTime,lastOpenTab=browserTab.id),!browserTab.isVisForce&&this.isObjectMatchFound(browserTab.isVisForce,contactResult,browserTab.pageId)&&lastContactPageOpenTime<browserTab.pageOpenTime&&(lastContactPageOpenTime=browserTab.pageOpenTime,contactTabId=browserTab.id),browserTab.isVisForce&&this.isObjectMatchFound(browserTab.isVisForce,contactResult,browserTab.pageId)&&lastVfPageOpenTime<browserTab.pageOpenTime&&(lastVfPageOpenTime=browserTab.pageOpenTime,vfPageTabId=browserTab.id));logger.info("contactTabId:"+contactTabId+" latestFocusedTabId:"+latestFocusedTabId+" vfPageTabId:"+vfPageTabId+" lastOpenTab:"+lastOpenTab+" currentTab:"+this.browserTabId+" lastFocusTime:"+lastFocusTime),"task"!=type?this.browserTabId==latestFocusedTabId?(logger.info("doScreenPop on latestFocusedTabId"),this.doScreenPop(url,popId,type)):IC_Validation.isNullOrEmpty(latestFocusedTabId)&&this.browserTabId===lastOpenTab&&(logger.info("doScreenPop on lastOpenedTabId"),this.doScreenPop(url,popId,type)):this.browserTabId==contactTabId?(logger.info("doScreenPop on contactTabId"),this.doScreenPop(url,popId,type)):IC_Validation.isNullOrEmpty(contactTabId)&&this.browserTabId===vfPageTabId?(logger.info("doScreenPop on vfPageTabId"),this.doScreenPop(url,popId,type)):IC_Validation.isNullOrEmpty(contactTabId)&&IC_Validation.isNullOrEmpty(vfPageTabId)&&this.browserTabId==latestFocusedTabId&&(logger.info("doScreenPop on focusedTabId"),this.doScreenPop(url,popId,type))},doScreenPop:function(url,popId,type){logger.info("doScreenPop popId:"+popId);var popError,that=this,popScreen={runapp:"Custom_ScreenPopErrorRunapp",task:"Custom_ScreenPopErrorTask",indicator:"Custom_ScreenPopErrorIndicator",contactSearch:"Custom_ScreenPopErrorContactSearch",contactResult:"Custom_ScreenPopErrorContactResult"},pop=!0;IC_Common.isIE11()&&(IC_Common.getCookie("icScreenPop")!=popId?(pop=!1,logger.trace("doScreenPop icScreenPop Id -",IC_Common.getCookie("icScreenPop"))):"task"==type&&IC_Common.getCookie("lastTaskPopUrl")==url&&(pop=!1,logger.trace("doScreenPop same url as lastTaskPopUrl -",IC_Common.getCookie("lastTaskPopUrl")))),pop&&(IC_Common.getCookie("icScreenPop")==popId&&IC_Common.setCookie("icScreenPop","",1),"task"==type&&IC_Common.setCookie("lastTaskPopUrl",url,1),this.screenPop={},localStorage.screenPop=JSON.stringify(this.screenPop),AgentConsoleSalesforce.doScreenPop(url,function(response){!1===response.result&&(popError=void 0!==type&&popScreen[type]?popScreen[type]:"Custom_ScreenPopError",that.addCustomError(popError,"Medium"))}))},isObjectMatchFound:function(isVisualForce,contactResult,objectId){if(IC_Validation.isValidObject(contactResult)&&contactResult.hasOwnProperty("id")){if(isVisualForce&&contactResult.id===objectId)return!0;if(!isVisualForce)for(var objId in contactResult.result)if(contactResult.result.hasOwnProperty(objId)&&(objId.length>15&&(objId=objId.substring(0,15)),objId==objectId))return!0}return!1},saveLastVoiceMailDuration:function(duration){localStorage.lastVoiceMailDuration=duration},getLastVoiceMailDuration:function(){var duration=0;return IC_Validation.isNumber(localStorage.lastVoiceMailDuration)&&(duration=IC_Common.toNumber(localStorage.lastVoiceMailDuration)),duration},removeLastVoiceMailDuration:function(){localStorage.removeItem("lastVoiceMailDuration")},isVoiceMailDurationSave:function(){return IC_Validation.isNullOrEmpty(localStorage.lastVoiceMailDuration)},getNonParkedContactsCount:function(){return this.getNonParkedContacts().length},getNonParkedContacts:function(){for(var contacts=AgentConsoleDataStore.contacts,nonParkedContacts=[],i=0,length=contacts.length;i<length;i++)"Parked"!=contacts[i].status&&nonParkedContacts.push(contacts[i]);return nonParkedContacts},getContacts:function(predicate){for(var contacts=AgentConsoleDataStore.contacts,matchedContacts=[],i=0,length=contacts.length;i<length;i++)!0===predicate(contacts[i])&&matchedContacts.push(contacts[i]);return matchedContacts},filterContacts:function(predicate,successCallback,failureCallback){var contacts=this.getContacts(predicate);contacts.length>0?successCallback(contacts):failureCallback()},getOmniChannelMappingDetails:function(callback){AgentConsoleSalesforce.getOmniChannelMappingDetails(callback)},setServicePresenceStatus:function(statusId,callback){AgentConsoleSalesforce.setServicePresenceStatus(statusId,callback)},getServicePresenceStatusId:function(callback){AgentConsoleSalesforce.getServicePresenceStatusId(callback)},getAvailableorBusy:function(statusId,callback){AgentConsoleSalesforce.getAvailableorBusy(statusId,callback)},getFirstandLastName:function(id,objectType,callback){AgentConsoleSalesforce.getFirstandLastName(id,objectType,callback)},isTagsAssigned:function(skillId){var skillTagMap=AgentConsoleDataStore.skillTagsMap;return!(!IC_Validation.isNotNullOrEmpty(skillTagMap)||!skillTagMap.hasOwnProperty(skillId))&&Object.keys(skillTagMap[skillId]).length>0},upsertUserCredentials:function(username,password,isAutoLogin,callback){AgentConsoleSalesforce.upsertUserCredentials(username,password,isAutoLogin,callback)},tags:{isAllTagsAddedtoContact:function(contactId){var that=AgentConsoleDataStore,contact=that.contacts.filter(function(contact){if(contact.id==contactId)return contact});if(0!=contact.length&&(contact=contact[0],Array.isArray(contact.tags))){var skillTagMap=that.skillTagsMap;if(IC_Validation.isNotNullOrEmpty(skillTagMap)&&skillTagMap.hasOwnProperty(contact.skillId))return contact.tags.length==Object.keys(skillTagMap[contact.skillId]).length}},updateContact:function(contact){logger.debug("ContactID: "+contact.id," AgentConsoleDataStore -> tags -> updateContact");var contacts=AgentConsoleDataStore.contacts;$.grep(contacts,function(item){item.id==contact.id&&(item.tags=contact.tags)}),localStorage.contacts=JSON.stringify(contacts),AgentConsoleDataStore.tagsUpdatedContact={contactId:contact.id,time:(new Date).getTime()},localStorage.tagsUpdatedContact=JSON.stringify(AgentConsoleDataStore.tagsUpdatedContact),AgentConsoleDataStore.triggerEvent("tagsUpdatedContact",AgentConsoleDataStore.TagsUpdatedContactEvent)}},getAgentSettings:function(callback){if(jQuery.isEmptyObject(this.agentSettings)){var url=this.OAuthInfo.baseUri+this.getAgentSettingsAPI.replace("{agentId}",localStorage.agentId),that=this;this.getRequest(url,function(response,status,statusText){logger.debug("getAgentSettings:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response));try{that.agentSettings=response,localStorage.agentSettings=JSON.stringify(response),callback(that.agentSettings)}catch(ex){logger.error("getAgentSettings success callback: "+ex.message)}},function(status,statusText,response){logger.error("getAgentSettings:- status:"+status+" statusText:"+statusText+" response: "+JSON.stringify(response))})}else callback(this.agentSettings)},isContactInitiationTab:function(){if(IC_Validation.isNumber(localStorage.callContactInitTabIndex)&&IC_Validation.isNumber(localStorage.noOfBrowserTabs)){var totalBrowserTabs=parseInt(localStorage.noOfBrowserTabs,10),callContactInitTabIndex=parseInt(localStorage.callContactInitTabIndex,10);if(callContactInitTabIndex<=totalBrowserTabs)return AgentConsoleDataStore.browserTabIndex==callContactInitTabIndex}return AgentConsoleDataStore.browserTabIndex==this.defaultContactInitTabIndex},setContactInitiationTab:function(){localStorage.callContactInitTabIndex=AgentConsoleDataStore.browserTabIndex||this.defaultContactInitTabIndex},removeContactInitiationTab:function(browserTabIndex){localStorage.removeItem("callContactInitTabIndex")},fireAgentLegAcceptRejectActions:function(action){"accept"==action&&this.setContactInitiationTab(),AgentConsoleDataStore.agentLegAcceptRejectActions=action,localStorage.agentLegAcceptRejectActions=AgentConsoleDataStore.agentLegAcceptRejectActions,this.triggerEvent("agentLegAcceptRejectActions",this.agentLegAcceptRejectActionsEvent)},clearAgentLegAcceptRejectActions:function(){AgentConsoleDataStore.agentLegAcceptRejectActions="",localStorage.agentLegAcceptRejectActions=""}},AgentConsoleDataStore._init()}(jQuery);